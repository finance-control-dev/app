<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Controle Financeiro Aprimorado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Firebase SDKs (v10 compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #10B981;
            --primary-light: #34D399;
            --primary-dark: #059669;
            --primary-glow: rgba(16, 185, 129, 0.3);
            --accent: #F59E0B;
            --success: #10B981;
            --success-light: #34D399;
            --danger: #DC2626;
            --danger-light: #EF4444;
            --warning: #D97706;
            --dark-bg: #070B14;
            --dark-bg-2: #0C1120;
            --dark-surface: #111827;
            --dark-card: #1A2236;
            --dark-border: rgba(255, 255, 255, 0.05);
            --dark-text: #F1F5F9;
            --dark-text-2: #94A3B8;
            --dark-text-3: #64748B;
            --light-bg: #F4F7FB;
            --light-surface: rgba(255, 255, 255, 0.8);
            --light-card: #F1F5F9;
            --light-border: rgba(255, 255, 255, 0.6);
            --light-text: #1E293B;
            --light-text-2: #334155;
            --light-text-3: #64748B;
            --radius: 20px;
            --radius-sm: 14px;
            --radius-xs: 12px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: background var(--transition), color var(--transition);
            overflow-x: hidden;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        body.dark {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        body.light {
            background: var(--light-bg);
            background-image: linear-gradient(135deg, #F4F7FB 0%, #E2E8F0 100%);
            background-attachment: fixed;
            color: var(--light-text);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.92)
            }

            to {
                opacity: 1;
                transform: scale(1)
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(120%);
                opacity: 0
            }

            to {
                transform: translateX(0);
                opacity: 1
            }
        }

        @keyframes pulse-soft {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.04)
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        @keyframes glow-ring {

            0%,
            100% {
                box-shadow: 0 0 0 0 var(--primary-glow)
            }

            50% {
                box-shadow: 0 0 0 16px rgba(16, 185, 129, 0)
            }
        }

        /* SPLASH */
        .splash-screen {
            position: fixed;
            inset: 0;
            background: var(--dark-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }

        .splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .splash-logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 28px;
            animation: pulse-soft 2s ease-in-out infinite;
            box-shadow: 0 0 60px var(--primary-glow), 0 0 120px rgba(16, 185, 129, 0.1);
        }

        .splash-logo svg {
            color: white;
        }

        .splash-title {
            color: white;
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }

        .splash-subtitle {
            color: var(--dark-text-2);
            font-size: 14px;
            margin-bottom: 32px;
        }

        .splash-loader {
            width: 36px;
            height: 36px;
            border: 3px solid var(--dark-card);
            border-top-color: var(--primary-light);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* HEADER */
        .header {
            background: rgba(12, 17, 32, 0.65);
            /* More transparent for Aero effect */
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 0.75rem 1.25rem;
            padding-top: max(0.75rem, env(safe-area-inset-top));
            padding-left: max(1.25rem, env(safe-area-inset-left));
            padding-right: max(1.25rem, env(safe-area-inset-right));
            display: flex;
            flex-wrap: nowrap;
            /* Prevent wrapping */
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background var(--transition);
            backdrop-filter: blur(12px);
            /* Subtle blur */
            -webkit-backdrop-filter: blur(12px);
            overflow: hidden;
            /* Prevent content from overflowing header bounds */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .light .header {
            background: rgba(255, 255, 255, 0.75);
            /* Glass header for light mode */
            border-bottom-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
        }

        /* NEW HEADER STYLE */
        .header-new-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .header-icon-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFF;
            /* White icon for contrast */
            box-shadow: 0 4px 10px rgba(184, 134, 11, 0.4), inset 0 2px 5px rgba(255, 255, 255, 0.4);
            animation: coin-spin 6s linear infinite;
            transform-style: preserve-3d;
        }

        @keyframes coin-spin {
            0% {
                transform: rotateY(0deg);
            }

            100% {
                transform: rotateY(360deg);
            }
        }

        .header-icon-circle svg {
            color: white;
            width: 20px;
            height: 20px;
        }

        .header-new-info {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .header-new-title {
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: -0.3px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-new-date {
            font-size: 0.75rem;
            color: var(--dark-text-2);
            margin-top: 2px;
            font-weight: 400;
        }

        .light .header-new-date {
            color: var(--light-text-2);
        }

        /* TRANSACTION TYPE TOGGLE */
        .type-toggle-group {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 1.25rem;
        }

        .type-toggle-btn {
            padding: 0.55rem 1.5rem;
            border-radius: 50px;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
            justify-content: center;
        }

        .type-toggle-btn.income-toggle {
            background: var(--primary);
            color: white;
            border: 2px solid var(--primary);
            box-shadow: 0 2px 12px var(--primary-glow);
        }

        .type-toggle-btn.income-toggle.inactive {
            background: transparent;
            color: var(--primary);
            border: 2px solid rgba(16, 185, 129, 0.3);
            box-shadow: none;
        }

        .type-toggle-btn.expense-toggle {
            background: var(--danger);
            color: white;
            border: 2px solid var(--danger);
            box-shadow: 0 2px 12px rgba(220, 38, 38, 0.3);
        }

        .type-toggle-btn.expense-toggle.inactive {
            background: transparent;
            color: var(--danger-light);
            border: 2px solid rgba(220, 38, 38, 0.3);
            box-shadow: none;
        }

        .type-toggle-radio {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid currentColor;
            position: relative;
            flex-shrink: 0;
        }

        .type-toggle-radio.filled::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* NEW VALUE DISPLAY */
        .value-display-section {
            text-align: left;
            margin-bottom: 1.25rem;
        }

        .value-display-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--dark-text-3);
            margin-bottom: 0.4rem;
        }

        .light .value-display-label {
            color: var(--light-text-2);
        }

        .value-display-amount {
            font-size: clamp(1.8rem, 6vw, 2.4rem);
            font-weight: 800;
            color: var(--primary-light);
            letter-spacing: -1px;
            cursor: pointer;
            transition: color var(--transition);
            font-variant-numeric: tabular-nums;
        }

        .value-display-amount.expense-color {
            color: var(--danger-light);
        }

        .light .value-display-amount {
            color: var(--primary);
        }

        .light .value-display-amount.expense-color {
            color: var(--danger);
        }

        /* STYLED FORM ROW */
        .form-row-styled {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.85rem 1rem;
            border: 1.5px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-xs);
            margin-bottom: 0.85rem;
            transition: all var(--transition);
            cursor: pointer;
        }

        .dark .form-row-styled {
            background: var(--dark-card);
        }

        .light .form-row-styled {
            background: var(--light-card);
            border-color: rgba(0, 0, 0, 0.08);
        }

        .form-row-styled:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow);
        }

        .form-row-icon {
            color: var(--dark-text-3);
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        .light .form-row-icon {
            color: var(--light-text-3);
        }

        .form-row-styled .form-input,
        .form-row-styled .form-select,
        .form-row-styled .form-textarea {
            border: none;
            background: transparent;
            padding: 0;
            box-shadow: none;
            flex: 1;
            min-width: 0;
        }

        .form-row-styled .form-input:focus,
        .form-row-styled .form-select:focus,
        .form-row-styled .form-textarea:focus {
            box-shadow: none;
            border: none;
        }

        .form-row-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--dark-text-3);
            margin-bottom: 0.35rem;
        }

        .light .form-row-label {
            color: var(--light-text-2);
        }

        /* SAVE TRANSACTION BUTTON */
        .btn-save-transaction {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: var(--radius-xs);
            background: var(--primary);
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition);
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            box-shadow: 0 4px 16px var(--primary-glow);
            margin-top: 0.5rem;
        }

        .btn-save-transaction:hover {
            background: var(--primary-light);
            box-shadow: 0 6px 24px var(--primary-glow);
            transform: translateY(-1px);
        }

        .btn-save-transaction:active {
            transform: scale(0.98);
        }

        /* FAVORITE ROW */
        .favorite-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem 0;
            margin-bottom: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .favorite-row input[type="checkbox"] {
            display: none;
        }

        /* Toggle Slider */
        .toggle-slider {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            transition: background var(--transition);
            cursor: pointer;
            border: 1.5px solid rgba(255, 255, 255, 0.08);
        }

        .light .toggle-slider {
            background: rgba(0, 0, 0, 0.08);
            border-color: rgba(0, 0, 0, 0.1);
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transition: all var(--transition);
        }

        .light .toggle-slider::after {
            background: rgba(0, 0, 0, 0.25);
        }

        .favorite-row input[type="checkbox"]:checked+.toggle-slider {
            background: var(--primary);
            border-color: var(--primary);
        }

        .favorite-row input[type="checkbox"]:checked+.toggle-slider::after {
            left: calc(100% - 20px);
            background: white;
        }

        .light .favorite-row input[type="checkbox"]:checked+.toggle-slider::after {
            background: white;
        }

        /* DATE ROW WITH ARROWS */
        .date-row-styled {
            position: relative;
        }

        .date-display-text {
            flex: 1;
            font-size: 0.92rem;
            font-weight: 500;
            cursor: pointer;
            min-width: 0;
            color: var(--dark-text);
            user-select: none;
        }

        .light .date-display-text {
            color: var(--light-text);
        }

        .date-nav-arrows {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-shrink: 0;
        }

        .date-nav-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--dark-text-3);
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .date-nav-btn:hover {
            color: var(--primary);
            background: rgba(16, 185, 129, 0.08);
        }

        .light .date-nav-btn {
            color: var(--light-text-3);
        }

        .light .date-nav-btn:hover {
            color: var(--primary);
            background: rgba(16, 185, 129, 0.08);
        }

        /* HIDDEN NATIVE VALUE INPUT */
        #transactionValueHidden {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            width: 0;
            height: 0;
        }

        .menu-button {
            background: transparent;
            border: 1px solid var(--dark-border);
            color: var(--dark-text-2);
            cursor: pointer;
            padding: 10px;
            border-radius: var(--radius-xs);
            transition: all var(--transition);
            flex-shrink: 0;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-button:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .light .menu-button {
            border-color: var(--light-border);
            color: var(--light-text-2);
        }

        .header-title-wrapper {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .header-title {
            font-size: 1.15rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.3px;
            line-height: 1.2;
        }

        .header-title svg {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            color: var(--primary-light);
        }

        .header-clock {
            margin-top: 2px;
        }

        .header-clock-inner {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-clock-time {
            font-size: 0.72rem;
            font-weight: 500;
            color: var(--dark-text-2);
            font-variant-numeric: tabular-nums;
        }

        .header-clock-date {
            font-size: 0.72rem;
            color: var(--dark-text-3);
        }

        .light .header-clock-time {
            color: var(--light-text-2);
        }

        .light .header-clock-date {
            color: var(--light-text-3);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .icon-toggle-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
            color: var(--dark-text);
            position: relative;
            overflow: hidden;
        }

        .icon-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .light .icon-toggle-btn {
            color: var(--light-text);
        }

        .light .icon-toggle-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .icon-toggle-btn svg {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }

        .icon-toggle-btn:active svg {
            transform: scale(0.9);
        }





        /* SIDE MENU */
        .menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(6px);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100%;
            z-index: 201;
            transform: translateX(-100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 40px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }

        .dark .side-menu {
            background: var(--dark-bg-2);
        }

        .light .side-menu {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .side-menu.active {
            transform: translateX(0);
        }

        .menu-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 1.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-header h2 {
            font-size: 1.15rem;
            font-weight: 800;
        }

        .menu-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            display: flex;
        }

        .menu-items {
            padding: 0.75rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 0.9rem 1.5rem;
            cursor: pointer;
            transition: all var(--transition);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.93rem;
            font-weight: 500;
            position: relative;
            font-family: inherit;
        }

        .dark .menu-item {
            color: var(--dark-text-2);
        }

        .light .menu-item {
            color: var(--light-text-2);
        }

        .menu-item svg {
            color: var(--dark-text-3);
            transition: color var(--transition);
            flex-shrink: 0;
        }

        .light .menu-item svg {
            color: var(--light-text-3);
        }

        .menu-item:hover {
            background: rgba(16, 185, 129, 0.08);
        }

        .menu-item:hover,
        .menu-item:hover svg {
            color: var(--primary-light);
        }

        .menu-item.active {
            color: var(--primary-light);
            background: rgba(16, 185, 129, 0.1);
        }

        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: var(--primary);
            border-radius: 0 4px 4px 0;
        }

        .menu-item.active svg {
            color: var(--primary-light);
        }

        /* MAIN */
        .main-content {
            padding: 1rem 1.25rem;
            padding-left: max(1.25rem, env(safe-area-inset-left));
            padding-right: max(1.25rem, env(safe-area-inset-right));
            padding-bottom: max(5.5rem, env(safe-area-inset-bottom));
            max-width: 960px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.35s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* CARDS */
        .card {
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            transition: all var(--transition);
            border: 1px solid var(--dark-border);
        }

        .dark .card {
            background: var(--dark-surface);
        }

        .light .card {
            background: var(--light-surface);
            border-color: var(--light-border);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            border-color: rgba(16, 185, 129, 0.12);
        }

        .card h2,
        .card h3 {
            font-weight: 800;
            letter-spacing: -0.3px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 22px;
            background: linear-gradient(180deg, var(--primary), var(--primary-light));
            border-radius: 4px;
            flex-shrink: 0;
        }

        /* STAT CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            border-radius: var(--radius);
            padding: 1.25rem 1rem;
            text-align: left;
            position: relative;
            overflow: hidden;
            transition: transform var(--transition), box-shadow var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card.income {
            background: linear-gradient(145deg, #052e16, #064e3b);
            color: #a7f3d0;
            border: 1px solid rgba(16, 185, 129, 0.15);
        }

        .stat-card.income:hover {
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.2);
        }

        .light .stat-card.income {
            background: linear-gradient(145deg, #ECFDF5, #D1FAE5);
            color: #065F46;
            border-color: rgba(16, 185, 129, 0.2);
        }

        .stat-card.expense {
            background: linear-gradient(145deg, #450a0a, #7f1d1d);
            color: #fecaca;
            border: 1px solid rgba(239, 68, 68, 0.15);
        }

        .stat-card.expense:hover {
            box-shadow: 0 12px 32px rgba(239, 68, 68, 0.2);
        }

        .light .stat-card.expense {
            background: linear-gradient(145deg, #FEF2F2, #FEE2E2);
            color: #991B1B;
            border-color: rgba(239, 68, 68, 0.2);
        }

        .stat-card.balance {
            background: linear-gradient(145deg, #042f2e, var(--primary-dark));
            color: #ccfbf1;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .stat-card.balance:hover {
            box-shadow: 0 12px 32px var(--primary-glow);
        }

        .light .stat-card.balance {
            background: linear-gradient(145deg, #F0FDFA, #CCFBF1);
            color: var(--primary-dark);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .stat-icon {
            font-size: 1.6rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
        }

        .stat-value {
            font-size: clamp(0.8rem, 2.8vw, 1.5rem);
            font-weight: 800;
            letter-spacing: -0.5px;
            word-break: break-all;
            overflow-wrap: anywhere;
            line-height: 1.2;
            margin-bottom: 0.3rem;
        }

        .stat-label {
            font-size: 0.7rem;
            opacity: 0.7;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* FORMS */
        .form-group {
            margin-bottom: 1.15rem;
        }

        .form-group-checkbox {
            display: flex;
            align-items: center;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .dark .form-label {
            color: var(--dark-text-3);
        }

        .light .form-label {
            color: var(--light-text-2);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1.5px solid var(--dark-border);
            border-radius: var(--radius-xs);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all var(--transition);
            outline: none;
        }

        .dark .form-input,
        .dark .form-select,
        .dark .form-textarea {
            background: var(--dark-card);
            color: var(--dark-text);
            border-color: rgba(255, 255, 255, 0.06);
        }

        .light .form-input,
        .light .form-select,
        .light .form-textarea {
            background: rgba(241, 245, 249, 0.7);
            /* Slightly transparent slate */
            color: var(--light-text);
            border-color: rgba(0, 0, 0, 0.06);
            font-weight: 500;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-label-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0;
        }

        .form-label-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* BUTTONS */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-xs);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-family: inherit;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            box-shadow: 0 6px 20px var(--primary-glow);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: var(--success-light);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: var(--danger-light);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: var(--accent);
        }

        .btn-secondary {
            background: transparent;
            border: 1.5px solid var(--dark-border);
        }

        .dark .btn-secondary {
            color: var(--dark-text-2);
        }

        .light .btn-secondary {
            color: var(--light-text-2);
            border-color: var(--light-border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-group {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        #transactionForm .btn-group-round {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 0.75rem;
        }

        #transactionForm .btn-group-round .btn {
            width: 60px;
            height: 60px;
            min-width: 60px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        #transactionForm .btn-group-round .btn svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        #transactionForm .btn-group-round .btn:hover {
            transform: scale(1.12);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
        }

        /* TRANSACTIONS */
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: 0.6rem;
            transition: all var(--transition);
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .dark .transaction-item {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
        }

        .light .transaction-item {
            background: var(--light-card);
            border: 1px solid var(--light-border);
        }

        .transaction-item:hover {
            border-color: rgba(16, 185, 129, 0.15);
            transform: translateX(4px);
        }

        .transaction-info {
            flex: 1;
            min-width: 0;
        }

        .transaction-description {
            font-weight: 700;
            margin-bottom: 0.2rem;
            font-size: 0.95rem;
        }

        .transaction-meta {
            font-size: 0.78rem;
            opacity: 0.55;
        }

        .transaction-amount {
            font-weight: 800;
            font-size: clamp(0.8rem, 2.2vw, 1.1rem);
            margin-right: 0.5rem;
            word-break: break-all;
            overflow-wrap: break-word;
            min-width: 0;
            flex-shrink: 1;
            text-align: right;
        }

        .transaction-amount.income {
            color: var(--success-light);
        }

        .transaction-amount.expense {
            color: var(--danger-light);
        }

        .light .transaction-amount.income {
            color: var(--success);
        }

        .light .transaction-amount.expense {
            color: var(--danger);
        }

        .transaction-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.45rem 0.6rem;
            border: none;
            border-radius: var(--radius-xs);
            cursor: pointer;
            transition: all var(--transition);
            font-size: 0.88rem;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.edit {
            background: rgba(245, 158, 11, 0.12);
            color: var(--accent);
        }

        .action-btn.delete {
            background: rgba(239, 68, 68, 0.12);
            color: var(--danger-light);
        }

        .action-btn svg {
            width: 16px;
            height: 16px;
            stroke-width: 2.25;
            transition: transform var(--transition);
        }

        .action-btn:hover svg {
            transform: scale(1.1);
        }

        .action-btn.favorite-btn {
            background: transparent;
            color: var(--accent);
            font-size: 1.05rem;
        }

        .action-btn.move-up {
            background: rgba(16, 185, 129, 0.12);
            color: var(--primary-light);
        }

        .action-btn.move-down {
            background: rgba(16, 185, 129, 0.12);
            color: var(--primary-light);
        }

        /* DATE NAV */
        .date-nav-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .date-nav-arrow {
            background: none;
            border: 1px solid rgba(16, 185, 129, 0.25);
            border-radius: var(--radius-xs);
            padding: 0.4rem;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            min-width: 36px;
        }

        .dark .date-nav-arrow {
            color: var(--dark-text);
        }

        .light .date-nav-arrow {
            color: var(--light-text);
        }

        .date-nav-arrow:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--primary);
        }

        .date-nav-arrow svg {
            width: 16px;
            height: 16px;
        }

        /* SEARCH */
        .search-section {
            margin-bottom: 2rem;
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .search-actions {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .search-results {
            margin-top: 1rem;
        }

        .search-results-grouped {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .search-results-date-group {
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .dark .search-results-date-group {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
        }

        .light .search-results-date-group {
            background: var(--light-surface);
            border: 1px solid var(--light-border);
        }

        .search-results-date-header {
            padding: 0.65rem 1.1rem;
            font-weight: 700;
            font-size: 0.82rem;
            border-bottom: 1px solid rgba(16, 185, 129, 0.08);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dark .search-results-date-header {
            background: rgba(16, 185, 129, 0.05);
            color: var(--primary-light);
        }

        .light .search-results-date-header {
            background: rgba(16, 185, 129, 0.04);
            color: var(--primary-dark);
        }

        .search-results-date-list {
            padding: 0.5rem;
        }

        .search-result-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem;
            border-radius: var(--radius-xs);
            margin-bottom: 0.4rem;
            transition: all 0.2s ease;
            gap: 0.6rem;
        }

        .search-result-card:last-child {
            margin-bottom: 0;
        }

        .search-result-card:hover {
            transform: translateX(4px);
        }

        .dark .search-result-card:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .light .search-result-card:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .search-result-card .transaction-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-card .transaction-description {
            font-weight: 700;
            font-size: 0.92rem;
            margin-bottom: 0.15rem;
        }

        .search-result-card .transaction-meta {
            font-size: 0.78rem;
            opacity: 0.65;
        }

        .search-result-card .favorite-star {
            flex-shrink: 0;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-size: 1.1rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .search-result-card .favorite-star.favorited {
            opacity: 1;
        }

        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            border-bottom: 2px solid rgba(16, 185, 129, 0.08);
        }

        .search-result-count {
            font-size: 0.85rem;
            opacity: 0.65;
        }

        /* MONTH-YEAR FILTERS */
        .month-year-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            width: 100%;
        }

        /* MONTH PICKER */
        .month-picker-container {
            border-radius: var(--radius-sm);
            padding: 1.25rem;
            border: 1px solid var(--dark-border);
        }

        .dark .month-picker-container {
            background: var(--dark-card);
        }

        .light .month-picker-container {
            background: var(--light-card);
            border-color: var(--light-border);
        }

        .month-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .month-picker-year {
            font-size: 1.15rem;
            font-weight: 800;
        }

        .dark .month-picker-year {
            color: var(--dark-text);
        }

        .light .month-picker-year {
            color: var(--light-text);
        }

        .month-picker-nav {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .month-picker-nav-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 2px 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
            font-size: 0.7rem;
        }

        .dark .month-picker-nav-btn {
            color: var(--dark-text-2);
        }

        .light .month-picker-nav-btn {
            color: var(--light-text-2);
        }

        .month-picker-nav-btn:hover {
            color: var(--primary);
        }

        .month-picker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .month-picker-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.82rem;
            font-weight: 500;
            background: transparent;
            border: none;
            padding: 0;
        }

        .dark .month-picker-item {
            color: var(--dark-text);
        }

        .light .month-picker-item {
            color: var(--light-text);
        }

        .month-picker-item:hover {
            background: rgba(16, 185, 129, 0.1);
            transform: scale(1.05);
        }

        .month-picker-item.selected {
            background: var(--primary);
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .month-picker-item.other-year {
            opacity: 0.4;
        }

        /* CHART */
        .chart-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .chart-type-toggle {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .chart-type-btn {
            flex: 1;
            min-width: 100px;
            padding: 0.65rem 1rem;
            border: 2px solid var(--primary);
            border-radius: var(--radius-xs);
            background: transparent;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .chart-type-btn:hover {
            background: rgba(16, 185, 129, 0.1);
        }

        .chart-type-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .chart-container-wrapper {
            position: relative;
            width: 100%;
            min-height: 280px;
            padding: 1rem 0;
        }

        .chart-container-wrapper canvas {
            max-width: 100%;
            height: auto !important;
        }

        /* GOALS */
        .goal-item {
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 0.85rem;
            transition: all var(--transition);
        }

        .dark .goal-item {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
        }

        .light .goal-item {
            background: var(--light-card);
            border: 1px solid var(--light-border);
        }

        .goal-item:hover {
            border-color: rgba(16, 185, 129, 0.15);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.85rem;
        }

        .goal-info h3 {
            margin-bottom: 0.4rem;
            font-size: 1.05rem;
        }

        .goal-info h3::before {
            display: none;
        }

        .goal-values {
            font-size: clamp(0.7rem, 1.5vw+0.5rem, 0.88rem);
            opacity: 0.65;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .goal-actions {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
            flex-shrink: 0;
        }

        .goal-progress {
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 7px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.6rem;
        }

        .dark .progress-bar {
            background: rgba(255, 255, 255, 0.05);
        }

        .light .progress-bar {
            background: rgba(0, 0, 0, 0.06);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success-light));
            transition: width 0.4s ease;
            border-radius: 4px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: clamp(0.65rem, 1.5vw+0.4rem, 0.8rem);
            opacity: 0.65;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        /* SUMMARIES */
        .summary-section {
            margin-bottom: 0.85rem;
            border-radius: var(--radius);
            overflow: hidden;
        }

        .dark .summary-section {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
        }

        .light .summary-section {
            background: var(--light-surface);
            border: 1px solid var(--light-border);
        }

        .summary-header {
            padding: 1.1rem 1.35rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition);
        }

        .summary-header:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        .summary-title {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 700;
            font-size: 0.98rem;
        }

        .summary-title svg {
            color: var(--primary-light);
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .summary-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }

        .summary-content.expanded {
            max-height: 2000px;
        }

        .summary-body {
            padding: 1.35rem;
            border-top: 1px solid rgba(16, 185, 129, 0.06);
        }

        /* BACKUP */
        .backup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.85rem;
        }

        .backup-btn {
            background: none;
            border: 2px solid;
            padding: 1.1rem 1.35rem;
            border-radius: var(--radius-sm);
            font-size: 0.93rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 0.85rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            min-width: 160px;
            justify-content: center;
            font-family: inherit;
        }

        .backup-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.2);
        }

        .backup-btn-export {
            border-color: var(--primary);
            color: var(--primary);
        }

        .backup-btn-export:hover {
            background: var(--primary);
            color: white;
        }

        .backup-btn-import {
            border-color: var(--primary-light);
            color: var(--primary-light);
        }

        .backup-btn-import:hover {
            background: var(--primary-light);
            color: white;
        }

        .backup-btn-excel {
            border-color: var(--success);
            color: var(--success);
        }

        .backup-btn-excel:hover {
            background: var(--success);
            color: white;
        }

        .backup-btn-clear {
            border-color: var(--danger);
            color: var(--danger);
        }

        .backup-btn-sync {
            border-color: var(--accent);
            color: var(--accent);
        }

        .backup-btn-sync:hover {
            background: var(--accent);
            color: white;
        }

        .backup-btn-clear:hover {
            background: var(--danger);
            color: white;
        }

        .backup-btn-icon {
            font-size: 1.3rem;
        }

        #emptyTrashBtn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 1.1rem;
            border-radius: var(--radius-xs);
            font-weight: 700;
            border: none;
            background: var(--danger);
            color: white;
            cursor: pointer;
            font-family: inherit;
            transition: all var(--transition);
            align-self: flex-start;
            min-width: 140px;
            justify-content: center;
        }

        #emptyTrashBtn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        #emptyTrashBtn:hover {
            background: var(--danger-light);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }

        /* MODALS */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
            padding: 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.92);
            transition: transform 0.3s ease;
            position: relative;
            z-index: 1001;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .dark .modal {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
        }

        .light .modal {
            background: var(--light-surface);
            border: 1px solid var(--light-border);
        }

        #monthPickerModal .modal {
            max-width: 400px;
            padding: 1.75rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 800;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .dark .modal-close {
            color: var(--dark-text);
        }

        .light .modal-close {
            color: var(--light-text);
        }

        .modal-close:hover {
            opacity: 1;
        }

        /* NOTIFICATIONS */
        .notifications {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .notification {
            padding: 0.9rem 1.35rem;
            border-radius: var(--radius-xs);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transform: translateX(120%);
            animation: slideInRight 0.35s ease forwards;
            max-width: 340px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(10px);
        }

        .notification.success {
            background: rgba(16, 185, 129, 0.95);
        }

        .notification.error {
            background: rgba(220, 38, 38, 0.95);
        }

        .notification.warning {
            background: rgba(217, 119, 6, 0.95);
        }

        .notification.info {
            background: rgba(16, 185, 129, 0.9);
        }

        /* FLOATING CALC */
        .floating-calc-btn {
            position: fixed;
            bottom: 28px;
            right: 28px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px 24px var(--primary-glow);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 150;
            transition: all var(--transition);
        }

        .floating-calc-btn:hover {
            transform: scale(1.12);
            box-shadow: 0 8px 32px var(--primary-glow);
        }

        .floating-calc-btn svg {
            width: 24px;
            height: 24px;
        }

        .calc-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(10px);
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .calc-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .calc-window {
            width: 100%;
            max-width: 340px;
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
            border: 1px solid var(--dark-border);
        }

        .dark .calc-window {
            background: var(--dark-surface);
        }

        .light .calc-window {
            background: var(--light-surface);
            border-color: var(--light-border);
        }

        .calc-display {
            width: 100%;
            padding: 1.1rem;
            font-size: 1.8rem;
            font-weight: 800;
            text-align: right;
            border: none;
            border-radius: var(--radius-xs);
            margin-bottom: 0.85rem;
            font-family: inherit;
        }

        .dark .calc-display {
            background: var(--dark-card);
            color: var(--dark-text);
        }

        .light .calc-display {
            background: var(--light-card);
            color: var(--light-text);
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 7px;
        }

        .calc-btn {
            padding: 1rem;
            font-size: 1.15rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-xs);
            cursor: pointer;
            transition: all 0.1s;
            font-family: inherit;
        }

        .dark .calc-btn {
            background: var(--dark-card);
            color: var(--dark-text);
        }

        .light .calc-btn {
            background: var(--light-card);
            color: var(--light-text);
        }

        .calc-btn:active {
            transform: scale(0.94);
        }

        .calc-btn.operator {
            background: rgba(16, 185, 129, 0.15);
            color: var(--primary-light);
        }

        .calc-btn.equals {
            background: var(--success);
            color: white;
        }

        .calc-btn.clear {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-light);
        }

        .calc-btn.zero {
            grid-column: span 2;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            opacity: 0.45;
            font-size: 0.92rem;
        }

        /* UTILITIES */
        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        .mb-3 {
            margin-bottom: 1.5rem;
        }

        .mt-1 {
            margin-top: 0.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-1 {
            gap: 0.5rem;
        }

        .gap-2 {
            gap: 1rem;
        }

        .hidden {
            display: none;
        }

        .w-full {
            width: 100%;
        }

        /* RESPONSIVE */
        @media(max-width:768px) {
            .month-year-filters {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .main-content {
                padding: 0.75rem;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 0.6rem;
            }

            .stat-card {
                padding: 1rem 0.6rem;
            }

            .stat-value {
                font-size: clamp(0.7rem, 3.2vw, 1.15rem);
            }

            .stat-icon {
                font-size: 1.3rem;
                width: 36px;
                height: 36px;
                border-radius: 10px;
            }

            .btn-group {
                justify-content: center;
                gap: 0.5rem;
            }

            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.87rem;
                flex: 1;
                justify-content: center;
                min-width: 0;
            }

            .backup-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.6rem;
            }

            .backup-btn {
                min-width: auto;
                padding: 0.85rem 0.85rem;
                font-size: 0.87rem;
            }

            .transaction-item {
                flex-direction: column;
                align-items: stretch;
                gap: 0.6rem;
                padding: 0.85rem;
            }

            .transaction-info {
                text-align: center;
            }

            .transaction-amount {
                text-align: center;
                margin-right: 0;
                font-size: clamp(0.85rem, 3.2vw, 1.15rem);
            }

            .transaction-actions {
                justify-content: center;
                gap: 0.6rem;
            }

            .action-btn {
                padding: 0.5rem 0.8rem;
                flex: 1;
                justify-content: center;
            }

            .goal-header {
                flex-direction: column;
                gap: 0.5rem;
            }

            .goal-item {
                padding: 1.1rem;
            }

            .modal {
                width: 95%;
                padding: 1.5rem;
            }

            .notifications {
                left: 0.5rem;
                right: 0.5rem;
            }

            .notification {
                max-width: none;
            }

            .card {
                padding: 1.15rem;
            }

            .search-filters {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .search-actions {
                justify-content: center;
            }

            .chart-filters {
                grid-template-columns: 1fr;
            }

            .side-menu {
                width: 280px;
            }

            .menu-item {
                padding: 0.8rem 1.15rem;
                font-size: 0.9rem;
            }

            .progress-text {
                flex-direction: column;
                gap: 0.2rem;
                text-align: center;
            }

            /* USER PROFILE STYLES */
            .user-profile {
                padding: 1.75rem 1.25rem;
                margin-bottom: 0.5rem;
                border-bottom: 1px solid var(--dark-border);
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 12px;
                background: linear-gradient(to bottom, rgba(255, 255, 255, 0.03), transparent);
            }

            .light .user-profile {
                background: linear-gradient(to bottom, rgba(0, 0, 0, 0.02), transparent);
                border-bottom-color: var(--light-border);
            }

            .user-avatar-wrapper {
                position: relative;
                padding: 3px;
                background: linear-gradient(135deg, var(--primary), var(--primary-light));
                border-radius: 50%;
                box-shadow: 0 4px 15px var(--primary-glow);
            }

            .user-avatar {
                width: 64px;
                height: 64px;
                border-radius: 50%;
                border: 2px solid var(--dark-card);
                object-fit: cover;
                background: var(--dark-card);
                display: block;
            }

            .light .user-avatar {
                border-color: var(--light-card);
            }

            .user-info {
                display: flex;
                flex-direction: column;
                min-width: 0;
                width: 100%;
            }

            .user-name {
                font-size: 1.1rem;
                font-weight: 700;
                color: var(--dark-text);
                margin-bottom: 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .light .user-name {
                color: var(--light-text);
            }

            .user-email {
                font-size: 0.75rem;
                color: var(--dark-text-3);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #emptyTrashBtn {
                padding: 0.6rem 0.85rem;
                font-size: 0.92rem;
                align-self: stretch;
                min-width: 0;
            }

            #transactionForm .btn-group-round .btn {
                width: 54px;
                height: 54px;
                min-width: 54px;
            }

            #transactionForm .btn-group-round .btn svg {
                width: 22px;
                height: 22px;
            }

            .type-toggle-btn {
                padding: 0.5rem 1.2rem;
                font-size: 0.84rem;
                min-width: 90px;
            }

            .value-display-amount {
                font-size: clamp(1.6rem, 5.5vw, 2.2rem);
            }
        }

        @media(max-width:480px) {
            .header {
                padding: 0.6rem 0.85rem;
                gap: 0.35rem;
            }

            .header-title {
                font-size: 1rem;
            }

            .main-content {
                padding: 0.5rem;
            }

            .card {
                padding: 0.9rem;
                margin-bottom: 0.85rem;
            }

            .stat-card {
                padding: 0.75rem 0.45rem;
            }

            .stat-value {
                font-size: clamp(0.65rem, 3.2vw, 1.05rem);
            }

            .stat-icon {
                font-size: 1.1rem;
                width: 32px;
                height: 32px;
                border-radius: 8px;
                margin-bottom: 0.35rem;
            }

            .stat-label {
                font-size: 0.62rem;
            }

            .stats-grid {
                gap: 0.4rem;
            }

            .btn {
                padding: 0.55rem 0.75rem;
                font-size: 0.83rem;
            }

            .backup-btn {
                padding: 0.7rem;
                font-size: 0.84rem;
            }

            .backup-grid {
                grid-template-columns: 1fr;
            }

            .transaction-item {
                padding: 0.65rem;
            }

            .action-btn {
                padding: 0.4rem 0.55rem;
                font-size: 0.82rem;
            }

            .form-input,
            .form-select,
            .form-textarea {
                padding: 0.7rem 0.85rem;
                font-size: 0.9rem;
            }

            .modal {
                padding: 1.25rem;
            }

            .side-menu {
                width: 260px;
            }

            .menu-item {
                padding: 0.7rem 0.85rem;
                font-size: 0.87rem;
            }

            .date-nav-arrow {
                width: 32px;
                height: 32px;
                min-width: 32px;
            }

            .date-nav-arrow svg {
                width: 14px;
                height: 14px;
            }

            .floating-calc-btn {
                width: 50px;
                height: 50px;
                bottom: 20px;
                right: 20px;
            }

            .floating-calc-btn svg {
                width: 20px;
                height: 20px;
            }

            .calc-display {
                font-size: clamp(1.1rem, 5vw, 1.5rem);
                padding: 0.85rem;
            }

            .calc-btn {
                padding: 0.85rem;
                font-size: 1.05rem;
                min-height: 44px;
            }

            .splash-title {
                font-size: 22px;
            }

            .splash-subtitle {
                font-size: 13px;
            }

            .splash-logo {
                width: 84px;
                height: 84px;
                border-radius: 22px;
            }

            #emptyTrashBtn {
                width: 100%;
                justify-content: center;
            }

            #transactionForm .btn-group-round .btn {
                width: 50px;
                height: 50px;
                min-width: 50px;
            }

            #transactionForm .btn-group-round .btn svg {
                width: 20px;
                height: 20px;
            }

            #transactionForm .btn-group-round {
                gap: 0.85rem;
            }

            .type-toggle-btn {
                padding: 0.45rem 1rem;
                font-size: 0.82rem;
                min-width: 80px;
            }

            .value-display-amount {
                font-size: clamp(1.4rem, 5vw, 1.8rem);
            }

            .header-icon-circle {
                width: 36px;
                height: 36px;
                min-width: 36px;
            }

            .header-icon-circle svg {
                width: 18px;
                height: 18px;
            }

            .header-new-title {
                font-size: 1.05rem;
                max-width: 120px;
                /* Limit width on very small screens */
            }

            .header-new-date {
                font-size: 0.68rem;
            }

            .header-new-date #clockDate {
                display: inline;
                /* Show date on mobile as requested */
            }

            .header-controls {
                gap: 4px;
            }

            .pill-toggle {
                padding: 2px;
            }

            .pill-toggle-btn {
                width: 32px;
                height: 32px;
            }
        }

        @media(max-width:360px) {
            .header-new-left {
                gap: 4px;
            }

            .header-icon-circle {
                display: none;
                /* Hide icon on ultra-small screens */
            }

            .header-new-title {
                font-size: 0.88rem;
                max-width: 90px;
            }

            .pill-toggle-btn {
                width: 28px;
                height: 28px;
            }

            .pill-toggle-btn svg {
                width: 14px;
                height: 14px;
            }

            .pill-toggle-btn.lang-pill {
                font-size: 0.65rem;
            }
        }

        /* LOGIN OVERLAY */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, rgba(16, 185, 129, 0.05) 0%, rgba(7, 11, 20, 0.98) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .login-card {
            background: rgba(26, 34, 54, 0.8);
            padding: 3rem 2.5rem;
            border-radius: 32px;
            text-align: center;
            max-width: 420px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: scaleIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(10px);
        }

        .login-logo {
            width: 88px;
            height: 88px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            color: white;
            box-shadow: 0 0 40px var(--primary-glow);
            animation: pulse-soft 2s infinite ease-in-out;
        }

        .login-title {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 0.75rem;
            color: var(--dark-text);
        }

        .login-subtitle {
            font-size: 1rem;
            color: var(--dark-text-2);
            margin-bottom: 2.5rem;
            line-height: 1.6;
        }

        .google-login-btn {
            width: 100%;
            padding: 1rem;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: white;
            color: #1f2937;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .google-login-btn:hover {
            background: #f9fafb;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: var(--primary);
        }

        .google-login-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .login-loader {
            width: 36px;
            height: 36px;
            border: 3px solid rgba(16, 185, 129, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* SEGMENTED CONTROL ALTERNATIVO - Slide Style */
        .segmented-control-container {
            display: flex;
            background: #0f172a;
            padding: 4px;
            border-radius: 9999px;
            position: relative;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            height: 52px;
        }

        .segmented-background {
            position: absolute;
            top: 4px;
            left: 4px;
            width: calc(50% - 4px);
            height: calc(100% - 8px);
            background: #10b981;
            /* Green default */
            border-radius: 9999px;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), background-color 0.3s ease;
            z-index: 1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .segmented-background.bg-expense {
            background: #ef4444;
            /* Red expense */
        }

        .segmented-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            background: transparent;
            border: none;
            color: #64748b;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .segmented-btn.active {
            color: #ffffff;
        }

        .segmented-btn:hover:not(.active) {
            color: #e2e8f0;
        }

        /* Light Mode Segmented Control */
        .light .segmented-control-container {
            background: #e2e8f0;
            border-color: rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .light .segmented-btn {
            color: #64748b;
        }

        .light .segmented-btn:hover:not(.active) {
            color: #475569;
        }

        .light .segmented-btn.active {
            color: #ffffff;
        }
    </style>
</head>

<body class="dark">
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
            </svg>
        </div>
        <h1 class="splash-title">Controle Financeiro</h1>
        <p class="splash-subtitle">Gerencie suas finanas de forma inteligente</p>
        <div class="splash-loader"></div>
    </div>

    <!-- Login Screen -->
    <div class="login-overlay" id="loginOverlay" style="display:none;">
        <div class="login-card">
            <div class="login-logo">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
            </div>
            <h2 class="login-title">Bem-vindo ao Finanas</h2>
            <p class="login-subtitle">Acesse sua conta para sincronizar seus dados</p>
            <button class="google-login-btn" id="googleLoginBtn" onclick="loginWithGoogle()">
                <svg viewBox="0 0 48 48" width="24" height="24">
                    <path fill="#EA4335"
                        d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z">
                    </path>
                    <path fill="#4285F4"
                        d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z">
                    </path>
                    <path fill="#FBBC05"
                        d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z">
                    </path>
                    <path fill="#34A853"
                        d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z">
                    </path>
                </svg>
                <span>Entrar com Google</span>
            </button>
            <div class="login-loader" id="loginLoader" style="display:none;"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-new-left">
            <button class="menu-button" onclick="toggleMenu()" style="margin-right:4px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6" />
                    <line x1="3" y1="12" x2="21" y2="12" />
                    <line x1="3" y1="18" x2="21" y2="18" />
                </svg>
            </button>
            <div class="header-icon-circle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
            </div>
            <div class="header-new-info">
                <h1 class="header-new-title" data-i18n="appTitle">CONTROLE FINANCEIRO </h1>
                <div class="header-new-date" id="headerNewDate">
                    <span id="clockDate">--/--/----</span> <span style="margin:0 2px;">&#8226;</span> <span
                        id="clockTime">00:00</span>
                </div>
            </div>
        </div>
        <div class="header-controls">
            <!-- Language Toggle -->
            <button type="button" class="icon-toggle-btn" id="langToggleBtn" onclick="toggleLanguage()"
                title="Mudar Idioma">
                <!-- Icon will be set by JS -->
                <img src="https://flagcdn.com/w40/br.png" alt="Brazil Flag"
                    style="width: 24px; height: 18px; border-radius: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">
            </button>

            <!-- Theme Toggle -->
            <button type="button" class="icon-toggle-btn" id="themeToggleBtn" onclick="toggleTheme()"
                title="Alternar Tema">
                <!-- Icon will be set by JS -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

    <!-- Side Menu -->
    <nav class="side-menu" id="sideMenu">
        <div class="menu-header">
            <h2 data-i18n="menu">Menu</h2>
            <button class="menu-close" onclick="closeMenu()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>
        <!-- User Profile Section -->
        <div id="userProfile" class="user-profile" style="display: none;">
            <div class="user-avatar-wrapper">
                <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
            </div>
            <div class="user-info">
                <span id="userName" class="user-name">Usurio</span>
                <span id="userEmail" class="user-email">email@exemplo.com</span>
            </div>
        </div>
        <div class="menu-items">
            <button class="menu-item active" onclick="showTab('new-transaction', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="16" />
                    <line x1="8" y1="12" x2="16" y2="12" />
                </svg>
                <span data-i18n="menuNewTransaction">Nova Transacao</span>
            </button>
            <button class="menu-item" onclick="showTab('transactions', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14,2 14,8 20,8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                </svg>
                <span data-i18n="menuTransactions">Transacoes</span>
            </button>
            <button class="menu-item" onclick="showTab('search', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                </svg>
                <span data-i18n="menuSearch">Buscar</span>
            </button>
            <button class="menu-item" onclick="showTab('charts', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10" />
                    <line x1="12" y1="20" x2="12" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="14" />
                </svg>
                <span data-i18n="menuCharts">Grafico</span>
            </button>
            <button class="menu-item" onclick="showTab('summaries', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14,2 14,8 20,8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                </svg>
                <span data-i18n="menuSummaries">Resumos</span>
            </button>
            <button class="menu-item" onclick="showTab('goals', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <polygon points="10,8 16,12 10,16 10,8" />
                </svg>
                <span data-i18n="menuGoals">Metas</span>
            </button>
            <button class="menu-item" onclick="showTab('trash', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6" />
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    <line x1="10" y1="11" x2="10" y2="17" />
                    <line x1="14" y1="11" x2="14" y2="17" />
                </svg>
                <span data-i18n="menuTrash">Lixeira</span>
            </button>
            <button class="menu-item" onclick="showTab('backup', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7,10 12,15 17,10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                <span data-i18n="menuBackup">Backup</span>
            </button>
            <button class="menu-item" onclick="logout()" style="margin-top: auto; color: var(--danger);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <polyline points="16 17 21 12 16 7" />
                    <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
                <span data-i18n="logout">Sair</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <div class="card">
                <h2 class="mb-2" data-i18n="allTransactions">Todas as Transacoes</h2>
                <div id="transactionsList"></div>
            </div>
        </div>

        <!-- Search Tab -->
        <div id="search" class="tab-content">
            <div class="card">
                <h2 class="mb-2" data-i18n="searchTransactions">Buscar Transacoes</h2>
                <div class="search-section">
                    <div class="search-filters">
                        <div class="form-group"><label class="form-label" data-i18n="searchByName">Buscar por
                                nome/descricao</label><input type="text" id="searchDescription" class="form-input"
                                data-i18n-placeholder="placeholderDesc" placeholder="Digite a descricao..."
                                oninput="performSearch()"></div>
                        <div class="form-group"><label class="form-label" data-i18n="category">Categoria</label>
                            <select id="searchCategory" class="form-select" onchange="performSearch()">
                                <option value="" data-i18n="allCategories">Todas as categorias</option>
                                <option value="alimentacao">&#127869; Alimentacao</option>
                                <option value="mercado">&#128722; Mercado</option>
                                <option value="combustivel">&#9981; Combustivel</option>
                                <option value="manutencao_veiculo">&#128295; Manutencao Veiculo</option>
                                <option value="transporte">&#128663; Transporte</option>
                                <option value="moradia">&#127968; Moradia</option>
                                <option value="saude">&#127973; Saude</option>
                                <option value="educacao">&#128218; Educacao</option>
                                <option value="lazer">&#127918; Lazer</option>
                                <option value="salario">&#128188; Salario</option>
                                <option value="freelance">&#128187; Freelance</option>
                                <option value="investimentos">&#128200; Investimentos</option>
                                <option value="outros">&#128230; Outros</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label" data-i18n="type">Tipo</label>
                            <select id="searchType" class="form-select" onchange="performSearch()">
                                <option value="" data-i18n="allTypes">Todos os tipos</option>
                                <option value="income" data-i18n="income">Receita</option>
                                <option value="expense" data-i18n="expense">Despesa</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label" data-i18n="monthYear">Mes/Ano</label>
                            <div class="month-year-filters">
                                <div class="form-group" style="margin-bottom:0;"><label class="form-label"
                                        data-i18n="selectMonth"
                                        style="font-size:0.8rem;margin-bottom:0.3rem;">Mes</label>
                                    <button type="button" class="form-input" id="monthPickerButton"
                                        onclick="showMonthPickerModal()"
                                        style="text-align:left;cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
                                        <span id="monthPickerButtonText" data-i18n="selectMonth">Selecionar Mes</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <polyline points="6,9 12,15 18,9"></polyline>
                                        </svg>
                                    </button>
                                    <input type="hidden" id="selectedMonths" value="">
                                </div>
                                <div class="form-group" style="margin-bottom:0;"><label class="form-label"
                                        data-i18n="selectYear"
                                        style="font-size:0.8rem;margin-bottom:0.3rem;">Ano</label>
                                    <select id="searchYear" class="form-select" onchange="performSearch()">
                                        <option value="">Todos os anos</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group form-group-checkbox"><label class="form-label form-label-checkbox"><input
                                    type="checkbox" id="searchFavorites" onchange="performSearch()"> &#11088; <span
                                    data-i18n="favoritesOnly">Apenas favoritas</span></label></div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" onclick="performSearch()"><svg width="16" height="16"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8" />
                                <path d="m21 21-4.35-4.35" />
                            </svg><span data-i18n="search">Buscar</span></button>
                        <button class="btn btn-secondary" onclick="clearSearch()"><svg width="16" height="16"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6" />
                                <path
                                    d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2" />
                            </svg><span data-i18n="clearFilters">Limpar Filtros</span></button>
                        <button class="btn btn-success" onclick="exportSearchResultsToExcel()"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="7,10 12,15 17,10" />
                                <line x1="12" y1="15" x2="12" y2="3" />
                            </svg><span data-i18n="exportResults">Exportar Resultados</span></button>
                    </div>
                </div>
                <div class="search-results">
                    <div class="search-result-header">
                        <h3 data-i18n="searchResults">Resultados da Busca</h3><span class="search-result-count"
                            id="searchResultCount">0 transacoes encontradas</span>
                    </div>
                    <div class="card mb-2" id="searchTotalsCard" style="display:none;">
                        <div class="stats-grid">
                            <div class="stat-card income">
                                <div class="stat-value" id="searchTotalIncome">R$ 0,00</div>
                                <div class="stat-label" data-i18n="searchIncome">Receitas na Busca</div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-value" id="searchTotalExpense">R$ 0,00</div>
                                <div class="stat-label" data-i18n="searchExpense">Despesas na Busca</div>
                            </div>
                            <div class="stat-card balance">
                                <div class="stat-value" id="searchTotalBalance">R$ 0,00</div>
                                <div class="stat-label" data-i18n="searchBalance">Saldo da Busca</div>
                            </div>
                        </div>
                    </div>
                    <div id="searchResultsList"></div>
                </div>
            </div>
        </div>

        <!-- New Transaction Tab -->
        <div id="new-transaction" class="tab-content active">
            <div class="card">
                <h2 class="mb-2" data-i18n="newTransaction">Nova Transacao</h2>
                <form id="transactionForm">
                    <!-- Segmented Control -->
                    <div class="segmented-control-container">
                        <div class="segmented-background" id="segmentedBackground"></div>
                        <button type="button" class="segmented-btn active" id="btnIncome"
                            onclick="setTransactionType('income')">
                            <span data-i18n="gains">Ganho</span>
                        </button>
                        <button type="button" class="segmented-btn" id="btnExpense"
                            onclick="setTransactionType('expense')">
                            <span data-i18n="spending">Gasto</span>
                        </button>
                    </div>

                    <!-- Value Display -->
                    <div class="value-display-section">
                        <div class="value-display-label" data-i18n="value">VALOR DO LANCAMENTO</div>
                        <input type="number" id="transactionValue" class="value-display-amount" step="0.01" min="0"
                            placeholder="0,00" required
                            style="width:100%;border:none;background:transparent;padding:0;outline:none;font-family:inherit;">
                    </div>

                    <!-- Date Row -->
                    <div class="form-row-label" data-i18n="date">DATA</div>
                    <div class="form-row-styled date-row-styled">
                        <div class="form-row-icon"
                            onclick="var inp=document.getElementById('transactionDate');inp.showPicker?inp.showPicker():inp.focus();"
                            style="cursor:pointer;">
                            <span class="form-icon">&#128197;</span>
                        </div>
                        <span class="date-display-text" id="dateDisplayText"
                            onclick="var inp=document.getElementById('transactionDate');inp.showPicker?inp.showPicker():inp.focus();">--/--/----</span>
                        <input type="date" id="transactionDate" class="form-input" required
                            style="position:absolute;opacity:0;pointer-events:none;width:0;height:0;">
                        <div class="date-nav-arrows">
                            <button type="button" class="date-nav-btn"
                                onclick="event.stopPropagation();var inp=document.getElementById('transactionDate');inp.showPicker?inp.showPicker():inp.focus();"
                                title="Calendario">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                                    <line x1="16" y1="2" x2="16" y2="6" />
                                    <line x1="8" y1="2" x2="8" y2="6" />
                                    <line x1="3" y1="10" x2="21" y2="10" />
                                </svg>
                            </button>
                            <button type="button" class="date-nav-btn" onclick="event.stopPropagation();previousDay();"
                                title="Dia anterior">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="15,18 9,12 15,6" />
                                </svg>
                            </button>
                            <button type="button" class="date-nav-btn" onclick="event.stopPropagation();nextDay();"
                                title="Proximo dia">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="9,18 15,12 9,6" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Category Row -->
                    <div class="form-row-label" data-i18n="category">CATEGORIA</div>
                    <div class="form-row-styled">
                        <div class="form-row-icon">
                            <span class="form-icon"></span>
                        </div>
                        <select id="transactionCategory" class="form-select" required style="flex:1;">
                            <option value="" data-i18n="selectCategory">Selecione uma categoria</option>
                            <option value="alimentacao">&#127869; Alimentacao</option>
                            <option value="mercado">&#128722; Mercado</option>
                            <option value="combustivel">&#9981; Combustivel</option>
                            <option value="manutencao_veiculo">&#128295; Manutencao Veiculo</option>
                            <option value="transporte">&#128663; Transporte</option>
                            <option value="moradia">&#127968; Moradia</option>
                            <option value="saude">&#127973; Saude</option>
                            <option value="educacao">&#128218; Educacao</option>
                            <option value="lazer">&#127918; Lazer</option>
                            <option value="salario">&#128188; Salario</option>
                            <option value="freelance">&#128187; Freelance</option>
                            <option value="investimentos">&#128200; Investimentos</option>
                            <option value="outros">&#128230; Outros</option>
                        </select>
                    </div>

                    <!-- Description Row -->
                    <div class="form-row-label" data-i18n="description">DESCRICAO</div>
                    <div class="form-row-styled">
                        <div class="form-row-icon">
                            <span class="form-icon"></span>
                        </div>
                        <input type="text" id="transactionDescription" class="form-input"
                            data-i18n-placeholder="placeholderDescShort" placeholder="No que voce esta pensando?"
                            required style="flex:1;">
                    </div>

                    <!-- Favorite -->
                    <label class="favorite-row">
                        <input type="checkbox" id="transactionFavorite">
                        <span class="toggle-slider"></span>
                        <span style="font-size:0.9rem;font-weight:500;">&#11088; <span
                                data-i18n="favoriteTransaction">Favoritar esta transao</span></span>
                    </label>

                    <!-- Save Button -->
                    <button type="button" class="btn-save-transaction" id="btnSaveTransaction"
                        onclick="saveNewTransaction()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <polyline points="20,6 9,17 4,12" />
                        </svg>
                        <span data-i18n="saveTransaction">Salvar Transacao</span>
                    </button>
                </form>
            </div>
            <div class="card">
                <h3 class="mb-2" data-i18n="dailyTransactions">Transacoes do Dia Selecionado</h3>
                <div class="stats-grid mb-2">
                    <div class="stat-card income">
                        <div class="stat-icon">&#128176;</div>
                        <div class="stat-value" id="dailyIncome">R$ 0,00</div>
                        <div class="stat-label" data-i18n="gains">Ganhos</div>
                    </div>
                    <div class="stat-card expense">
                        <div class="stat-icon">&#128184;</div>
                        <div class="stat-value" id="dailyExpense">R$ 0,00</div>
                        <div class="stat-label" data-i18n="spending">Gastos</div>
                    </div>
                    <div class="stat-card balance">
                        <div class="stat-icon">&#128202;</div>
                        <div class="stat-value" id="dailyBalance">R$ 0,00</div>
                        <div class="stat-label" data-i18n="balance">Saldo</div>
                    </div>
                </div>
                <div id="dailyTransactionsList"></div>
            </div>
        </div>

        <!-- Charts Tab -->
        <div id="charts" class="tab-content">
            <div class="card">
                <h2 class="mb-2" data-i18n="chartsTitle">Graficos de Receitas e Despesas</h2>
                <div class="chart-filters">
                    <div class="form-group"><label class="form-label" data-i18n="period">Periodo</label>
                        <select id="chartPeriod" class="form-select"
                            onchange="toggleChartPeriodInputs();updateChart();">
                            <option value="month" data-i18n="monthSpecific">Mes especifico</option>
                            <option value="week" data-i18n="weekSpecific">Semana especifica</option>
                            <option value="year" data-i18n="yearSpecific">Ano especifico</option>
                            <option value="last3" data-i18n="last3Months">Ultimos 3 meses</option>
                            <option value="last6" data-i18n="last6Months">Ultimos 6 meses</option>
                        </select>
                    </div>
                    <div class="form-group chart-period-input" id="chartMonthGroup"><label class="form-label"
                            data-i18n="month">Mes</label><input type="month" id="chartMonth" class="form-input"
                            onchange="updateChart()"></div>
                    <div class="form-group chart-period-input" id="chartWeekGroup" style="display:none;"><label
                            class="form-label" data-i18n="week">Semana</label><input type="week" id="chartWeek"
                            class="form-input" onchange="updateChart()"></div>
                    <div class="form-group chart-period-input" id="chartYearGroup" style="display:none;"><label
                            class="form-label" data-i18n="year">Ano</label><input type="number" id="chartYear"
                            class="form-input" min="2020" max="2030" onchange="updateChart()"></div>
                    <div class="form-group"><label class="form-label" data-i18n="view">Visualizar</label>
                        <select id="chartTypeFilter" class="form-select" onchange="updateChart()">
                            <option value="both" data-i18n="incomeExpense">Receitas e Despesas</option>
                            <option value="expense" data-i18n="expenseOnly">Apenas Despesas</option>
                            <option value="income" data-i18n="incomeOnly">Apenas Receitas</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label" data-i18n="chartType">Tipo de grafico</label>
                        <div class="chart-type-toggle">
                            <button type="button" class="chart-type-btn active" data-type="pie"
                                onclick="setChartType('pie')">&#129383; <span data-i18n="pie">Pizza</span></button>
                            <button type="button" class="chart-type-btn" data-type="bar"
                                onclick="setChartType('bar')">&#128202; <span data-i18n="bar">Barras</span></button>
                        </div>
                    </div>
                </div>
                <div class="chart-container-wrapper"><canvas id="financeChart"></canvas></div>
            </div>
        </div>

        <!-- Summaries Tab -->
        <div id="summaries" class="tab-content">
            <div class="summary-section">
                <div class="summary-header" onclick="toggleSummary('daily')">
                    <div class="summary-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg><span data-i18n="dailySummary">Resumo Diario</span></div><svg class="expand-icon"
                        width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6,9 12,15 18,9" />
                    </svg>
                </div>
                <div class="summary-content" id="dailySummaryContent">
                    <div class="summary-body">
                        <div class="form-group"><label class="form-label" data-i18n="selectDay">Selecionar
                                Dia</label><input type="date" id="dailySummaryDate" class="form-input"
                                onchange="updateDailySummary()"></div>
                        <div class="stats-grid mb-2">
                            <div class="stat-card income">
                                <div class="stat-value" id="dailySummaryIncome">R$ 0,00</div>
                                <div class="stat-label" data-i18n="gains">Ganhos</div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-value" id="dailySummaryExpense">R$ 0,00</div>
                                <div class="stat-label" data-i18n="spending">Gastos</div>
                            </div>
                            <div class="stat-card balance">
                                <div class="stat-value" id="dailySummaryBalance">R$ 0,00</div>
                                <div class="stat-label" data-i18n="balance">Saldo</div>
                            </div>
                        </div>
                        <div id="dailySummaryTransactions"></div>
                    </div>
                </div>
            </div>
            <div class="summary-section">
                <div class="summary-header" onclick="toggleSummary('weekly')">
                    <div class="summary-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10" />
                            <line x1="12" y1="20" x2="12" y2="4" />
                            <line x1="6" y1="20" x2="6" y2="14" />
                        </svg><span data-i18n="weeklySummary">Resumo Semanal</span></div><svg class="expand-icon"
                        width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6,9 12,15 18,9" />
                    </svg>
                </div>
                <div class="summary-content" id="weeklySummaryContent">
                    <div class="summary-body">
                        <div class="form-group"><label class="form-label" data-i18n="selectWeek">Selecionar
                                Semana</label><input type="week" id="weeklySummaryDate" class="form-input"
                                onchange="updateWeeklySummary()"></div>
                        <div class="stats-grid mb-2">
                            <div class="stat-card income">
                                <div class="stat-value" id="weeklySummaryIncome">R$ 0,00</div>
                                <div class="stat-label" data-i18n="gains">Ganhos</div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-value" id="weeklySummaryExpense">R$ 0,00</div>
                                <div class="stat-label" data-i18n="spending">Gastos</div>
                            </div>
                            <div class="stat-card balance">
                                <div class="stat-value" id="weeklySummaryBalance">R$ 0,00</div>
                                <div class="stat-label" data-i18n="balance">Saldo</div>
                            </div>
                        </div>
                        <div id="weeklySummaryTransactions"></div>
                    </div>
                </div>
            </div>
            <div class="summary-section">
                <div class="summary-header" onclick="toggleSummary('monthly')">
                    <div class="summary-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg><span data-i18n="monthlySummary">Resumo Mensal</span></div><svg class="expand-icon"
                        width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6,9 12,15 18,9" />
                    </svg>
                </div>
                <div class="summary-content" id="monthlySummaryContent">
                    <div class="summary-body">
                        <div class="form-group"><label class="form-label" data-i18n="selectMonth">Selecionar
                                Mes</label><input type="month" id="monthlySummaryDate" class="form-input"
                                onchange="updateMonthlySummary()"></div>
                        <div class="stats-grid mb-2">
                            <div class="stat-card income">
                                <div class="stat-value" id="monthlySummaryIncome">R$ 0,00</div>
                                <div class="stat-label" data-i18n="gains">Ganhos</div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-value" id="monthlySummaryExpense">R$ 0,00</div>
                                <div class="stat-label" data-i18n="spending">Gastos</div>
                            </div>
                            <div class="stat-card balance">
                                <div class="stat-value" id="monthlySummaryBalance">R$ 0,00</div>
                                <div class="stat-label" data-i18n="balance">Saldo</div>
                            </div>
                        </div>
                        <div id="monthlySummaryTransactions"></div>
                    </div>
                </div>
            </div>
            <div class="summary-section">
                <div class="summary-header" onclick="toggleSummary('yearly')">
                    <div class="summary-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10" />
                            <line x1="12" y1="20" x2="12" y2="4" />
                            <line x1="6" y1="20" x2="6" y2="14" />
                        </svg><span data-i18n="yearlySummary">Resumo Anual</span></div><svg class="expand-icon"
                        width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6,9 12,15 18,9" />
                    </svg>
                </div>
                <div class="summary-content" id="yearlySummaryContent">
                    <div class="summary-body">
                        <div class="form-group"><label class="form-label" data-i18n="selectYear">Selecionar
                                Ano</label><input type="number" id="yearlySummaryDate" class="form-input" min="2020"
                                max="2030" onchange="updateYearlySummary()"></div>
                        <div class="stats-grid mb-2">
                            <div class="stat-card income">
                                <div class="stat-value" id="yearlySummaryIncome">R$ 0,00</div>
                                <div class="stat-label" data-i18n="gains">Ganhos</div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-value" id="yearlySummaryExpense">R$ 0,00</div>
                                <div class="stat-label" data-i18n="spending">Gastos</div>
                            </div>
                            <div class="stat-card balance">
                                <div class="stat-value" id="yearlySummaryBalance">R$ 0,00</div>
                                <div class="stat-label" data-i18n="balance">Saldo</div>
                            </div>
                        </div>
                        <div id="yearlySummaryTransactions"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Goals Tab -->
        <div id="goals" class="tab-content">
            <div class="card">
                <div class="flex justify-between items-center mb-2">
                    <h2 data-i18n="financialGoals">Metas Financeiras</h2><button class="btn btn-primary"
                        onclick="showAddGoalModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg><span data-i18n="newGoal">Nova Meta</span></button>
                </div>
                <div id="goalsList"></div>
            </div>
        </div>

        <!-- Trash Tab -->
        <div id="trash" class="tab-content">
            <div class="card">
                <div class="flex justify-between items-center mb-2"><button type="button" class="btn btn-danger"
                        onclick="emptyTrash()" id="emptyTrashBtn" style="display:none;"><svg width="16" height="16"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3,6 5,6 21,6" />
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                        </svg><span data-i18n="emptyTrash">Esvaziar lixeira</span></button></div>
                <p class="mb-2" style="opacity:0.6;font-size:0.85rem;" data-i18n="trashInfo">Transacoes excluidas podem
                    ser restauradas ou removidas permanentemente.</p>
                <div id="trashList"></div>
            </div>
        </div>

        <!-- Backup Tab -->
        <div id="backup" class="tab-content">
            <div class="card">
                <h2 class="mb-2" data-i18n="backupExport">Backup e Exportacao</h2>
                <div class="backup-grid">
                    <button class="backup-btn backup-btn-export" onclick="exportData()">
                        <div class="backup-btn-icon">&#128228;</div><span data-i18n="exportJson">Exportar JSON</span>
                    </button>
                    <button class="backup-btn backup-btn-import"
                        onclick="document.getElementById('importFile').click()">
                        <div class="backup-btn-icon">&#128229;</div><span data-i18n="importJson">Importar JSON</span>
                    </button>
                    <button class="backup-btn backup-btn-excel" onclick="showExportExcelModal()">
                        <div class="backup-btn-icon">&#128202;</div><span data-i18n="exportExcel">Exportar Excel</span>
                    </button>
                    <button class="backup-btn backup-btn-clear" onclick="clearAllData()">
                        <div class="backup-btn-icon">&#128465;</div><span data-i18n="clearAll">Limpar Tudo</span>
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
            </div>
        </div>
    </main>

    <!-- Edit Transaction Modal -->
    <div class="modal-overlay" id="editTransactionModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="editTransaction">Editar Transacao</h3><button class="modal-close"
                    onclick="closeModal('editTransactionModal')">&times;</button>
            </div>
            <form id="editTransactionForm">
                <div class="form-group"><label class="form-label" data-i18n="date">Data</label><input type="date"
                        id="editTransactionDate" class="form-input" required></div>
                <div class="form-group"><label class="form-label" data-i18n="value">Valor (R$)</label><input
                        type="number" id="editTransactionValue" class="form-input" step="0.01" min="0" max="999999.99"
                        required></div>
                <div class="form-group"><label class="form-label" data-i18n="category">Categoria</label>
                    <select id="editTransactionCategory" class="form-select" required>
                        <option value="">Selecione uma categoria</option>
                        <option value="alimentacao">&#127869; Alimentacao</option>
                        <option value="mercado">&#128722; Mercado</option>
                        <option value="combustivel">&#9981; Combustivel</option>
                        <option value="manutencao_veiculo">&#128295; Manutencao Veiculo</option>
                        <option value="transporte">&#128663; Transporte</option>
                        <option value="moradia">&#127968; Moradia</option>
                        <option value="saude">&#127973; Saude</option>
                        <option value="educacao">&#128218; Educacao</option>
                        <option value="lazer">&#127918; Lazer</option>
                        <option value="salario">&#128188; Salario</option>
                        <option value="freelance">&#128187; Freelance</option>
                        <option value="investimentos">&#128200; Investimentos</option>
                        <option value="outros">&#128230; Outros</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label" data-i18n="description">Descricao</label><textarea
                        id="editTransactionDescription" class="form-textarea" required></textarea></div>
                <div class="form-group form-group-checkbox"><label class="form-label form-label-checkbox"><input
                            type="checkbox" id="editTransactionFavorite"> &#11088; <span
                            data-i18n="favoriteTransaction">Favoritar esta transacao</span></label></div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" onclick="saveTransactionEdit()"><svg width="16"
                            height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                            <polyline points="17,21 17,13 7,13 7,21" />
                            <polyline points="7,3 7,8 15,8" />
                        </svg><span data-i18n="save">Salvar</span></button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editTransactionModal')"><span
                            data-i18n="cancel">Cancelar</span></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Goal Modal -->
    <div class="modal-overlay" id="addGoalModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="addGoal">Nova Meta</h3><button class="modal-close"
                    onclick="closeModal('addGoalModal')">&times;</button>
            </div>
            <form id="addGoalForm">
                <div class="form-group"><label class="form-label" data-i18n="goalDescription">Descricao da
                        Meta</label><input type="text" id="goalDescription" class="form-input"
                        data-i18n-placeholder="goalPlaceholder" placeholder="Ex: Comprar um carro" required></div>
                <div class="form-group"><label class="form-label" data-i18n="goalTarget">Valor da Meta
                        (R$)</label><input type="number" id="goalTarget" class="form-input" step="0.01" min="0"
                        placeholder="0,00" required></div>
                <div class="form-group"><label class="form-label" data-i18n="goalCurrent">Valor Atual (R$)</label><input
                        type="number" id="goalCurrent" class="form-input" step="0.01" min="0" placeholder="0,00"
                        value="0"></div>
                <div class="btn-group"><button type="button" class="btn btn-primary" onclick="addGoal()"><svg width="16"
                            height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                            <polyline points="17,21 17,13 7,13 7,21" />
                            <polyline points="7,3 7,8 15,8" />
                        </svg><span data-i18n="saveGoal">Salvar Meta</span></button><button type="button"
                        class="btn btn-secondary" onclick="closeModal('addGoalModal')"><span
                            data-i18n="cancel">Cancelar</span></button></div>
            </form>
        </div>
    </div>

    <!-- Edit Goal Modal -->
    <div class="modal-overlay" id="editGoalModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="editGoal">Editar Meta</h3><button class="modal-close"
                    onclick="closeModal('editGoalModal')">&times;</button>
            </div>
            <form id="editGoalForm">
                <div class="form-group"><label class="form-label" data-i18n="goalDescription">Descricao da
                        Meta</label><input type="text" id="editGoalDescription" class="form-input" required></div>
                <div class="form-group"><label class="form-label" data-i18n="goalTarget">Valor da Meta
                        (R$)</label><input type="number" id="editGoalTarget" class="form-input" step="0.01" min="0"
                        required></div>
                <div class="form-group"><label class="form-label" data-i18n="goalCurrent">Valor Atual (R$)</label><input
                        type="number" id="editGoalCurrent" class="form-input" step="0.01" min="0"></div>
                <div class="btn-group"><button type="button" class="btn btn-primary" onclick="saveGoalEdit()"><svg
                            width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                            <polyline points="17,21 17,13 7,13 7,21" />
                            <polyline points="7,3 7,8 15,8" />
                        </svg><span data-i18n="save">Salvar</span></button><button type="button"
                        class="btn btn-secondary" onclick="closeModal('editGoalModal')"><span
                            data-i18n="cancel">Cancelar</span></button></div>
            </form>
        </div>
    </div>

    <!-- Month Picker Modal -->
    <div class="modal-overlay" id="monthPickerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="selectMonth">Selecionar Mes</h3><button class="modal-close"
                    onclick="closeMonthPickerModal()">&times;</button>
            </div>
            <div class="month-picker-container" id="monthPickerContainer">
                <div class="month-picker-header"><span class="month-picker-year" id="monthPickerYear">2026</span>
                    <div class="month-picker-nav"><button type="button" class="month-picker-nav-btn"
                            onclick="changeMonthPickerYear(1)">&#9650;</button><button type="button"
                            class="month-picker-nav-btn" onclick="changeMonthPickerYear(-1)">&#9660;</button></div>
                </div>
                <div class="month-picker-grid" id="monthPickerGrid"></div>
                <div class="month-picker-grid" id="monthPickerGridOtherYear" style="opacity:0.4;"></div>
            </div>
        </div>
    </div>

    <!-- Export Excel Modal -->
    <div class="modal-overlay" id="exportExcelModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="exportToExcel">Exportar para Excel</h3><button class="modal-close"
                    onclick="closeModal('exportExcelModal')">&times;</button>
            </div>
            <form id="exportExcelForm">
                <div class="form-group"><label class="form-label" data-i18n="period">Periodo</label><select
                        id="exportPeriod" class="form-select" onchange="updateExportDateField()">
                        <option value="all" data-i18n="allRecords">Todos os registros</option>
                        <option value="month" data-i18n="monthSpecific">Mes especifico</option>
                        <option value="year" data-i18n="yearSpecific">Ano especifico</option>
                    </select></div>
                <div class="form-group" id="exportDateGroup" style="display:none;"><label class="form-label"
                        id="exportDateLabel" data-i18n="date">Data</label><input type="month" id="exportDate"
                        class="form-input"></div>
                <div class="form-group"><label class="form-label" data-i18n="category">Categoria</label>
                    <select id="exportCategory" class="form-select">
                        <option value="all" data-i18n="allCategories">Todas as categorias</option>
                        <option value="income" data-i18n="onlyIncome">Apenas ganhos</option>
                        <option value="expense" data-i18n="onlyExpense">Apenas gastos</option>
                        <option value="alimentacao">&#127869; Alimentacao</option>
                        <option value="mercado">&#128722; Mercado</option>
                        <option value="combustivel">&#9981; Combustivel</option>
                        <option value="manutencao_veiculo">&#128295; Manutencao Veiculo</option>
                        <option value="transporte">&#128663; Transporte</option>
                        <option value="moradia">&#127968; Moradia</option>
                        <option value="saude">&#127973; Saude</option>
                        <option value="educacao">&#128218; Educacao</option>
                        <option value="lazer">&#127918; Lazer</option>
                        <option value="salario">&#128188; Salario</option>
                        <option value="freelance">&#128187; Freelance</option>
                        <option value="investimentos">&#128200; Investimentos</option>
                        <option value="outros">&#128230; Outros</option>
                    </select>
                </div>
                <div class="btn-group"><button type="button" class="btn btn-success"
                        onclick="exportFilteredToExcel()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7,10 12,15 17,10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg><span data-i18n="exportExcel">Exportar Excel</span></button><button type="button"
                        class="btn btn-secondary" onclick="closeModal('exportExcelModal')"><span
                            data-i18n="cancel">Cancelar</span></button></div>
            </form>
        </div>
    </div>

    <!-- Floating Calculator -->
    <button class="floating-calc-btn" onclick="toggleCalculator()" title="Calculadora">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="4" y="2" width="16" height="20" rx="2" ry="2" />
            <line x1="8" y1="6" x2="16" y2="6" />
            <line x1="8" y1="10" x2="8" y2="10.01" />
            <line x1="12" y1="10" x2="12" y2="10.01" />
            <line x1="16" y1="10" x2="16" y2="10.01" />
            <line x1="8" y1="14" x2="8" y2="14.01" />
            <line x1="12" y1="14" x2="12" y2="14.01" />
            <line x1="16" y1="14" x2="16" y2="14.01" />
            <line x1="8" y1="18" x2="8" y2="18.01" />
            <line x1="12" y1="18" x2="12" y2="18.01" />
            <line x1="16" y1="18" x2="16" y2="18.01" />
        </svg>
    </button>

    <!-- Calculator Overlay -->
    <div class="calc-overlay" id="calcOverlay" onclick="if(event.target===this) toggleCalculator()">
        <div class="calc-window" onclick="event.stopPropagation()">
            <input type="text" class="calc-display" id="calcDisplay" readonly value="0">
            <div class="calc-buttons">
                <button type="button" class="calc-btn clear" onclick="calcClear()">C</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('\u00B1')">&#177;</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('%')">%</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('/')">/</button>
                <button type="button" class="calc-btn" onclick="calcInput('7')">7</button>
                <button type="button" class="calc-btn" onclick="calcInput('8')">8</button>
                <button type="button" class="calc-btn" onclick="calcInput('9')">9</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('*')">&#215;</button>
                <button type="button" class="calc-btn" onclick="calcInput('4')">4</button>
                <button type="button" class="calc-btn" onclick="calcInput('5')">5</button>
                <button type="button" class="calc-btn" onclick="calcInput('6')">6</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('-')">&#8722;</button>
                <button type="button" class="calc-btn" onclick="calcInput('1')">1</button>
                <button type="button" class="calc-btn" onclick="calcInput('2')">2</button>
                <button type="button" class="calc-btn" onclick="calcInput('3')">3</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('+')">+</button>
                <button type="button" class="calc-btn zero" onclick="calcInput('0')">0</button>
                <button type="button" class="calc-btn" onclick="calcInput('.')">.</button>
                <button type="button" class="calc-btn equals" onclick="calcEquals()">=</button>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div class="notifications" id="notifications"></div>

    <script>
        // Firebase Configuration (Placeholder - User needs to fill this)
        const firebaseConfig = {
            apiKey: "AIzaSyAk_IhHTEBGrqucA6bADbFDTbTd2sN2yvk",
            authDomain: "financial-control-467b0.firebaseapp.com",
            projectId: "financial-control-467b0",
            storageBucket: "financial-control-467b0.firebasestorage.app",
            messagingSenderId: "543373005822",
            appId: "1:543373005822:web:a3ea667011ea86657226af"
        };

        // Initialize Firebase
        try {
            console.log("Inicializando Firebase...");
            if (window.location.protocol === 'file:') {
                console.warn("AVISO: Usar o protocolo 'file://' pode impedir o funcionamento correto do login com Google (Pop-ups). Recomenda-se usar um servidor local (ex: Live Server).");
            }
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase inicializado com sucesso.");
        } catch (e) {
            console.error("Erro ao inicializar Firebase:", e);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.setCustomParameters({ prompt: 'select_account' });

        // Handle redirect result
        auth.getRedirectResult().then((result) => {
            if (result.user) {
                console.log("Login via redirect bem-sucedido:", result.user.displayName);
            }
        }).catch((error) => {
            console.error("Erro no resultado do redirect:", error);
            showNotification("Erro na autenticao: " + error.message, "error");
        });

        console.log("Auth e Firestore configurados.");

        let currentUser = null;
        let transactions = []; let goals = []; let editingTransactionId = null; let editingGoalId = null; let lastSearchResults = []; let financeChartInstance = null; let currentChartType = 'pie';
        let lastBackupDate = localStorage.getItem('lastBackupDate') || '';

        // Auth State Listener
        auth.onAuthStateChanged((user) => {
            console.log("Estado de autenticao alterado:", user ? "Logado" : "Deslogado");
            const loginOverlay = document.getElementById('loginOverlay');
            const splashScreen = document.getElementById('splashScreen');

            if (user) {
                currentUser = user;
                console.log("Usurio logado:", user.displayName, user.email);

                const up = document.getElementById('userProfile');
                const ua = document.getElementById('userAvatar');
                const un = document.getElementById('userName');
                const ue = document.getElementById('userEmail');

                if (up && ua && un && ue) {
                    ua.src = user.photoURL || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';
                    un.textContent = user.displayName || 'Usurio';
                    ue.textContent = user.email || '';
                    up.style.display = 'flex';
                }

                if (loginOverlay) loginOverlay.style.display = 'none';

                // INICIA LISTENERS FIRESTORE
                setupFirestoreListeners(user);
            } else {
                currentUser = null;
                // LIMPA DADOS E PARA LISTENERS
                if (unsubscribeTransactions) unsubscribeTransactions();
                if (unsubscribeGoals) unsubscribeGoals();

                transactions = [];
                goals = [];

                const up = document.getElementById('userProfile');
                if (up) up.style.display = 'none';

                if (splashScreen && splashScreen.classList.contains('hidden')) {
                    if (loginOverlay) loginOverlay.style.display = 'flex';
                }
                updateAllViews();
            }
        });

        function loginWithGoogle() {
            console.log("Tentativa de login iniciada...");
            const btn = document.getElementById('googleLoginBtn');
            const loader = document.getElementById('loginLoader');

            if (!auth || !googleProvider) {
                console.error("Firebase Auth no est configurado corretamente.");
                showNotification("Erro interno de configurao", "error");
                return;
            }

            btn.style.display = 'none';
            loader.style.display = 'block';

            // Primeiro tentamos o Popup
            auth.signInWithPopup(googleProvider).then((result) => {
                console.log("Login realizado com sucesso (Popup) para:", result.user.displayName);
                loader.style.display = 'none';
                btn.style.display = 'flex';
            }).catch((error) => {
                console.error("Erro detalhado no login (Popup):", error);

                // Se o popup falhar ou for bloqueado, tentamos o Redirect como fallback
                if (error.code === 'auth/popup-blocked' || error.code === 'auth/cancelled-popup-request') {
                    console.log("Popup bloqueado ou falhou. Tentando Redirect...");
                    auth.signInWithRedirect(googleProvider);
                    return;
                }

                let errorMsg = "Erro ao entrar com Google";
                if (error.code === 'auth/unauthorized-domain') {
                    errorMsg = "Domnio no autorizado. Adicione 'localhost' no Firebase Console.";
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMsg = "Janela de login fechada pelo usurio";
                }

                showNotification(errorMsg, "error");
                btn.style.display = 'flex';
                loader.style.display = 'none';
            });
        }

        function logout() {
            if (confirm("Deseja realmente sair?")) {
                auth.signOut().then(() => {
                    if (unsubscribeTransactions) unsubscribeTransactions();
                    if (unsubscribeGoals) unsubscribeGoals();
                    transactions = [];
                    goals = [];
                    updateAllViews();
                    showNotification("Voc saiu da conta", "info");
                });
            }
        }

        // ==================== FIRESTORE REAL-TIME PERSISTENCE ====================
        let unsubscribeTransactions = null;
        let unsubscribeGoals = null;

        function setupFirestoreListeners(user) {
            if (!user) return;
            // Transaes
            unsubscribeTransactions = db.collection('transactions')
                .where('userId', '==', user.uid)
                .onSnapshot(snapshot => {
                    transactions = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    updateAllViews();
                    performSearch(); // Atualiza busca se estiver ativa
                }, error => {
                    console.error("Erro no listener de transaes:", error);
                    showNotification("Erro de conexo com o banco de dados", "error");
                });

            // Metas
            unsubscribeGoals = db.collection('goals')
                .where('userId', '==', user.uid)
                .onSnapshot(snapshot => {
                    goals = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    updateGoalsList();
                }, error => {
                    console.error("Erro no listener de metas:", error);
                });
        }

        // Garantir que apenas dados do usurio atual estejam nos arrays
        function ensureUserDataIsolation() {
            if (!currentUser) {
                transactions = [];
                goals = [];
                return;
            }

            // Filtrar foradamente qualquer transao que no seja do usurio atual
            transactions = transactions.filter(t => t.userId === currentUser.uid);
            goals = goals.filter(g => g.userId === currentUser.uid);
        }

        // Atualizar todas as views e garantir isolamento
        function updateAllViews() {
            ensureUserDataIsolation();

            // Atualizar lista de transaes se existir
            if (typeof updateTransactionsList === 'function') {
                updateTransactionsList();
            }

            // Atualizar lista de goals se existir
            if (typeof updateGoalsList === 'function') {
                updateGoalsList();
            }

            // Atualizar resumo dirio se existir
            if (typeof updateDailySummary === 'function') {
                updateDailySummary();
            }

            // Atualizar daily transactions se existir
            if (typeof updateDailyTransactions === 'function') {
                updateDailyTransactions();
            }
        }
        window.updateAllViews = updateAllViews;
        var trashStorageKey = 'financialTrash_v2';
        function getTrashFromStorage() { try { var r = localStorage.getItem(trashStorageKey); return r ? JSON.parse(r) : []; } catch (e) { return []; } }
        function saveTrashToStorage(a) { try { localStorage.setItem(trashStorageKey, JSON.stringify(a)); } catch (e) { } }
        function getActiveTransactions() { return transactions.filter(function (t) { return !t.deleted; }); }
        function getTrashTransactions() { var fs = getTrashFromStorage(); var fm = transactions.filter(function (t) { return t.deleted === true || t.deleted === 'true' || t.deleted === 1; }); var seen = {}; var out = []; fs.forEach(function (t) { var k = String(t.id); if (!seen[k]) { seen[k] = true; out.push(t); } }); fm.forEach(function (t) { var k = String(t.id); if (!seen[k]) { seen[k] = true; out.push(t); } }); return out; }

        const categories = { 'alimentacao': '\u{1F37D}\uFE0F Alimenta\u00E7\u00E3o', 'mercado': '\u{1F6D2} Mercado', 'combustivel': '\u26FD Combust\u00EDvel', 'manutencao_veiculo': '\u{1F527} Manuten\u00E7\u00E3o Ve\u00EDculo', 'transporte': '\u{1F697} Transporte', 'moradia': '\u{1F3E0} Moradia', 'saude': '\u{1F3E5} Sa\u00FAde', 'educacao': '\u{1F4DA} Educa\u00E7\u00E3o', 'lazer': '\u{1F3AE} Lazer', 'salario': '\u{1F4BC} Sal\u00E1rio', 'freelance': '\u{1F4BB} Freelance', 'investimentos': '\u{1F4C8} Investimentos', 'outros': '\u{1F4E6} Outros' };
        const categoryOrder = ['alimentacao', 'mercado', 'combustivel', 'manutencao_veiculo', 'transporte', 'moradia', 'saude', 'educacao', 'lazer', 'salario', 'freelance', 'investimentos', 'outros'];
        function getCategoryLabel(cat) { const lang = currentLang || localStorage.getItem('lang') || 'pt-BR'; return lang === 'en' ? (categoriesEn[cat] || categories[cat]) : (categories[cat] || cat); }
        const categoriesEn = { 'alimentacao': '\u{1F37D}\uFE0F Food', 'mercado': '\u{1F6D2} Groceries', 'combustivel': '\u26FD Fuel', 'manutencao_veiculo': '\u{1F527} Vehicle Maintenance', 'transporte': '\u{1F697} Transport', 'moradia': '\u{1F3E0} Housing', 'saude': '\u{1F3E5} Health', 'educacao': '\u{1F4DA} Education', 'lazer': '\u{1F3AE} Entertainment', 'salario': '\u{1F4BC} Salary', 'freelance': '\u{1F4BB} Freelance', 'investimentos': '\u{1F4C8} Investments', 'outros': '\u{1F4E6} Other' };

        const i18n = {
            'pt-BR': {
                logout: 'Sair', pageTitle: 'Controle Financeiro Aprimorado', appTitle: 'Finan\u00E7as', saveTransaction: 'Salvar Transa\u00E7\u00E3o', placeholderDescShort: 'No que voc\u00EA est\u00E1 pensando?', menuNewTransaction: 'Nova Transa\u00E7\u00E3o', menuTransactions: 'Transa\u00E7\u00F5es', menuSearch: 'Buscar', menuCharts: 'Gr\u00E1fico', menuSummaries: 'Resumos', menuGoals: 'Metas', menuTrash: 'Lixeira', menuBackup: 'Backup', menu: 'Menu', allTransactions: 'Todas as Transa\u00E7\u00F5es', searchTransactions: 'Buscar Transa\u00E7\u00F5es', searchByName: 'Buscar por nome/descri\u00E7\u00E3o', category: 'Categoria', type: 'Tipo', monthYear: 'M\u00EAs/Ano', allCategories: 'Todas as categorias', allTypes: 'Todos os tipos', income: 'Receita', expense: 'Despesa', favoritesOnly: 'Apenas favoritas', search: 'Buscar', clearFilters: 'Limpar Filtros', exportResults: 'Exportar Resultados', searchResults: 'Resultados da Busca', transactionsFound: 'transa\u00E7\u00F5es encontradas', searchIncome: 'Receitas na Busca', searchExpense: 'Despesas na Busca', searchBalance: 'Saldo da Busca', noTransactionsFound: 'Nenhuma transa\u00E7\u00E3o encontrada com os filtros aplicados', newTransaction: 'Nova Transa\u00E7\u00E3o', date: 'Data', value: 'Valor (R$)', description: 'Descri\u00E7\u00E3o', selectCategory: 'Selecione uma categoria', placeholderDesc: 'Descreva a transa\u00E7\u00E3o...', favoriteTransaction: 'Favoritar esta transa\u00E7\u00E3o', clear: 'Limpar', gains: 'Ganhos', spending: 'Gastos', balance: 'Saldo', dailyTransactions: 'Transa\u00E7\u00F5es do Dia Selecionado', chartsTitle: 'Gr\u00E1ficos de Receitas e Despesas', period: 'Per\u00EDodo', month: 'M\u00EAs', week: 'Semana', year: 'Ano', monthSpecific: 'M\u00EAs espec\u00EDfico', weekSpecific: 'Semana espec\u00EDfica', yearSpecific: 'Ano espec\u00EDfico', last3Months: '\u00DAltimos 3 meses', last6Months: '\u00DAltimos 6 meses', view: 'Visualizar', incomeExpense: 'Receitas e Despesas', expenseOnly: 'Apenas Despesas', incomeOnly: 'Apenas Receitas', chartType: 'Tipo de gr\u00E1fico', pie: 'Pizza', bar: 'Barras', dailySummary: 'Resumo Di\u00E1rio', weeklySummary: 'Resumo Semanal', monthlySummary: 'Resumo Mensal', yearlySummary: 'Resumo Anual', selectDay: 'Selecionar Dia', selectWeek: 'Selecionar Semana', selectMonth: 'Selecionar M\u00EAs', selectYear: 'Selecionar Ano', allMonths: 'Todos os meses', financialGoals: 'Metas Financeiras', newGoal: 'Nova Meta', emptyTrash: 'Esvaziar lixeira', trashInfo: 'Transa\u00E7\u00F5es exclu\u00EDdas podem ser restauradas ou removidas permanentemente.', backupExport: 'Backup e Exporta\u00E7\u00E3o', exportJson: 'Exportar JSON', importJson: 'Importar JSON', exportExcel: 'Exportar Excel', manualSync: 'Sincronizar na nuvem',
                editTransaction: 'Editar Transa\u00E7\u00E3o', save: 'Salvar', cancel: 'Cancelar', addGoal: 'Nova Meta', goalDescription: 'Descri\u00E7\u00E3o da Meta', goalTarget: 'Valor da Meta (R$)', goalCurrent: 'Valor Atual (R$)', saveGoal: 'Salvar Meta', editGoal: 'Editar Meta', exportToExcel: 'Exportar para Excel', allRecords: 'Todos os registros', onlyIncome: 'Apenas ganhos', onlyExpense: 'Apenas gastos', calculator: 'Calculadora', edit: 'Editar', delete: 'Excluir', deletePermanent: 'Excluir permanentemente', moveToTrash: 'Mover esta transa\u00E7\u00E3o para a lixeira?', movedToTrash: 'Transa\u00E7\u00E3o movida para a lixeira.', deletePermanentConfirm: 'Excluir permanentemente? Esta a\u00E7\u00E3o n\u00E3o pode ser desfeita.', trashEmpty: 'A lixeira j\u00E1 est\u00E1 vazia.', emptyTrashConfirm: 'Excluir permanentemente as', trashEmptyConfirm: 'transa\u00E7\u00F5es) da lixeira? Esta a\u00E7\u00E3o n\u00E3o pode ser desfeita.', trashEmptied: 'Lixeira esvaziada.', noTrash: 'Nenhuma transa\u00E7\u00E3o na lixeira', fillGoalFields: 'Por favor, preencha os campos da meta!', currentNotGreater: 'O valor atual n\u00E3o pode ser maior que a meta!', goalAdded: 'Meta adicionada!', goalEdited: 'Meta editada!', deleteGoalConfirm: 'Tem certeza que deseja excluir esta meta?', goalDeleted: 'Meta exclu\u00EDda!', noGoals: 'Nenhuma meta cadastrada', restore: 'Restaurar', saveError: 'Erro ao salvar dados!', goalPlaceholder: 'Ex: Comprar um carro', noExport: 'Nenhuma transa\u00E7\u00E3o para exportar!', fillAllFields: 'Por favor, preencha todos os campos!', transactionAdded: 'Transa\u00E7\u00E3o adicionada com sucesso!', transactionEdited: 'Transa\u00E7\u00E3o editada!', transactionRestored: 'Transa\u00E7\u00E3o restaurada!', transactionDeletedPerm: 'Transa\u00E7\u00E3o exclu\u00EDda permanentemente.', noTransactionsPeriod: 'Nenhuma transa\u00E7\u00E3o para este per\u00EDodo', noTransactionsDay: 'Nenhuma transa\u00E7\u00E3o para este dia', noTransactionsFilters: 'Nenhuma transa\u00E7\u00E3o encontrada com os filtros!', exportSuccess: 'Exportado para Excel com sucesso!', exportError: 'Erro ao exportar para Excel!', importConfirm: 'Importar este arquivo ir\u00E1 substituir todos os dados atuais. Deseja continuar?', importSuccess: 'Dados importados com sucesso!', clearConfirm: '\u26A0\uFE0F ATEN\u00C7\u00C3O: Esta a\u00E7\u00E3o ir\u00E1 apagar TODOS os dados. Deseja continuar?', allDataCleared: 'Todos os dados foram apagados!', backupExported: 'Backup JSON exportado!', backupExportError: 'Erro ao exportar o backup!', loadError: 'Erro ao carregar dados!', fillGoalCorrect: 'Preencha os campos corretamente!', noTransactionsFoundShort: 'Nenhuma transa\u00E7\u00E3o encontrada'
            }, 'en': {
                pageTitle: 'Financial Control - Enhanced', appTitle: 'Finances', saveTransaction: 'Save Transaction', placeholderDescShort: 'What are you thinking about?', menuNewTransaction: 'New Transaction', menuTransactions: 'Transactions', menuSearch: 'Search', menuCharts: 'Charts', menuSummaries: 'Summaries', menuGoals: 'Goals', menuTrash: 'Trash', menuBackup: 'Backup', menu: 'Menu', allTransactions: 'All Transactions', searchTransactions: 'Search Transactions', searchByName: 'Search by name/description', category: 'Category', type: 'Type', monthYear: 'Month/Year', allCategories: 'All categories', allTypes: 'All types', income: 'Income', expense: 'Expense', favoritesOnly: 'Favorites only', search: 'Search', clearFilters: 'Clear Filters', exportResults: 'Export Results', searchResults: 'Search Results', transactionsFound: 'transactions found', searchIncome: 'Search Income', searchExpense: 'Search Expense', searchBalance: 'Search Balance', noTransactionsFound: 'No transactions found with the applied filters', newTransaction: 'New Transaction', date: 'Date', value: 'Value ($)', description: 'Description', selectCategory: 'Select a category', placeholderDesc: 'Describe the transaction...', favoriteTransaction: 'Favorite this transaction', clear: 'Clear', gains: 'Gains', spending: 'Spending', balance: 'Balance', dailyTransactions: 'Selected Day Transactions', chartsTitle: 'Income and Expense Charts', period: 'Period', month: 'Month', week: 'Week', year: 'Year', monthSpecific: 'Specific month', weekSpecific: 'Specific week', yearSpecific: 'Specific year', last3Months: 'Last 3 months', last6Months: 'Last 6 months', view: 'View', incomeExpense: 'Income and Expenses', expenseOnly: 'Expenses only', incomeOnly: 'Income only', chartType: 'Chart type', logout: 'Logout', pie: 'Pie', bar: 'Bar', dailySummary: 'Daily Summary', weeklySummary: 'Weekly Summary', monthlySummary: 'Monthly Summary', yearlySummary: 'Yearly Summary', selectDay: 'Select Day', selectWeek: 'Select Week', selectMonth: 'Select Month', selectYear: 'Select Year', allMonths: 'All months', financialGoals: 'Financial Goals', newGoal: 'New Goal', emptyTrash: 'Empty Trash', trashInfo: 'Deleted transactions can be restored or permanently removed.', backupExport: 'Backup and Export', exportJson: 'Export JSON', importJson: 'Import JSON', exportExcel: 'Export Excel', manualSync: 'Sync to Cloud',
                editTransaction: 'Edit Transaction', save: 'Save', cancel: 'Cancel', addGoal: 'New Goal', goalDescription: 'Goal Description', goalTarget: 'Goal Value ($)', goalCurrent: 'Current Value ($)', saveGoal: 'Save Goal', editGoal: 'Edit Goal', exportToExcel: 'Export to Excel', allRecords: 'All records', onlyIncome: 'Income only', onlyExpense: 'Expenses only', calculator: 'Calculator', edit: 'Edit', delete: 'Delete', deletePermanent: 'Delete permanently', moveToTrash: 'Move this transaction to trash?', movedToTrash: 'Transaction moved to trash.', deletePermanentConfirm: 'Delete permanently? This action cannot be undone.', trashEmpty: 'Trash is already empty.', emptyTrashConfirm: 'Permanently delete the', trashEmptyConfirm: 'transaction(s) from trash? This action cannot be undone.', trashEmptied: 'Trash emptied.', noTrash: 'No transactions in trash', fillGoalFields: 'Please fill in the goal fields!', currentNotGreater: 'Current value cannot be greater than the goal!', goalAdded: 'Goal added!', goalEdited: 'Goal edited!', deleteGoalConfirm: 'Are you sure you want to delete this goal?', goalDeleted: 'Goal deleted!', noGoals: 'No goals registered', restore: 'Restore', saveError: 'Error saving data!', goalPlaceholder: 'E.g.: Buy a car', noExport: 'No transactions to export!', fillAllFields: 'Please fill in all fields!', transactionAdded: 'Transaction added successfully!', transactionEdited: 'Transaction edited!', transactionRestored: 'Transaction restored!', transactionDeletedPerm: 'Transaction permanently deleted.', noTransactionsPeriod: 'No transactions for this period', noTransactionsDay: 'No transactions for this day', noTransactionsFilters: 'No transactions found with the filters!', exportSuccess: 'Exported to Excel successfully!', exportError: 'Error exporting to Excel!', importConfirm: 'Importing this file will replace all current data. Continue?', importSuccess: 'Data imported successfully!', clearConfirm: '\u26A0\uFE0F WARNING: This will delete ALL data. Continue?', allDataCleared: 'All data has been cleared!', backupExported: 'JSON backup exported!', backupExportError: 'Error exporting backup!', loadError: 'Error loading data!', fillGoalCorrect: 'Fill in the fields correctly!', noTransactionsFoundShort: 'No transactions found'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'pt-BR';

        function toggleLanguage() {
            if (currentLang === 'pt-BR') {
                setLanguage('en');
            } else {
                setLanguage('pt-BR');
            }
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);

            // Update Single Button Icon: Show CURRENT language flag
            const btn = document.getElementById('langToggleBtn');
            if (btn) {
                if (lang === 'pt-BR') {
                    // Current is PT, show Brazil flag
                    btn.innerHTML = '<img src="https://flagcdn.com/w40/br.png" alt="Brazil Flag" style="width: 24px; height: 18px; border-radius: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">';
                    btn.title = "Idioma: Portugus";
                } else {
                    // Current is EN, show USA flag
                    btn.innerHTML = '<img src="https://flagcdn.com/w40/us.png" alt="USA Flag" style="width: 24px; height: 18px; border-radius: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">';
                    btn.title = "Language: English";
                }
            }

            applyTranslations(lang);
            updateClock();
        }
        function t(key) { const lang = currentLang || localStorage.getItem('lang') || 'pt-BR'; return (i18n[lang] && i18n[lang][key]) ? i18n[lang][key] : key; }
        function applyTranslations(lang) { document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (i18n[lang] && i18n[lang][key]) el.textContent = i18n[lang][key]; }); document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { const key = el.getAttribute('data-i18n-placeholder'); if (i18n[lang] && i18n[lang][key]) el.placeholder = i18n[lang][key]; }); document.querySelectorAll('[data-i18n-title]').forEach(el => { const key = el.getAttribute('data-i18n-title'); if (i18n[lang] && i18n[lang][key]) el.title = i18n[lang][key]; }); document.querySelectorAll('option[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (i18n[lang] && i18n[lang][key]) el.textContent = i18n[lang][key]; }); document.querySelectorAll('select#searchCategory option[value],select#transactionCategory option[value],select#editTransactionCategory option[value],select#exportCategory option[value]').forEach(opt => { if (opt.value && categoryOrder.includes(opt.value)) opt.textContent = getCategoryLabel(opt.value); }); document.title = i18n[lang] && i18n[lang].pageTitle ? i18n[lang].pageTitle : 'Controle Financeiro'; populateYearSelect(); updateMonthPickerButtonText(); updateAllViews(); updateTrashList(); performSearch(); }

        let clockIntervalId = null;
        function startClock() { updateClock(); if (clockIntervalId) clearInterval(clockIntervalId); clockIntervalId = setInterval(updateClock, 1000); }
        document.addEventListener('DOMContentLoaded', function () {
            applyTheme();
            var savedLang = localStorage.getItem('lang') || 'pt-BR';
            setLanguage(savedLang);
            startClock();
            setTimeout(function () {
                var s = document.getElementById('splashScreen');
                if (s) {
                    s.classList.add('hidden');
                    // After splash, if no user, show login overlay
                    if (!currentUser) {
                        document.getElementById('loginOverlay').style.display = 'flex';
                    }
                }
                updateClock();
            }, 1500);
            setCurrentDates();
            if (typeof updateDateDisplayText === 'function') updateDateDisplayText();
            populateYearSelect();
            initializeMonthPicker();
            updateAllViews();
            updateTrashList();
            performSearch();
        });
        window.addEventListener('load', updateClock);
        document.addEventListener('visibilitychange', function () { if (document.visibilityState === 'visible') { updateClock(); startClock(); } });

        function toggleTheme() {
            if (document.body.classList.contains('dark')) {
                setThemeLight();
            } else {
                setThemeDark();
            }
        }

        function setThemeDark() {
            document.body.classList.remove('light');
            document.body.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            updateThemeButtons();
            const chart = Chart.getChart("financeChart");
            if (chart) updateChart();
        }

        function setThemeLight() {
            document.body.classList.remove('dark');
            document.body.classList.add('light');
            localStorage.setItem('theme', 'light');
            updateThemeButtons();
            const chart = Chart.getChart("financeChart");
            if (chart) updateChart();
        }

        function updateThemeButtons() {
            const btn = document.getElementById('themeToggleBtn');
            if (!btn) return;

            if (document.body.classList.contains('dark')) {
                // Dark Mode: Show Moon Icon (indicating current state is dark) OR Sun icon to switch?
                // Request: "moon icon when dark mode active"
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" /></svg>';
                btn.title = "Alternar para Modo Claro";
            } else {
                // Light Mode: Show Sun Icon
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></svg>';
                btn.title = "Alternar para Modo Escuro";
            }
        }
        function updateClock() {
            var te = document.getElementById('clockTime');
            var de = document.getElementById('clockDate');
            if (!te || !de) return;
            var n = new Date();
            // REMOVIDO: checkScheduledBackup(); - funo no existe mais
            var lang = (typeof currentLang !== 'undefined' ? currentLang : null) || localStorage.getItem('lang') || 'pt-BR';
            var h = n.getHours();
            var m = n.getMinutes();
            var s = n.getSeconds();
            var d = n.getDate();
            var mo = n.getMonth();
            var y = n.getFullYear();
            var mS = m < 10 ? '0' + m : '' + m;
            var sS = s < 10 ? '0' + s : '' + s;
            var hS = h < 10 ? '0' + h : '' + h;
            var monthNamesPt = ['Janeiro', 'Fevereiro', 'Marco', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            var monthNamesEn = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            if (lang === 'en') {
                var ap = h >= 12 ? 'PM' : 'AM';
                var h12 = h % 12 || 12;
                te.textContent = h12 + ':' + mS;
                de.textContent = monthNamesEn[mo] + ' ' + d + ', ' + y;
            } else {
                te.textContent = hS + ':' + mS;
                de.textContent = d + ' de ' + monthNamesPt[mo] + ', ' + y;
            }
        }
        function applyTheme() {
            const st = localStorage.getItem('theme') || 'dark';
            const b = document.body;
            if (st === 'light') {
                b.classList.remove('dark');
                b.classList.add('light');
            } else {
                b.classList.remove('light');
                b.classList.add('dark');
            }
            updateThemeButtons();
        }

        function toggleMenu() { document.getElementById('menuOverlay').classList.add('active'); document.getElementById('sideMenu').classList.add('active'); }
        function closeMenu() { document.getElementById('menuOverlay').classList.remove('active'); document.getElementById('sideMenu').classList.remove('active'); }

        function showTab(tabName, el) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active')); document.getElementById(tabName).classList.add('active'); if (el) el.classList.add('active'); closeMenu(); if (tabName === 'new-transaction') updateDailyTransactions(); else if (tabName === 'search') { populateYearSelect(); updateMonthPickerButtonText(); performSearch(); } else if (tabName === 'trash') { updateTrashList(); setTimeout(updateTrashList, 50); } else if (tabName === 'charts') toggleChartPeriodInputs(); }

        function performSearch() { const sD = document.getElementById('searchDescription').value.toLowerCase(); const sC = document.getElementById('searchCategory').value; const sT = document.getElementById('searchType').value; const sY = document.getElementById('searchYear') ? document.getElementById('searchYear').value : ''; const sF = document.getElementById('searchFavorites').checked; const sMA = Array.from(selectedMonths).map(k => k.split('-')[1]); let f = getActiveTransactions().filter(tx => { if (sD && !tx.description.toLowerCase().includes(sD)) return false; if (sC && tx.category !== sC) return false; if (sT && tx.type !== sT) return false; if (sMA.length > 0 || sY) { const tY = tx.date.substring(0, 4); const tM = tx.date.substring(5, 7); if (sY && tY !== sY) return false; if (sMA.length > 0 && !sMA.includes(tM)) return false; } if (sF && !tx.favorite) return false; return true; }); f.sort((a, b) => new Date(b.date) - new Date(a.date)); lastSearchResults = f; updateSearchResults(f); }

        function updateSearchResults(f) { const l = document.getElementById('searchResultsList'); const c = document.getElementById('searchResultCount'); const tc = document.getElementById('searchTotalsCard'); c.textContent = `${f.length} ${t('transactionsFound')}`; if (f.length === 0) { l.innerHTML = '<div class="empty-state">' + t('noTransactionsFound') + '</div>'; tc.style.display = 'none'; return; } const inc = f.filter(x => x.type === 'income').reduce((s, x) => s + x.value, 0); const exp = f.filter(x => x.type === 'expense').reduce((s, x) => s + x.value, 0); const bal = inc - exp; document.getElementById('searchTotalIncome').textContent = formatCurrency(inc); document.getElementById('searchTotalExpense').textContent = formatCurrency(exp); document.getElementById('searchTotalBalance').textContent = formatCurrency(bal); tc.style.display = 'block'; const bd = {}; f.forEach(x => { if (!bd[x.date]) bd[x.date] = []; bd[x.date].push(x); }); const ds = Object.keys(bd).sort((a, b) => b.localeCompare(a)); l.innerHTML = '<div class="search-results-grouped">' + ds.map(d => `<div class="search-results-date-group"><div class="search-results-date-header">${formatDateForDisplay(d)}</div><div class="search-results-date-list">${bd[d].map(x => renderSearchResultCard(x)).join('')}</div></div>`).join('') + '</div>'; }

        function renderSearchResultCard(tx) {
            const fc = tx.favorite ? ' favorite-star favorited' : ' favorite-star';
            const fi = tx.favorite ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>` : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
            return `<div class="search-result-card">
                <button class="${fc}" onclick="toggleFavorite('${tx.id}');performSearch();" title="${tx.favorite ? 'Desfavoritar' : 'Favoritar'}">${fi}</button>
                <div class="transaction-info">
                    <div class="transaction-description">${escapeHtml(tx.description)}</div>
                    <div class="transaction-meta">${getCategoryLabel(tx.category)} \u2022 ${tx.type === 'income' ? t('income') : t('expense')}</div>
                </div>
                <div class="transaction-amount ${tx.type}">${tx.type === 'income' ? '+' : '-'}${formatCurrency(tx.value)}</div>
                <div class="transaction-actions">
                    <button class="action-btn edit" onclick="editTransaction('${tx.id}')" title="${t('edit')}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button class="action-btn delete" onclick="deleteTransaction('${tx.id}')" title="${t('delete')}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"/></svg></button>
                </div>
            </div>`;
        }

        function toggleFavorite(id) {
            const x = transactions.find(t => t.id === id);
            if (x) {
                db.collection('transactions').doc(id).update({
                    favorite: !x.favorite
                }).catch(err => console.error("Erro ao favoritar:", err));
            }
        }
        function clearSearch() { document.getElementById('searchDescription').value = ''; document.getElementById('searchCategory').value = ''; document.getElementById('searchType').value = ''; clearMonthSelection(); document.getElementById('searchYear').value = ''; document.getElementById('searchFavorites').checked = false; performSearch(); }
        function exportSearchResultsToExcel() { if (lastSearchResults.length === 0) { showNotification(t('noExport'), 'warning'); return; } exportToExcel(lastSearchResults, `busca-financeira-${getTodayInBrasiliaISO()}`); }

        function getTodayInBrasiliaISO() { const n = new Date(); const b = new Date(n.getTime() - 3 * 60 * 60 * 1000); return b.toISOString().split('T')[0]; }
        function getWeekRangeFromDate(inputDate) { const d = new Date(inputDate + 'T00:00:00Z'); const dow = d.getUTCDay(); const dowISO = dow === 0 ? 7 : dow; const s = new Date(d); s.setUTCDate(d.getUTCDate() - dowISO + 1); const e = new Date(s); e.setUTCDate(s.getUTCDate() + 6); return { start: s.toISOString().split('T')[0], end: e.toISOString().split('T')[0] }; }

        let monthPickerCurrentYear = new Date().getFullYear(); let selectedMonths = new Set();
        function initializeMonthPicker() { monthPickerCurrentYear = new Date().getFullYear(); selectedMonths.clear(); updateMonthPickerButtonText(); }
        function getMonthNames() { const m = { 'pt-BR': ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], 'en': ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] }; return m[currentLang || 'pt-BR'] || m['pt-BR']; }
        function renderMonthPicker() { const g = document.getElementById('monthPickerGrid'); const go = document.getElementById('monthPickerGridOtherYear'); const ye = document.getElementById('monthPickerYear'); if (!g || !go || !ye) return; ye.textContent = monthPickerCurrentYear; const mn = getMonthNames(); const oy = monthPickerCurrentYear + 1; g.innerHTML = ''; go.innerHTML = ''; mn.forEach((name, i) => { const mN = String(i + 1).padStart(2, '0'); const mK = `${monthPickerCurrentYear}-${mN}`; const iS = selectedMonths.has(mK); const btn = document.createElement('button'); btn.type = 'button'; btn.className = `month-picker-item ${iS ? 'selected' : ''}`; btn.textContent = name; btn.onclick = () => toggleMonthSelection(monthPickerCurrentYear, mN); g.appendChild(btn); }); mn.slice(0, 4).forEach((name, i) => { const mN = String(i + 1).padStart(2, '0'); const mK = `${oy}-${mN}`; const iS = selectedMonths.has(mK); const btn = document.createElement('button'); btn.type = 'button'; btn.className = `month-picker-item other-year ${iS ? 'selected' : ''}`; btn.textContent = name; btn.onclick = () => toggleMonthSelection(oy, mN); go.appendChild(btn); }); updateSelectedMonthsInput(); updateMonthPickerButtonText(); }
        function toggleMonthSelection(y, mN) { const mK = `${y}-${mN}`; if (selectedMonths.has(mK)) selectedMonths.delete(mK); else selectedMonths.add(mK); renderMonthPicker(); updateMonthPickerButtonText(); performSearch(); }
        function changeMonthPickerYear(d) { monthPickerCurrentYear += d; renderMonthPicker(); }
        function updateSelectedMonthsInput() { const inp = document.getElementById('selectedMonths'); if (inp) { const mv = Array.from(selectedMonths).map(k => k.split('-')[1]); inp.value = JSON.stringify(mv); } updateMonthPickerButtonText(); }
        function clearMonthSelection() { selectedMonths.clear(); renderMonthPicker(); updateMonthPickerButtonText(); }
        function updateMonthPickerButtonText() { const btn = document.getElementById('monthPickerButtonText'); if (!btn) return; if (selectedMonths.size === 0) { btn.textContent = currentLang === 'en' ? 'Select Month' : 'Selecionar M\u00EAs'; } else { const mn = getMonthNames(); const sv = Array.from(selectedMonths).map(k => { const p = k.split('-'); return mn[parseInt(p[1]) - 1]; }); if (sv.length <= 3) btn.textContent = sv.join(', '); else btn.textContent = `${sv.length} ${currentLang === 'en' ? 'months selected' : 'meses selecionados'}`; } }
        function showMonthPickerModal() { renderMonthPicker(); showModal('monthPickerModal'); }
        function closeMonthPickerModal() { closeModal('monthPickerModal'); }

        function populateYearSelect() { const ys = document.getElementById('searchYear'); if (!ys) return; const years = new Set(); transactions.forEach(t => { if (t.date && t.date.length >= 4) years.add(t.date.substring(0, 4)); }); const cy = new Date().getFullYear(); for (let y = 2020; y <= cy + 1; y++)years.add(String(y)); const sy = Array.from(years).sort((a, b) => parseInt(b) - parseInt(a)); const cv = ys.value; ys.innerHTML = '<option value="">' + (currentLang === 'en' ? 'All years' : 'Todos os anos') + '</option>'; sy.forEach(y => { const o = document.createElement('option'); o.value = y; o.textContent = y; ys.appendChild(o); }); if (cv && ys.querySelector(`option[value="${cv}"]`)) ys.value = cv; }

        function setCurrentDates() { const ti = getTodayInBrasiliaISO(); const td = new Date(ti + 'T00:00:00Z'); const y = td.getUTCFullYear(); const m = String(td.getUTCMonth() + 1).padStart(2, '0'); document.getElementById('transactionDate').value = ti; document.getElementById('dailySummaryDate').value = ti; document.getElementById('monthlySummaryDate').value = `${y}-${m}`; document.getElementById('yearlySummaryDate').value = y; const wi = document.getElementById('weeklySummaryDate'); const d = new Date(ti); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); const ys = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); const wn = Math.ceil((((d - ys) / 86400000) + 1) / 7); wi.value = `${y}-W${String(wn).padStart(2, '0')}`; }

        function addTransaction(type) {
            if (!currentUser) {
                showNotification("Faa login para salvar", "error");
                return;
            }
            const d = document.getElementById('transactionDate').value;
            const v = parseFloat(document.getElementById('transactionValue').value);
            const c = document.getElementById('transactionCategory').value;
            const desc = document.getElementById('transactionDescription').value.trim();
            const f = document.getElementById('transactionFavorite').checked;
            if (!d || !v || v <= 0 || !c || !desc) {
                showNotification(t('fillAllFields'), 'error');
                return;
            }

            // Add directly to Firestore
            db.collection('transactions').add({
                userId: currentUser.uid,
                type: type,
                date: d,
                value: v,
                category: c,
                description: desc,
                favorite: !!f,
                createdAt: new Date().toISOString(),
                deleted: false
            }).then(() => {
                showNotification(t('transactionAdded'), 'success');
                clearTransactionForm();
            }).catch(error => {
                console.error("Erro ao adicionar transao: ", error);
                showNotification("Erro ao salvar no servidor", "error");
            });
        }
        function clearTransactionForm() { document.getElementById('transactionValue').value = ''; document.getElementById('transactionCategory').value = ''; document.getElementById('transactionDescription').value = ''; document.getElementById('transactionDate').value = getTodayInBrasiliaISO(); document.getElementById('transactionFavorite').checked = false; setTransactionType('income'); if (typeof updateDateDisplayText === 'function') updateDateDisplayText(); }
        function editTransaction(id) { const tx = transactions.find(t => t.id === id); if (!tx) return; editingTransactionId = id; document.getElementById('editTransactionDate').value = tx.date; document.getElementById('editTransactionValue').value = tx.value; document.getElementById('editTransactionCategory').value = tx.category; document.getElementById('editTransactionDescription').value = tx.description; document.getElementById('editTransactionFavorite').checked = !!tx.favorite; showModal('editTransactionModal'); }
        function saveTransactionEdit() {
            const d = document.getElementById('editTransactionDate').value;
            const v = parseFloat(document.getElementById('editTransactionValue').value);
            const c = document.getElementById('editTransactionCategory').value;
            const desc = document.getElementById('editTransactionDescription').value.trim();
            const f = document.getElementById('editTransactionFavorite').checked;
            if (!d || !v || v <= 0 || !c || !desc) {
                showNotification(t('fillAllFields'), 'error');
                return;
            }

            db.collection('transactions').doc(editingTransactionId).update({
                date: d,
                value: v,
                category: c,
                description: desc,
                favorite: !!f,
                userId: currentUser.uid // Ensure userId is preserved/set
            }).then(() => {
                showNotification(t('transactionEdited'), 'success');
                closeModal('editTransactionModal');
            }).catch(error => {
                console.error("Erro ao editar: ", error);
                showNotification("Erro ao atualizar transao", "error");
            });
        }
        function deleteTransaction(id) {
            if (confirm(t('moveToTrash'))) {
                // Instead of moving to a separate array, we mark as deleted in Firestore
                // This assumes we filter out deleted=true in queries or views
                db.collection('transactions').doc(id).update({
                    deleted: true,
                    deletedAt: new Date().toISOString()
                }).then(() => {
                    showNotification(t('movedToTrash'), 'success');
                }).catch(error => {
                    console.error("Erro ao mover para lixeira: ", error);
                    showNotification("Erro ao excluir", "error");
                });
            }
        }
        function restoreTransaction(id) {
            if (!id) return;
            // Ensure ID is a string for Firestore
            const docId = String(id);
            console.log("Tentando restaurar transao:", docId);

            db.collection('transactions').doc(docId).update({
                deleted: false,
                deletedAt: null
            }).then(() => {
                showNotification(t('transactionRestored'), 'success');
                // Force update if listener doesn't catch it immediately (though it should)
            }).catch(error => {
                console.error("Erro ao restaurar transao:", error);
                showNotification("Erro ao restaurar item", "error");
            });
        }
        function deletePermanently(id) {
            if (confirm(t('deletePermanentConfirm'))) {
                db.collection('transactions').doc(id).delete()
                    .then(() => {
                        showNotification(t('transactionDeletedPerm'), 'warning');
                    }).catch(error => {
                        console.error("Erro ao excluir permanentemente: ", error);
                    });
            }
        }
        // emptyTrash logic might need update if we want to batch delete. For now, simple client implementation over Firestore data
        function emptyTrash() {
            const trashItems = getTrashTransactions();
            if (trashItems.length === 0) {
                showNotification(t('trashEmpty'), 'info');
                return;
            }
            if (confirm(t('emptyTrashConfirm') + ' ' + trashItems.length + ' ' + t('trashEmptyConfirm'))) {
                const batch = db.batch();
                trashItems.forEach(tx => {
                    const ref = db.collection('transactions').doc(tx.id);
                    batch.delete(ref);
                });
                batch.commit().then(() => {
                    showNotification(t('trashEmptied'), 'warning');
                }).catch(error => {
                    console.error("Erro ao esvaziar lixeira: ", error);
                    showNotification("Erro ao esvaziar lixeira", "error");
                });
            }
        }
        function updateTrashList() {
            var l = document.getElementById('trashList');
            var eb = document.getElementById('emptyTrashBtn');
            if (!l) return;
            var tr = getTrashTransactions();
            var s = tr.slice().sort(function (a, b) { return new Date(b.deletedAt || 0) - new Date(a.deletedAt || 0); });
            if (eb) eb.style.display = s.length > 0 ? '' : 'none';
            if (s.length === 0) {
                l.innerHTML = '<div class="empty-state">' + t('noTrash') + '</div>';
                return;
            }
            l.innerHTML = s.map(function (tx) {
                var dd = tx.deletedAt ? formatDateForDisplay(String(tx.deletedAt).split('T')[0]) : '';
                return '<div class="transaction-item">' +
                    '<div class="transaction-info">' +
                    '<div class="transaction-description">' + escapeHtml(tx.description || '') + '</div>' +
                    '<div class="transaction-meta">' + getCategoryLabel(tx.category) + ' \u2022 ' + formatDateForDisplay(tx.date) + (dd ? ' \u2022 ' + (currentLang === 'en' ? 'Deleted on ' : 'Exclu\u00EDda em ') + dd : '') + '</div>' +
                    '</div>' +
                    '<div class="transaction-amount ' + (tx.type || 'expense') + '">' + (tx.type === 'income' ? '+' : '-') + formatCurrency(tx.value) + '</div>' +
                    '<div class="transaction-actions">' +
                    '<button type="button" class="action-btn edit" onclick="restoreTransaction(\'' + tx.id + '\')" title="' + t('restore') + '"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><polyline points="3 3 3 8 8 8"/></svg></button>' +
                    '<button type="button" class="action-btn delete" onclick="deletePermanently(\'' + tx.id + '\')" title="' + t('deletePermanent') + '"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>' +
                    '</div></div>';
            }).join('');
        }

        function showAddGoalModal() { showModal('addGoalModal'); }
        function addGoal() {
            if (!currentUser) {
                showNotification("Faa login para salvar", "error");
                return;
            }
            const d = document.getElementById('goalDescription').value.trim();
            const tg = parseFloat(document.getElementById('goalTarget').value);
            const c = parseFloat(document.getElementById('goalCurrent').value) || 0;
            if (!d || !tg || tg <= 0) {
                showNotification(t('fillGoalFields'), 'error');
                return;
            }
            if (c > tg) {
                showNotification(t('currentNotGreater'), 'error');
                return;
            }

            db.collection('goals').add({
                userId: currentUser.uid,
                description: d,
                target: tg,
                current: c,
                order: goals.length,
                createdAt: new Date().toISOString()
            }).then(() => {
                showNotification(t('goalAdded'), 'success');
                closeModal('addGoalModal');
                document.getElementById('addGoalForm').reset();
            }).catch(error => {
                console.error("Erro ao adicionar meta: ", error);
            });
        }
        function editGoal(id) { const g = goals.find(g => g.id === id); if (!g) return; editingGoalId = id; document.getElementById('editGoalDescription').value = g.description; document.getElementById('editGoalTarget').value = g.target; document.getElementById('editGoalCurrent').value = g.current; showModal('editGoalModal'); }
        function saveGoalEdit() {
            const d = document.getElementById('editGoalDescription').value.trim();
            const tg = parseFloat(document.getElementById('editGoalTarget').value);
            const c = parseFloat(document.getElementById('editGoalCurrent').value) || 0;
            if (!d || !tg || tg <= 0) {
                showNotification(t('fillGoalCorrect'), 'error');
                return;
            }
            if (c > tg) {
                showNotification(t('currentNotGreater'), 'error');
                return;
            }

            db.collection('goals').doc(editingGoalId).update({
                description: d,
                target: tg,
                current: c,
                userId: currentUser.uid
            }).then(() => {
                showNotification(t('goalEdited'), 'success');
                closeModal('editGoalModal');
            }).catch(e => {
                console.error("Erro ao editar meta:", e);
                showNotification("Erro ao salvar meta", "error");
            });
        }
        function deleteGoal(id) {
            if (confirm(t('deleteGoalConfirm'))) {
                db.collection('goals').doc(id).delete()
                    .then(() => showNotification(t('goalDeleted'), 'success'))
                    .catch(e => console.error("Erro ao deletar:", e));
            }
        }
        function moveGoal(id, dir) {
            const sortedGoals = [...goals].sort((a, b) => (a.order || 0) - (b.order || 0));
            const i = sortedGoals.findIndex(g => g.id === id);
            const ni = i + dir;
            if (ni < 0 || ni >= sortedGoals.length) return;

            const goalA = sortedGoals[i];
            const goalB = sortedGoals[ni];

            const batch = db.batch();
            batch.update(db.collection('goals').doc(String(goalA.id)), { order: goalB.order });
            batch.update(db.collection('goals').doc(String(goalB.id)), { order: goalA.order });

            batch.commit().catch(e => console.error("Erro ao mover:", e));
        }

        function updateTransactionsList() { const l = document.getElementById('transactionsList'); const a = getActiveTransactions(); if (a.length === 0) { l.innerHTML = '<div class="empty-state">' + t('noTransactionsFoundShort') + '</div>'; return; } const s = [...a].sort((a, b) => new Date(b.date) - new Date(a.date)); l.innerHTML = s.map(tx => renderTransactionItem(tx)).join(''); }
        function updateGoalsList() {
            const l = document.getElementById('goalsList');
            if (goals.length === 0) {
                l.innerHTML = '<div class="empty-state">' + t('noGoals') + '</div>';
                return;
            }
            const s = [...goals].sort((a, b) => (a.order || 0) - (b.order || 0));
            l.innerHTML = s.map((g, i) => {
                const p = Math.min((g.current / g.target) * 100, 100);
                const r = Math.max(g.target - g.current, 0);
                l.innerHTML = s.map((g, i) => {
                    const p = Math.min((g.current / g.target) * 100, 100);
                    const r = Math.max(g.target - g.current, 0);
                    return `<div class="goal-item">
                    <div class="goal-header">
                        <div class="goal-info">
                            <h3>${escapeHtml(g.description)}</h3>
                            <div class="goal-values">${formatCurrency(g.current)} de ${formatCurrency(g.target)}</div>
                        </div>
                        <div class="goal-actions">
                            ${i > 0 ? `<button class="action-btn move-up" onclick="moveGoal('${g.id}',-1)" title="Mover para cima"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="18 15 12 9 6 15"/></svg></button>` : ''}
                            ${i < s.length - 1 ? `<button class="action-btn move-down" onclick="moveGoal('${g.id}',1)" title="Mover para baixo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="6 9 12 15 18 9"/></svg></button>` : ''}
                            <button class="action-btn edit" onclick="editGoal('${g.id}')" title="${t('edit')}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button class="action-btn delete" onclick="deleteGoal('${g.id}')" title="${t('delete')}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </div>
                    </div>
                    <div class="goal-progress">
                        <div class="progress-bar"><div class="progress-fill" style="width:${p}%"></div></div>
                        <div class="progress-text"><span>${p.toFixed(1)}% conclu\u00EDdo</span><span>Faltam ${formatCurrency(r)}</span></div>
                    </div>
                </div>`;
                }).join('');
            }).join('');
        }
        function updateDailyTransactions() { const sd = document.getElementById('transactionDate').value; const daily = getActiveTransactions().filter(t => t.date === sd); updateSummaryStats('daily', daily); const l = document.getElementById('dailyTransactionsList'); if (daily.length === 0) { l.innerHTML = '<div class="empty-state">' + t('noTransactionsDay') + '</div>'; return; } l.innerHTML = daily.map(tx => renderTransactionItem(tx)).join(''); }

        function toggleSummary(type) { const c = document.getElementById(type + 'SummaryContent'); const ic = c.previousElementSibling.querySelector('.expand-icon'); c.classList.toggle('expanded'); ic.classList.toggle('expanded'); }
        function updateDailySummary() { const d = document.getElementById('dailySummaryDate').value; if (!d) return; const daily = getActiveTransactions().filter(t => t.date === d); updateSummaryView('dailySummary', daily); }
        function updateWeeklySummary() { const wi = document.getElementById('weeklySummaryDate').value; if (!wi) return; const [yr, wn] = wi.split('-W'); if (!yr || !wn || isNaN(parseInt(wn, 10))) return; const fy = new Date(Date.UTC(parseInt(yr, 10), 0, 1)); const ds = (wn - 1) * 7; const sd = new Date(fy.getTime() + ds * 86400000); const dow = sd.getUTCDay(); const diff = sd.getUTCDate() - dow + (dow === 0 ? -6 : 1); const mon = new Date(sd.setUTCDate(diff)); const sun = new Date(mon); sun.setUTCDate(mon.getUTCDate() + 6); const ss = mon.toISOString().split('T')[0]; const es = sun.toISOString().split('T')[0]; const weekly = getActiveTransactions().filter(t => t.date >= ss && t.date <= es); updateSummaryView('weeklySummary', weekly); }
        function updateMonthlySummary() { const m = document.getElementById('monthlySummaryDate').value; if (!m) return; const monthly = getActiveTransactions().filter(t => t.date.startsWith(m)); updateSummaryView('monthlySummary', monthly); }
        function updateYearlySummary() { const y = document.getElementById('yearlySummaryDate').value; if (!y) return; const yearly = getActiveTransactions().filter(t => t.date.startsWith(y)); updateSummaryView('yearlySummary', yearly); }
        function updateSummaryView(pfx, list) { updateSummaryStats(pfx, list); const l = document.getElementById(pfx + 'Transactions'); if (list.length === 0) { l.innerHTML = '<div class="empty-state">' + t('noTransactionsPeriod') + '</div>'; return; } const s = [...list].sort((a, b) => new Date(b.date) - new Date(a.date)); l.innerHTML = s.map(tx => renderTransactionItem(tx)).join(''); }
        function updateSummaryStats(pfx, list) { const inc = list.filter(t => t.type === 'income').reduce((s, t) => s + t.value, 0); const exp = list.filter(t => t.type === 'expense').reduce((s, t) => s + t.value, 0); const bal = inc - exp; document.getElementById(pfx + 'Income').textContent = formatCurrency(inc); document.getElementById(pfx + 'Expense').textContent = formatCurrency(exp); document.getElementById(pfx + 'Balance').textContent = formatCurrency(bal); }

        function showExportExcelModal() { document.getElementById('exportExcelForm').reset(); document.getElementById('exportDateGroup').style.display = 'none'; showModal('exportExcelModal'); }
        function updateExportDateField() { const p = document.getElementById('exportPeriod').value; const dg = document.getElementById('exportDateGroup'); const di = document.getElementById('exportDate'); const dl = document.getElementById('exportDateLabel'); if (p === 'all') { dg.style.display = 'none'; } else { dg.style.display = 'block'; di.type = p === 'month' ? 'month' : 'number'; dl.textContent = p === 'month' ? t('month') : t('year'); if (p === 'year') { di.min = '2020'; di.max = '2030'; di.value = new Date().getFullYear(); } else { const n = new Date(); di.value = `${n.getFullYear()}-${String(n.getMonth() + 1).padStart(2, '0')}`; } } }
        function exportFilteredToExcel() { const p = document.getElementById('exportPeriod').value; const cf = document.getElementById('exportCategory').value; const dv = document.getElementById('exportDate').value; let f = [...getActiveTransactions()]; if (p === 'month' && dv) f = f.filter(t => t.date.startsWith(dv)); if (p === 'year' && dv) f = f.filter(t => t.date.startsWith(dv)); if (cf === 'income') f = f.filter(t => t.type === 'income'); else if (cf === 'expense') f = f.filter(t => t.type === 'expense'); else if (cf !== 'all') f = f.filter(t => t.category === cf); if (f.length === 0) { showNotification(t('noTransactionsFilters'), 'warning'); return; } exportToExcel(f, `relatorio-financeiro-${getTodayInBrasiliaISO()}`); closeModal('exportExcelModal'); }
        function exportToExcel(data, filename) { try { const cD = currentLang === 'en' ? 'Date' : 'Data'; const cT = currentLang === 'en' ? 'Type' : 'Tipo'; const cV = currentLang === 'en' ? 'Value' : 'Valor'; const cC = currentLang === 'en' ? 'Category' : 'Categoria'; const cDe = currentLang === 'en' ? 'Description' : 'Descri\u00E7\u00E3o'; const td = data.map(tx => ({ [cD]: formatDateForDisplay(tx.date), [cT]: tx.type === 'income' ? t('income') : t('expense'), [cV]: tx.value, [cC]: getCategoryLabel(tx.category), [cDe]: tx.description })); const ti = data.filter(t => t.type === 'income').reduce((s, t) => s + t.value, 0); const te = data.filter(t => t.type === 'expense').reduce((s, t) => s + t.value, 0); const sC = currentLang === 'en' ? 'Summary' : 'Resumo'; const sd = [{ [sC]: currentLang === 'en' ? 'Total Income' : 'Total de Receitas', [cV]: ti }, { [sC]: currentLang === 'en' ? 'Total Expenses' : 'Total de Despesas', [cV]: te }, { [sC]: currentLang === 'en' ? 'Balance' : 'Saldo', [cV]: ti - te }]; const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(td), currentLang === 'en' ? 'Transactions' : 'Transa\u00E7\u00F5es'); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sd), currentLang === 'en' ? 'Summary' : 'Resumo'); XLSX.writeFile(wb, `${filename}.xlsx`); showNotification(t('exportSuccess'), 'success'); } catch (e) { console.error('Erro:', e); showNotification(t('exportError'), 'error'); } }

        function formatCurrency(v) { const f = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0); return f.replace(/\u00A0/g, ''); }
        function escapeHtml(text) { if (text == null || typeof text !== 'string') return ''; const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
        function formatDateForDisplay(ds) { if (!ds || typeof ds !== 'string') return ''; const p = ds.split('-'); if (p.length !== 3) return ds; return `${p[2]}/${p[1]}/${p[0]}`; }
        function renderTransactionItem(tx) {
            const fav = tx.favorite ? `<svg class="favorited" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>` : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
            return `<div class="transaction-item">
                <div class="transaction-info">
                    <div class="transaction-description">${escapeHtml(tx.description)}</div>
                    <div class="transaction-meta">${getCategoryLabel(tx.category)} \u2022 ${formatDateForDisplay(tx.date)}</div>
                </div>
                <div class="transaction-amount ${tx.type}">${tx.type === 'income' ? '+' : '-'}${formatCurrency(tx.value)}</div>
                <div class="transaction-actions">
                    <button class="action-btn favorite-btn" onclick="toggleFavorite('${tx.id}');updateAllViews();performSearch();" title="${tx.favorite ? 'Desfavoritar' : 'Favoritar'}">${fav}</button>
                    <button class="action-btn edit" onclick="editTransaction('${tx.id}')" title="${t('edit')}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                    <button class="action-btn delete" onclick="deleteTransaction('${tx.id}')" title="${t('delete')}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>
            </div>`;
        }

        // Logic for Transaction Type Toggle
        let currentTransactionType = 'income';

        function setTransactionType(type) {
            currentTransactionType = type;
            const bg = document.getElementById('segmentedBackground');
            const btnInc = document.getElementById('btnIncome');
            const btnExp = document.getElementById('btnExpense');
            const valInput = document.getElementById('transactionValue');

            if (type === 'income') {
                if (bg) {
                    bg.style.transform = 'translateX(0)';
                    bg.classList.remove('bg-expense');
                }
                if (btnInc) btnInc.classList.add('active');
                if (btnExp) btnExp.classList.remove('active');
                if (valInput) valInput.classList.remove('expense-color');
            } else {
                if (bg) {
                    bg.style.transform = 'translateX(100%)';
                    bg.classList.add('bg-expense');
                }
                if (btnExp) btnExp.classList.add('active');
                if (btnInc) btnInc.classList.remove('active');
                if (valInput) valInput.classList.add('expense-color');
            }
        }
        // Initialize default
        document.addEventListener('DOMContentLoaded', () => {
            setTransactionType('income');
        });

        function saveNewTransaction() {
            addTransaction(currentTransactionType);
        }

        function updateAllViews() { updateTransactionsList(); updateGoalsList(); updateDailyTransactions(); updateDailySummary(); updateWeeklySummary(); updateMonthlySummary(); updateYearlySummary(); updateTrashList(); if (document.getElementById('search') && document.getElementById('search').classList.contains('active')) populateYearSelect(); }

        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showNotification(msg, type = 'info') { const n = document.getElementById('notifications'); const el = document.createElement('div'); el.className = `notification ${type}`; el.textContent = msg; n.appendChild(el); setTimeout(() => { el.remove(); }, 4000); }

        let isSyncingFromRemote = false;
        async function loadDataFromFirebase() {
            if (!currentUser) return;
            try {
                // Real-time synchronization for transactions
                db.collection('users').doc(currentUser.uid).collection('data').doc('transactions')
                    .onSnapshot((doc) => {
                        if (doc.exists && !doc.metadata.hasPendingWrites) {
                            const remoteList = doc.data().list || [];
                            // Deep check if really changed
                            if (JSON.stringify(remoteList) !== JSON.stringify(transactions)) {
                                console.log("Atualizando transaes via remote sync");
                                transactions = remoteList;
                                localStorage.setItem('financialTransactions_v2', JSON.stringify(transactions));
                                updateAllViews();
                                performSearch();
                            }
                        }
                    });

                // Real-time synchronization for goals
                db.collection('users').doc(currentUser.uid).collection('data').doc('goals')
                    .onSnapshot((doc) => {
                        if (doc.exists && !doc.metadata.hasPendingWrites) {
                            const remoteList = doc.data().list || [];
                            if (JSON.stringify(remoteList) !== JSON.stringify(goals)) {
                                console.log("Atualizando metas via remote sync");
                                goals = remoteList;
                                localStorage.setItem('financialGoals_v2', JSON.stringify(goals));
                                updateAllViews();
                            }
                        }
                    });
            } catch (e) {
                console.error("Erro ao configurar listeners Firebase:", e);
            }
        }

        function manualCloudSync() {
            if (!currentUser) {
                showNotification("Faa login para sincronizar", "error");
                return;
            }
            showNotification("A sincronizao agora  automtica e em tempo real!", "info");
        }

        // REMOVIDO: saveDataToFirebase() antiga
        // Agora usando localStorage com isolamento por usurio (ver funo saveData() acima)
        // Se precisar de Firestore no futuro, implementar com coleo global 'transactions'

        // REMOVIDO: checkScheduledBackup() e performAutoBackup() - backup agora  manual via exportData()

        // REMOVIDO: funo saveData() antiga duplicada
        // Usar a funo saveData() com isolamento por userId (linha ~4040)
        // REMOVIDO: funo loadData() antiga duplicada
        // Usar a funo loadData() com isolamento por userId (linha ~4060)
        function exportData() { try { const d = { transactions: transactions, goals: goals }; const ds = JSON.stringify(d, null, 2); const b = new Blob([ds], { type: 'application/json' }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `backup-financeiro-${getTodayInBrasiliaISO()}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(u); showNotification(t('backupExported'), 'success'); } catch (e) { showNotification(t('backupExportError'), 'error'); } }
        function importData(ev) {
            const f = ev.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = async function (e) {
                try {
                    const d = JSON.parse(e.target.result);
                    if (!d || !Array.isArray(d.transactions)) throw new Error('Invalid format');
                    if (!currentUser) { throw new Error('Faa login para importar'); }

                    if (confirm(t('importConfirm'))) {
                        showNotification('Iniciando importao...', 'info');
                        const batch = db.batch();
                        let count = 0;

                        d.transactions.forEach(t => {
                            const ref = db.collection('transactions').doc();
                            // Sanitize and ensure userId
                            const tx = { ...t, userId: currentUser.uid, deleted: t.deleted || false };
                            delete tx.id; // Let Firestore generate ID or use new ID
                            batch.set(ref, tx);
                            count++;
                        });

                        if (d.goals && Array.isArray(d.goals)) {
                            d.goals.forEach(g => {
                                const ref = db.collection('goals').doc();
                                const goal = { ...g, userId: currentUser.uid };
                                delete goal.id;
                                batch.set(ref, goal);
                                count++;
                            });
                        }

                        // Commit batch (note: limit is 500 ops, simple implementation assumes < 500 for now)
                        // For production, should implement chunking
                        if (count > 490) {
                            showNotification('Muitos itens para importar de uma vez. Importe arquivos menores.', 'error');
                            return;
                        }

                        await batch.commit();
                        showNotification(t('importSuccess'), 'success');
                    }
                } catch (err) {
                    showNotification('Erro ao importar: ' + err.message, 'error');
                    console.error(err);
                } finally {
                    ev.target.value = '';
                }
            };
            r.readAsText(f);
        }
        function clearAllData() {
            if (confirm(t('clearConfirm'))) {
                if (!currentUser) return;

                const batch = db.batch();
                let count = 0;

                transactions.forEach(t => {
                    batch.delete(db.collection('transactions').doc(t.id));
                    count++;
                });

                goals.forEach(g => {
                    batch.delete(db.collection('goals').doc(g.id));
                    count++;
                });

                if (count === 0) {
                    showNotification(t('allDataCleared'), 'warning');
                    return;
                }

                if (count > 490) {
                    // Fallback for large deletion: just delete one by one or warn
                    // ideally use Promise.all with chunked deletes
                    // Simple implementation:
                    console.warn("Too many items to batch delete, deleting individually via batch chunks not implemented yet.");
                }

                batch.commit().then(() => {
                    showNotification(t('allDataCleared'), 'warning');
                }).catch(e => {
                    console.error("Erro ao limpar dados:", e);
                    showNotification("Erro ao limpar dados", "error");
                });
            }
        }

        function setChartType(type) { currentChartType = type; document.querySelectorAll('.chart-type-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.type === type); }); updateChart(); }
        function toggleChartPeriodInputs() { const p = document.getElementById('chartPeriod').value; document.getElementById('chartMonthGroup').style.display = p === 'month' ? 'block' : 'none'; document.getElementById('chartWeekGroup').style.display = p === 'week' ? 'block' : 'none'; document.getElementById('chartYearGroup').style.display = p === 'year' ? 'block' : 'none'; initChartPeriodInputs(); updateChart(); }
        function initChartPeriodInputs() { const n = new Date(); const y = n.getFullYear(); const m = String(n.getMonth() + 1).padStart(2, '0'); const mi = document.getElementById('chartMonth'); const wi = document.getElementById('chartWeek'); const yi = document.getElementById('chartYear'); if (mi && !mi.value) mi.value = `${y}-${m}`; if (yi && !yi.value) yi.value = y; if (wi && !wi.value) { const d = new Date(n); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); const yw = d.getUTCFullYear(); const wn = Math.ceil((((d - new Date(Date.UTC(yw, 0, 1))) / 86400000) + 1) / 7); wi.value = `${yw}-W${String(wn).padStart(2, '0')}`; } }
        function getChartData() { const p = document.getElementById('chartPeriod').value; const tf = document.getElementById('chartTypeFilter').value; const n = new Date(); let ss, es; if (p === 'month') { const v = document.getElementById('chartMonth').value; if (!v) return []; ss = v + '-01'; const [y, m] = v.split('-'); const ld = new Date(parseInt(y), parseInt(m), 0).getDate(); es = `${v}-${String(ld).padStart(2, '0')}`; } else if (p === 'week') { const wv = document.getElementById('chartWeek').value; if (!wv) return []; const [yr, wn] = wv.split('-W'); if (!yr || !wn) return []; const fy = new Date(Date.UTC(parseInt(yr, 10), 0, 1)); const ds = (parseInt(wn, 10) - 1) * 7; const sd = new Date(fy.getTime() + ds * 86400000); const dow = sd.getUTCDay(); const diff = sd.getUTCDate() - dow + (dow === 0 ? -6 : 1); const mon = new Date(sd); mon.setUTCDate(diff); const sun = new Date(mon); sun.setUTCDate(mon.getUTCDate() + 6); ss = mon.toISOString().split('T')[0]; es = sun.toISOString().split('T')[0]; } else if (p === 'year') { const y = document.getElementById('chartYear').value; if (!y) return []; ss = `${y}-01-01`; es = `${y}-12-31`; } else if (p === 'last3') { const d = new Date(n); d.setMonth(d.getMonth() - 3); ss = d.toISOString().split('T')[0]; es = n.toISOString().split('T')[0]; } else if (p === 'last6') { const d = new Date(n); d.setMonth(d.getMonth() - 6); ss = d.toISOString().split('T')[0]; es = n.toISOString().split('T')[0]; } else { ss = `${n.getFullYear()}-01-01`; es = n.toISOString().split('T')[0]; } let list = getActiveTransactions().filter(tx => tx.date >= ss && tx.date <= es); if (tf === 'income') list = list.filter(tx => tx.type === 'income'); else if (tf === 'expense') list = list.filter(tx => tx.type === 'expense'); const bc = {}; list.forEach(tx => { if (!bc[tx.category]) bc[tx.category] = 0; bc[tx.category] += tx.value; }); if (tf === 'both') { const ti = list.filter(tx => tx.type === 'income').reduce((s, tx) => s + tx.value, 0); const te = list.filter(tx => tx.type === 'expense').reduce((s, tx) => s + tx.value, 0); const r = []; if (ti > 0) r.push({ label: '\u{1F4B0} ' + t('income'), value: ti }); if (te > 0) r.push({ label: '\u{1F4B8} ' + t('expense'), value: te }); return r; } return Object.entries(bc).map(([cat, val]) => ({ label: categories[cat] || cat, value: val })).sort((a, b) => b.value - a.value); }
        function updateChart() { const cv = document.getElementById('financeChart'); if (!cv) return; const data = getChartData(); if (data.length === 0) { if (financeChartInstance) { financeChartInstance.destroy(); financeChartInstance = null; } return; } const isDark = document.body.classList.contains('dark'); const tc = isDark ? '#f1f5f9' : '#1e293b'; const gc = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)'; if (financeChartInstance) financeChartInstance.destroy(); const cd = { labels: data.map(d => d.label), datasets: [{ data: data.map(d => d.value), backgroundColor: ['#0D9488', '#14B8A6', '#059669', '#F59E0B', '#DC2626', '#8B5CF6', '#EC4899', '#06B6D4', '#F97316', '#6366F1'], borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.8)', borderWidth: 2 }] }; const cfg = { type: currentChartType, data: cd, options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom', labels: { color: tc, font: { size: 11, family: 'Inter' } } } }, scales: currentChartType === 'bar' ? { y: { beginAtZero: true, grid: { color: gc }, ticks: { color: tc } }, x: { grid: { color: gc }, ticks: { color: tc, maxRotation: 45 } } } : {} } }; financeChartInstance = new Chart(cv, cfg); }

        function toggleCalculator() { const o = document.getElementById('calcOverlay'); o.classList.toggle('active'); if (o.classList.contains('active')) calcClear(); }
        let calcDisplayStr = '0'; let calcPrev = null; let calcOp = null; const CALC_MAX_DIGITS = 10;
        function countDigits(s) { return (s.match(/\d/g) || []).length; }
        function calcUpdateDisplay() { document.getElementById('calcDisplay').value = calcDisplayStr; }
        function calcInput(key) { const symMap = { '+': '+', '-': '\u2212', '*': '\u00D7', '/': '/' }; const opRegex = /([+\-\u2212\u00D7/])/; if (key === '\u00B1') { if (calcOp) { const p = calcDisplayStr.split(opRegex).filter(Boolean); if (p[2]) { p[2] = String(-parseFloat(p[2])); calcDisplayStr = p.join(''); } } else { calcDisplayStr = String(-parseFloat(calcDisplayStr)); } } else if (key === '%') { if (calcOp) { const p = calcDisplayStr.split(opRegex); const l = p[p.length - 1]; if (l && l !== '-' && l !== '+') { p[p.length - 1] = String(parseFloat(l) / 100); calcDisplayStr = p.join(''); } } else { calcDisplayStr = String(parseFloat(calcDisplayStr) / 100); } } else if (key === '.') { const p = calcDisplayStr.split(opRegex); const ln = p[p.length - 1] || ''; if (!ln.includes('.') && countDigits(calcDisplayStr) < CALC_MAX_DIGITS) { if (ln === '' || ln === '0') p[p.length - 1] = '0.'; else p[p.length - 1] = ln + '.'; calcDisplayStr = p.join(''); } } else if ('0123456789'.includes(key)) { const p = calcDisplayStr.split(opRegex); const lp = p[p.length - 1] || '0'; const dl = (lp.match(/\d/g) || []).length; if (dl >= CALC_MAX_DIGITS && !lp.includes('.')) return; if (lp === '0' && key !== '0' && !lp.includes('.')) p[p.length - 1] = key; else p[p.length - 1] = lp + key; calcDisplayStr = p.join(''); } else if ('+-*/'.includes(key)) { const sym = symMap[key]; if (calcOp && calcPrev !== null) { const p = calcDisplayStr.split(opRegex); const l = p[p.length - 1]; if (l && l !== '-' && l !== '+' && !isNaN(parseFloat(l))) { calcEquals(); calcDisplayStr = calcDisplayStr + sym; calcPrev = parseFloat(calcDisplayStr); calcOp = key; } else { calcPrev = parseFloat(calcDisplayStr.replace(/([+\-\u2212\u00D7/])$/, '').trim() || 0); calcOp = key; calcDisplayStr = (calcDisplayStr.replace(/([+\-\u2212\u00D7/])$/, '').trim() || '0') + sym; } } else { calcPrev = parseFloat(calcDisplayStr.replace(/([+\-\u2212\u00D7/])$/, '').trim() || 0); calcOp = key; calcDisplayStr = (calcDisplayStr.replace(/([+\-\u2212\u00D7/])$/, '').trim() || '0') + sym; } } calcUpdateDisplay(); }
        function calcClear() { calcDisplayStr = '0'; calcPrev = null; calcOp = null; calcUpdateDisplay(); }
        function calcEquals() { var de = document.getElementById('calcDisplay'); var s = (de && de.value) ? de.value : calcDisplayStr; if (!s || s === '') return; var nm = String(s).replace(/\u00D7/g, '*').replace(/\u2212/g, '-').trim(); var p = nm.split(/([+\-*/])/); if (p.length < 3) return; var a = parseFloat(p[0]); var op = p[1]; var b = parseFloat(p[2]); if (isNaN(a)) return; if (isNaN(b)) b = 0; var r; if (op === '+') r = a + b; else if (op === '-') r = a - b; else if (op === '*') r = a * b; else if (op === '/') r = b === 0 ? 0 : a / b; else return; r = Math.round(r * 1e10) / 1e10; calcDisplayStr = String(r).length > CALC_MAX_DIGITS ? String(Number(r).toExponential(6)) : String(r); calcPrev = null; calcOp = null; calcUpdateDisplay(); }

        /* --- New Transaction Type & Value Logic --- */
        // let currentTransactionType = 'income'; // DUPLICADO DESATIVADO
        function setTransactionType_OLD(type) {
            currentTransactionType = type;
            const ti = document.getElementById('toggleIncome');
            const te = document.getElementById('toggleExpense');
            const ri = document.getElementById('radioIncome');
            const re = document.getElementById('radioExpense');
            const vd = document.getElementById('transactionValue');
            if (type === 'income') {
                ti.classList.remove('inactive');
                te.classList.add('inactive');
                ri.classList.add('filled');
                re.classList.remove('filled');
                vd.classList.remove('expense-color');
            } else {
                ti.classList.add('inactive');
                te.classList.remove('inactive');
                ri.classList.remove('filled');
                re.classList.add('filled');
                vd.classList.add('expense-color');
            }
        }
        function saveNewTransaction_OLD() {
            addTransaction(currentTransactionType);
        }

        document.getElementById('transactionDate').addEventListener('change', function () { updateDailyTransactions(); updateDateDisplayText(); });
        function updateDateDisplayText() {
            var di = document.getElementById('transactionDate');
            var dt = document.getElementById('dateDisplayText');
            if (!di || !dt) return;
            if (!di.value) { dt.textContent = '--/--/----'; return; }
            var parts = di.value.split('-');
            if (parts.length === 3) { dt.textContent = parts[2] + '/' + parts[1] + '/' + parts[0]; }
        }
        // Patch previousDay/nextDay to also update display text
        var _origPrevDay = previousDay;
        previousDay = function () { _origPrevDay(); updateDateDisplayText(); };
        var _origNextDay = nextDay;
        nextDay = function () { _origNextDay(); updateDateDisplayText(); };
        document.addEventListener('click', e => { if (e.target.classList.contains('modal-overlay')) { const mid = e.target.id; if (mid === 'monthPickerModal') closeMonthPickerModal(); else closeModal(mid); } });
        function previousDay() { const di = document.getElementById('transactionDate'); const cd = new Date(di.value + 'T00:00:00Z'); cd.setUTCDate(cd.getUTCDate() - 1); di.value = cd.toISOString().split('T')[0]; updateDailyTransactions(); }
        function nextDay() { const di = document.getElementById('transactionDate'); const cd = new Date(di.value + 'T00:00:00Z'); cd.setUTCDate(cd.getUTCDate() + 1); di.value = cd.toISOString().split('T')[0]; updateDailyTransactions(); }
    </script>
</body>

</html>
