<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Controle Financeiro Aprimorado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0D9488;
            --primary-light: #14B8A6;
            --primary-dark: #0F766E;
            --primary-glow: rgba(13, 148, 136, 0.3);
            --accent: #F59E0B;
            --success: #059669;
            --success-light: #10B981;
            --danger: #DC2626;
            --danger-light: #EF4444;
            --warning: #D97706;
            --dark-bg: #0C1222;
            --dark-bg-2: #111A2E;
            --dark-surface: #162036;
            --dark-card: #1A2744;
            --dark-border: rgba(255,255,255,0.06);
            --dark-text: #F1F5F9;
            --dark-text-2: #94A3B8;
            --dark-text-3: #64748B;
            --light-bg: #F0FDFA;
            --light-surface: #FFFFFF;
            --light-card: #F0FDFA;
            --light-border: rgba(0,0,0,0.08);
            --light-text: #0F172A;
            --light-text-2: #475569;
            --light-text-3: #94A3B8;
            --radius: 16px;
            --radius-sm: 10px;
            --radius-xs: 8px;
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        html { scroll-behavior:smooth; -webkit-tap-highlight-color:transparent; }
        body {
            font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
            transition: background var(--transition), color var(--transition);
            overflow-x:hidden; min-height:100vh;
            -webkit-font-smoothing:antialiased;
        }
        body.dark { background:var(--dark-bg); color:var(--dark-text); }
        body.light { background:var(--light-bg); color:var(--light-text); }

        @keyframes fadeInUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes scaleIn { from{opacity:0;transform:scale(0.92)} to{opacity:1;transform:scale(1)} }
        @keyframes slideInRight { from{transform:translateX(120%);opacity:0} to{transform:translateX(0);opacity:1} }
        @keyframes pulse-soft { 0%,100%{transform:scale(1)} 50%{transform:scale(1.04)} }
        @keyframes spin { to{transform:rotate(360deg)} }
        @keyframes glow-ring { 0%,100%{box-shadow:0 0 0 0 var(--primary-glow)} 50%{box-shadow:0 0 0 16px rgba(13,148,136,0)} }

        /* SPLASH */
        .splash-screen {
            position:fixed; inset:0; background:var(--dark-bg);
            display:flex; flex-direction:column; justify-content:center; align-items:center;
            z-index:9999; transition:opacity 0.6s ease,visibility 0.6s ease;
        }
        .splash-screen.hidden { opacity:0; visibility:hidden; pointer-events:none; }
        .splash-logo {
            width:96px; height:96px;
            background:linear-gradient(135deg,var(--primary),var(--primary-light));
            border-radius:24px; display:flex; align-items:center; justify-content:center;
            margin-bottom:24px; animation:pulse-soft 2s ease-in-out infinite;
            box-shadow:0 0 40px var(--primary-glow);
        }
        .splash-logo svg { color:white; }
        .splash-title { color:white; font-size:24px; font-weight:800; letter-spacing:-0.5px; margin-bottom:8px; }
        .splash-subtitle { color:var(--dark-text-2); font-size:14px; margin-bottom:28px; }
        .splash-loader { width:32px; height:32px; border:3px solid var(--dark-card); border-top-color:var(--primary-light); border-radius:50%; animation:spin 0.8s linear infinite; }

        /* HEADER */
        .header {
            background:var(--dark-bg-2); border-bottom:1px solid var(--dark-border);
            padding:0.6rem 1rem; padding-top:max(0.6rem,env(safe-area-inset-top));
            padding-left:max(1rem,env(safe-area-inset-left)); padding-right:max(1rem,env(safe-area-inset-right));
            display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:0.5rem;
            position:sticky; top:0; z-index:100;
            transition:background var(--transition); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
        }
        .light .header { background:rgba(255,255,255,0.88); border-bottom-color:var(--light-border); }

        .menu-button {
            background:transparent; border:1px solid var(--dark-border); color:var(--dark-text-2);
            cursor:pointer; padding:8px; border-radius:var(--radius-xs);
            transition:all var(--transition); flex-shrink:0; touch-action:manipulation; display:flex; align-items:center; justify-content:center;
        }
        .menu-button:hover { background:var(--primary); color:white; border-color:var(--primary); }
        .light .menu-button { border-color:var(--light-border); color:var(--light-text-2); }

        .header-title-wrapper { display:flex; flex-direction:column; flex:1; min-width:0; }
        .header-title { font-size:1.1rem; font-weight:700; display:flex; align-items:center; gap:8px; letter-spacing:-0.3px; line-height:1.2; }
        .header-title svg { flex-shrink:0; width:20px; height:20px; color:var(--primary-light); }
        .header-clock { margin-top:2px; }
        .header-clock-inner { display:flex; align-items:center; gap:8px; }
        .header-clock-time { font-size:0.72rem; font-weight:500; color:var(--dark-text-2); font-variant-numeric:tabular-nums; }
        .header-clock-date { font-size:0.72rem; color:var(--dark-text-3); }
        .light .header-clock-time { color:var(--light-text-2); }
        .light .header-clock-date { color:var(--light-text-3); }

        .header-controls { display:flex; align-items:center; gap:4px; flex-shrink:0; }
        .lang-buttons { display:flex; gap:2px; }
        .lang-btn {
            background:transparent; border:1px solid var(--dark-border); color:var(--dark-text);
            padding:5px 8px; border-radius:var(--radius-xs); font-size:1rem; cursor:pointer;
            transition:all var(--transition); line-height:1;
        }
        .lang-btn:hover { border-color:var(--primary); }
        .lang-btn.active { background:var(--primary); border-color:var(--primary); box-shadow:0 0 12px var(--primary-glow); }
        .light .lang-btn { border-color:var(--light-border); color:var(--light-text); }
        .light .lang-btn.active { background:var(--primary); border-color:var(--primary); color:white; }

        .theme-toggle {
            background:transparent; border:1px solid var(--dark-border); color:var(--dark-text);
            cursor:pointer; padding:5px 8px; border-radius:var(--radius-xs); font-size:1rem; transition:all var(--transition);
        }
        .theme-toggle:hover { border-color:var(--primary); }
        .light .theme-toggle { border-color:var(--light-border); color:var(--light-text); }

        /* SIDE MENU */
        .menu-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);
            z-index:200; opacity:0; visibility:hidden; transition:all var(--transition);
        }
        .menu-overlay.active { opacity:1; visibility:visible; }

        .side-menu {
            position:fixed; top:0; left:0; width:300px; height:100%; z-index:201;
            transform:translateX(-100%); transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);
            box-shadow:4px 0 32px rgba(0,0,0,0.2); overflow-y:auto;
        }
        .dark .side-menu { background:var(--dark-bg-2); }
        .light .side-menu { background:var(--light-surface); }
        .side-menu.active { transform:translateX(0); }

        .menu-header {
            background:linear-gradient(135deg,var(--primary-dark),var(--primary));
            color:white; padding:1.5rem; display:flex; justify-content:space-between; align-items:center;
        }
        .menu-header h2 { font-size:1.1rem; font-weight:700; }
        .menu-close { background:none; border:none; color:white; cursor:pointer; padding:4px; display:flex; }

        .menu-items { padding:0.75rem 0; }
        .menu-item {
            display:flex; align-items:center; gap:12px; padding:0.85rem 1.25rem; cursor:pointer;
            transition:all var(--transition); border:none; background:none; width:100%;
            text-align:left; font-size:0.92rem; font-weight:500; position:relative; font-family:inherit;
        }
        .dark .menu-item { color:var(--dark-text-2); }
        .light .menu-item { color:var(--light-text-2); }
        .menu-item svg { color:var(--dark-text-3); transition:color var(--transition); flex-shrink:0; }
        .light .menu-item svg { color:var(--light-text-3); }
        .menu-item:hover { background:rgba(13,148,136,0.08); }
        .menu-item:hover, .menu-item:hover svg { color:var(--primary-light); }
        .menu-item.active { color:var(--primary-light); background:rgba(13,148,136,0.1); }
        .menu-item.active::before {
            content:''; position:absolute; left:0; top:50%; transform:translateY(-50%);
            width:3px; height:60%; background:var(--primary); border-radius:0 4px 4px 0;
        }
        .menu-item.active svg { color:var(--primary-light); }

        /* MAIN */
        .main-content {
            padding:1rem; padding-left:max(1rem,env(safe-area-inset-left));
            padding-right:max(1rem,env(safe-area-inset-right));
            padding-bottom:max(5rem,env(safe-area-inset-bottom));
            max-width:960px; margin:0 auto;
        }
        .tab-content { display:none; animation:fadeInUp 0.35s ease; }
        .tab-content.active { display:block; }

        /* CARDS */
        .card {
            border-radius:var(--radius); padding:1.5rem; margin-bottom:1rem;
            transition:all var(--transition); border:1px solid var(--dark-border);
        }
        .dark .card { background:var(--dark-surface); }
        .light .card { background:var(--light-surface); border-color:var(--light-border); }
        .card:hover { border-color:rgba(13,148,136,0.15); }

        .card h2, .card h3 { font-weight:700; letter-spacing:-0.3px; display:flex; align-items:center; gap:8px; }
        .card h2::before {
            content:''; display:inline-block; width:4px; height:20px;
            background:var(--primary); border-radius:4px; flex-shrink:0;
        }

        /* STAT CARDS */
        .stats-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:0.75rem; margin-bottom:1.5rem; }

        .stat-card {
            border-radius:var(--radius); padding:1.25rem 1rem; text-align:center;
            position:relative; overflow:hidden; transition:transform var(--transition),box-shadow var(--transition);
        }
        .stat-card:hover { transform:translateY(-2px); }

        .stat-card.income { background:linear-gradient(135deg,#064E3B,#065F46); color:#A7F3D0; border:1px solid rgba(16,185,129,0.2); }
        .stat-card.income:hover { box-shadow:0 8px 24px rgba(16,185,129,0.15); }
        .light .stat-card.income { background:linear-gradient(135deg,#ECFDF5,#D1FAE5); color:#065F46; border-color:rgba(16,185,129,0.2); }

        .stat-card.expense { background:linear-gradient(135deg,#7F1D1D,#991B1B); color:#FECACA; border:1px solid rgba(239,68,68,0.2); }
        .stat-card.expense:hover { box-shadow:0 8px 24px rgba(239,68,68,0.15); }
        .light .stat-card.expense { background:linear-gradient(135deg,#FEF2F2,#FEE2E2); color:#991B1B; border-color:rgba(239,68,68,0.2); }

        .stat-card.balance { background:linear-gradient(135deg,var(--primary-dark),var(--primary)); color:#CCFBF1; border:1px solid rgba(13,148,136,0.3); }
        .stat-card.balance:hover { box-shadow:0 8px 24px var(--primary-glow); }
        .light .stat-card.balance { background:linear-gradient(135deg,#F0FDFA,#CCFBF1); color:var(--primary-dark); border-color:rgba(13,148,136,0.2); }

        .stat-icon { font-size:1.5rem; margin-bottom:0.3rem; opacity:0.85; }
        .stat-value {
            font-size:clamp(0.75rem,2.5vw,1.4rem); font-weight:800; letter-spacing:-0.5px;
            word-break:break-all; overflow-wrap:anywhere; line-height:1.2; margin-bottom:0.2rem;
        }
        .stat-label { font-size:0.7rem; opacity:0.7; font-weight:500; text-transform:uppercase; letter-spacing:0.5px; }

        /* FORMS */
        .form-group { margin-bottom:1rem; }
        .form-group-checkbox { display:flex; align-items:center; }
        .form-label {
            display:block; margin-bottom:0.4rem; font-weight:600; font-size:0.82rem;
            text-transform:uppercase; letter-spacing:0.5px;
        }
        .dark .form-label { color:var(--dark-text-2); }
        .light .form-label { color:var(--light-text-2); }

        .form-input,.form-select,.form-textarea {
            width:100%; padding:0.7rem 0.9rem; border:1.5px solid var(--dark-border);
            border-radius:var(--radius-xs); font-size:0.92rem; font-family:inherit;
            transition:all var(--transition); outline:none;
        }
        .dark .form-input,.dark .form-select,.dark .form-textarea { background:var(--dark-card); color:var(--dark-text); border-color:rgba(255,255,255,0.08); }
        .light .form-input,.light .form-select,.light .form-textarea { background:var(--light-card); color:var(--light-text); border-color:rgba(0,0,0,0.1); }
        .form-input:focus,.form-select:focus,.form-textarea:focus { border-color:var(--primary); box-shadow:0 0 0 3px var(--primary-glow); }
        .form-textarea { resize:vertical; min-height:80px; }

        .form-label-checkbox { display:flex; align-items:center; gap:0.5rem; cursor:pointer; font-weight:500; font-size:0.9rem; margin-bottom:0; }
        .form-label-checkbox input[type="checkbox"] { width:18px; height:18px; cursor:pointer; accent-color:var(--primary); }

        /* BUTTONS */
        .btn {
            padding:0.65rem 1.25rem; border:none; border-radius:var(--radius-xs); font-size:0.88rem;
            font-weight:600; cursor:pointer; transition:all var(--transition);
            display:inline-flex; align-items:center; gap:0.5rem; font-family:inherit;
            text-decoration:none; position:relative; overflow:hidden; touch-action:manipulation;
        }
        .btn:active { transform:scale(0.97); }
        .btn-primary { background:var(--primary); color:white; }
        .btn-primary:hover { background:var(--primary-light); box-shadow:0 4px 16px var(--primary-glow); }
        .btn-success { background:var(--success); color:white; }
        .btn-success:hover { background:var(--success-light); box-shadow:0 4px 16px rgba(16,185,129,0.3); }
        .btn-danger { background:var(--danger); color:white; }
        .btn-danger:hover { background:var(--danger-light); box-shadow:0 4px 16px rgba(239,68,68,0.3); }
        .btn-warning { background:var(--warning); color:white; }
        .btn-warning:hover { background:var(--accent); }
        .btn-secondary { background:transparent; border:1.5px solid var(--dark-border); }
        .dark .btn-secondary { color:var(--dark-text-2); }
        .light .btn-secondary { color:var(--light-text-2); border-color:var(--light-border); }
        .btn-secondary:hover { border-color:var(--primary); color:var(--primary); }

        .btn-group { display:flex; gap:0.5rem; flex-wrap:wrap; }

        #transactionForm .btn-group-round { display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; margin-top:0.5rem; }
        #transactionForm .btn-group-round .btn {
            width:56px; height:56px; min-width:56px; padding:0; border-radius:50%;
            display:inline-flex; align-items:center; justify-content:center; flex:none;
        }
        #transactionForm .btn-group-round .btn svg { width:22px; height:22px; flex-shrink:0; }
        #transactionForm .btn-group-round .btn:hover { transform:scale(1.1); box-shadow:0 4px 20px rgba(0,0,0,0.2); }

        /* TRANSACTIONS */
        .transaction-item {
            display:flex; justify-content:space-between; align-items:center;
            padding:0.85rem; border-radius:var(--radius-sm); margin-bottom:0.5rem;
            transition:all var(--transition); gap:0.5rem; flex-wrap:wrap;
        }
        .dark .transaction-item { background:var(--dark-card); border:1px solid var(--dark-border); }
        .light .transaction-item { background:var(--light-card); border:1px solid var(--light-border); }
        .transaction-item:hover { border-color:rgba(13,148,136,0.2); transform:translateX(3px); }

        .transaction-info { flex:1; min-width:0; }
        .transaction-description { font-weight:600; margin-bottom:0.15rem; font-size:0.92rem; }
        .transaction-meta { font-size:0.78rem; opacity:0.6; }
        .transaction-amount {
            font-weight:700; font-size:clamp(0.75rem,2vw,1.05rem); margin-right:0.5rem;
            word-break:break-all; overflow-wrap:break-word; min-width:0; flex-shrink:1; text-align:right;
        }
        .transaction-amount.income { color:var(--success-light); }
        .transaction-amount.expense { color:var(--danger-light); }
        .light .transaction-amount.income { color:var(--success); }
        .light .transaction-amount.expense { color:var(--danger); }

        .transaction-actions { display:flex; gap:0.4rem; }
        .action-btn {
            padding:0.4rem 0.5rem; border:none; border-radius:var(--radius-xs); cursor:pointer;
            transition:all var(--transition); font-size:0.85rem; touch-action:manipulation; display:flex; align-items:center; justify-content:center;
        }
        .action-btn:hover { transform:scale(1.08); }
        .action-btn.edit { background:rgba(245,158,11,0.15); color:var(--accent); }
        .action-btn.delete { background:rgba(239,68,68,0.15); color:var(--danger-light); }
        .action-btn.favorite-btn { background:transparent; color:var(--accent); font-size:1rem; }
        .action-btn.move-up { background:rgba(13,148,136,0.15); color:var(--primary-light); }
        .action-btn.move-down { background:rgba(13,148,136,0.15); color:var(--primary-light); }

        /* DATE NAV */
        .date-nav-container { display:flex; gap:0.5rem; align-items:center; }
        .date-nav-arrow {
            background:none; border:1px solid rgba(13,148,136,0.3); border-radius:var(--radius-xs);
            padding:0.35rem; cursor:pointer; transition:all var(--transition);
            display:flex; align-items:center; justify-content:center; width:32px; height:32px; min-width:32px;
        }
        .dark .date-nav-arrow { color:var(--dark-text); }
        .light .date-nav-arrow { color:var(--light-text); }
        .date-nav-arrow:hover { background:rgba(13,148,136,0.1); border-color:var(--primary); }
        .date-nav-arrow svg { width:16px; height:16px; }

        /* SEARCH */
        .search-section { margin-bottom:2rem; }
        .search-filters { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-bottom:1rem; }
        .search-actions { display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem; }
        .search-results { margin-top:1rem; }
        .search-results-grouped { display:flex; flex-direction:column; gap:0.75rem; }
        .search-results-date-group { border-radius:var(--radius-sm); overflow:hidden; }
        .dark .search-results-date-group { background:var(--dark-card); border:1px solid var(--dark-border); }
        .light .search-results-date-group { background:var(--light-surface); border:1px solid var(--light-border); }
        .search-results-date-header {
            padding:0.6rem 1rem; font-weight:700; font-size:0.82rem;
            border-bottom:1px solid rgba(13,148,136,0.1); text-transform:uppercase; letter-spacing:0.5px;
        }
        .dark .search-results-date-header { background:rgba(13,148,136,0.06); color:var(--primary-light); }
        .light .search-results-date-header { background:rgba(13,148,136,0.05); color:var(--primary-dark); }
        .search-results-date-list { padding:0.4rem; }
        .search-result-card {
            display:flex; align-items:center; justify-content:space-between;
            padding:0.75rem; border-radius:var(--radius-xs); margin-bottom:0.35rem;
            transition:all 0.2s ease; gap:0.5rem;
        }
        .search-result-card:last-child { margin-bottom:0; }
        .search-result-card:hover { transform:translateX(3px); }
        .dark .search-result-card:hover { background:rgba(255,255,255,0.03); }
        .light .search-result-card:hover { background:rgba(0,0,0,0.02); }
        .search-result-card .transaction-info { flex:1; min-width:0; }
        .search-result-card .transaction-description { font-weight:600; font-size:0.9rem; margin-bottom:0.15rem; }
        .search-result-card .transaction-meta { font-size:0.78rem; opacity:0.7; }
        .search-result-card .favorite-star {
            flex-shrink:0; background:none; border:none; cursor:pointer; padding:4px;
            font-size:1.1rem; opacity:0.5; transition:opacity 0.2s;
        }
        .search-result-card .favorite-star.favorited { opacity:1; }
        .search-result-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; padding:0.5rem 0; border-bottom:2px solid rgba(13,148,136,0.1); }
        .search-result-count { font-size:0.85rem; opacity:0.7; }

        /* MONTH-YEAR FILTERS */
        .month-year-filters { display:grid; grid-template-columns:1fr 1fr; gap:1rem; width:100%; }

        /* MONTH PICKER */
        .month-picker-container { border-radius:var(--radius-sm); padding:1rem; border:1px solid var(--dark-border); }
        .dark .month-picker-container { background:var(--dark-card); }
        .light .month-picker-container { background:var(--light-card); border-color:var(--light-border); }
        .month-picker-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
        .month-picker-year { font-size:1.1rem; font-weight:700; }
        .dark .month-picker-year { color:var(--dark-text); }
        .light .month-picker-year { color:var(--light-text); }
        .month-picker-nav { display:flex; flex-direction:column; gap:0.2rem; }
        .month-picker-nav-btn {
            background:transparent; border:none; cursor:pointer; padding:2px 6px;
            display:flex; align-items:center; justify-content:center; transition:color 0.2s; font-size:0.7rem;
        }
        .dark .month-picker-nav-btn { color:var(--dark-text-2); }
        .light .month-picker-nav-btn { color:var(--light-text-2); }
        .month-picker-nav-btn:hover { color:var(--primary); }
        .month-picker-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:0.5rem; margin-bottom:0.5rem; }
        .month-picker-item {
            aspect-ratio:1; display:flex; align-items:center; justify-content:center;
            border-radius:50%; cursor:pointer; transition:all 0.2s ease;
            font-size:0.82rem; font-weight:500; background:transparent; border:none; padding:0;
        }
        .dark .month-picker-item { color:var(--dark-text); }
        .light .month-picker-item { color:var(--light-text); }
        .month-picker-item:hover { background:rgba(13,148,136,0.1); transform:scale(1.05); }
        .month-picker-item.selected { background:var(--primary); color:white; font-weight:600; }
        .month-picker-item.other-year { opacity:0.4; }

        /* CHART */
        .chart-filters { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem; margin-bottom:1.5rem; }
        .chart-type-toggle { display:flex; gap:0.5rem; flex-wrap:wrap; }
        .chart-type-btn {
            flex:1; min-width:100px; padding:0.6rem 1rem; border:2px solid var(--primary);
            border-radius:var(--radius-xs); background:transparent; color:var(--primary);
            font-weight:600; cursor:pointer; transition:all 0.2s ease; font-family:inherit; font-size:0.88rem;
        }
        .chart-type-btn:hover { background:rgba(13,148,136,0.1); }
        .chart-type-btn.active { background:var(--primary); color:white; }
        .chart-container-wrapper { position:relative; width:100%; min-height:280px; padding:1rem 0; }
        .chart-container-wrapper canvas { max-width:100%; height:auto!important; }

        /* GOALS */
        .goal-item { border-radius:var(--radius); padding:1.25rem; margin-bottom:0.75rem; transition:all var(--transition); }
        .dark .goal-item { background:var(--dark-card); border:1px solid var(--dark-border); }
        .light .goal-item { background:var(--light-card); border:1px solid var(--light-border); }
        .goal-item:hover { border-color:rgba(13,148,136,0.2); }
        .goal-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem; }
        .goal-info h3 { margin-bottom:0.35rem; font-size:1rem; }
        .goal-info h3::before { display:none; }
        .goal-values { font-size:clamp(0.7rem,1.5vw+0.5rem,0.85rem); opacity:0.7; word-break:break-all; overflow-wrap:break-word; }
        .goal-actions { display:flex; gap:0.4rem; align-items:flex-start; flex-shrink:0; }
        .goal-progress { margin-bottom:0.5rem; }
        .progress-bar { width:100%; height:6px; border-radius:3px; overflow:hidden; margin-bottom:0.5rem; }
        .dark .progress-bar { background:rgba(255,255,255,0.06); }
        .light .progress-bar { background:rgba(0,0,0,0.06); }
        .progress-fill { height:100%; background:linear-gradient(90deg,var(--primary),var(--success-light)); transition:width 0.3s ease; border-radius:3px; }
        .progress-text { display:flex; justify-content:space-between; font-size:clamp(0.65rem,1.5vw+0.4rem,0.78rem); opacity:0.7; word-break:break-all; overflow-wrap:break-word; }

        /* SUMMARIES */
        .summary-section { margin-bottom:0.75rem; border-radius:var(--radius); overflow:hidden; }
        .dark .summary-section { background:var(--dark-surface); border:1px solid var(--dark-border); }
        .light .summary-section { background:var(--light-surface); border:1px solid var(--light-border); }
        .summary-header { padding:1rem 1.25rem; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:all var(--transition); }
        .summary-header:hover { background:rgba(13,148,136,0.06); }
        .summary-title { display:flex; align-items:center; gap:0.5rem; font-weight:600; font-size:0.95rem; }
        .summary-title svg { color:var(--primary-light); }
        .expand-icon { transition:transform 0.3s ease; }
        .expand-icon.expanded { transform:rotate(180deg); }
        .summary-content { max-height:0; overflow:hidden; transition:max-height 0.3s ease; }
        .summary-content.expanded { max-height:2000px; }
        .summary-body { padding:1.25rem; border-top:1px solid rgba(13,148,136,0.08); }

        /* BACKUP */
        .backup-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:0.75rem; }
        .backup-btn {
            background:none; border:2px solid; padding:1rem 1.25rem; border-radius:var(--radius-sm);
            font-size:0.92rem; font-weight:600; cursor:pointer; transition:all var(--transition);
            display:flex; align-items:center; gap:0.75rem; text-decoration:none; position:relative;
            overflow:hidden; min-width:160px; justify-content:center; font-family:inherit;
        }
        .backup-btn:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,0.15); }
        .backup-btn-export { border-color:var(--primary); color:var(--primary); }
        .backup-btn-export:hover { background:var(--primary); color:white; }
        .backup-btn-import { border-color:var(--primary-light); color:var(--primary-light); }
        .backup-btn-import:hover { background:var(--primary-light); color:white; }
        .backup-btn-excel { border-color:var(--success); color:var(--success); }
        .backup-btn-excel:hover { background:var(--success); color:white; }
        .backup-btn-clear { border-color:var(--danger); color:var(--danger); }
        .backup-btn-clear:hover { background:var(--danger); color:white; }
        .backup-btn-icon { font-size:1.2rem; }

        #emptyTrashBtn {
            display:inline-flex; align-items:center; gap:0.5rem; padding:0.6rem 1rem;
            border-radius:var(--radius-xs); font-weight:700; border:none;
            background:var(--danger); color:white; cursor:pointer; font-family:inherit;
            transition:all var(--transition); align-self:flex-start; min-width:140px; justify-content:center;
        }
        #emptyTrashBtn svg { width:16px; height:16px; flex-shrink:0; }
        #emptyTrashBtn:hover { background:var(--danger-light); box-shadow:0 4px 16px rgba(239,68,68,0.3); transform:translateY(-1px); }

        /* MODALS */
        .modal-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px);
            z-index:1000; display:flex; align-items:center; justify-content:center;
            opacity:0; visibility:hidden; transition:all var(--transition); padding:1rem;
        }
        .modal-overlay.active { opacity:1; visibility:visible; }
        .modal {
            border-radius:var(--radius); padding:1.75rem; max-width:500px; width:100%;
            max-height:90vh; overflow-y:auto; transform:scale(0.92);
            transition:transform 0.3s ease; position:relative; z-index:1001;
        }
        .modal-overlay.active .modal { transform:scale(1); }
        .dark .modal { background:var(--dark-surface); border:1px solid var(--dark-border); }
        .light .modal { background:var(--light-surface); border:1px solid var(--light-border); }
        #monthPickerModal .modal { max-width:400px; padding:1.5rem; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.25rem; }
        .modal-title { font-size:1.15rem; font-weight:700; }
        .modal-close { background:none; border:none; font-size:1.5rem; cursor:pointer; opacity:0.6; transition:opacity 0.2s; }
        .dark .modal-close { color:var(--dark-text); }
        .light .modal-close { color:var(--light-text); }
        .modal-close:hover { opacity:1; }

        /* NOTIFICATIONS */
        .notifications { position:fixed; top:1rem; right:1rem; z-index:2000; display:flex; flex-direction:column; gap:0.5rem; }
        .notification {
            padding:0.85rem 1.25rem; border-radius:var(--radius-xs); color:white; font-weight:500; font-size:0.88rem;
            display:flex; align-items:center; gap:0.5rem;
            transform:translateX(120%); animation:slideInRight 0.35s ease forwards;
            max-width:320px; box-shadow:0 8px 24px rgba(0,0,0,0.2); backdrop-filter:blur(8px);
        }
        .notification.success { background:rgba(5,150,105,0.95); }
        .notification.error { background:rgba(220,38,38,0.95); }
        .notification.warning { background:rgba(217,119,6,0.95); }
        .notification.info { background:rgba(13,148,136,0.95); }

        /* FLOATING CALC */
        .floating-calc-btn {
            position:fixed; bottom:24px; right:24px; width:52px; height:52px; border-radius:50%;
            background:linear-gradient(135deg,var(--primary-dark),var(--primary));
            color:white; border:none; cursor:pointer;
            box-shadow:0 4px 20px var(--primary-glow); display:flex; align-items:center; justify-content:center;
            z-index:150; transition:all var(--transition);
        }
        .floating-calc-btn:hover { transform:scale(1.1); box-shadow:0 6px 28px var(--primary-glow); }
        .floating-calc-btn svg { width:22px; height:22px; }

        .calc-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.4); backdrop-filter:blur(8px);
            z-index:998; opacity:0; visibility:hidden; transition:all 0.25s ease;
            display:flex; align-items:center; justify-content:center; padding:1rem;
        }
        .calc-overlay.active { opacity:1; visibility:visible; }
        .calc-window {
            width:100%; max-width:320px; border-radius:var(--radius); padding:1rem;
            box-shadow:0 20px 50px rgba(0,0,0,0.3); border:1px solid var(--dark-border);
        }
        .dark .calc-window { background:var(--dark-surface); }
        .light .calc-window { background:var(--light-surface); border-color:var(--light-border); }
        .calc-display {
            width:100%; padding:1rem; font-size:1.6rem; font-weight:700; text-align:right;
            border:none; border-radius:var(--radius-xs); margin-bottom:0.75rem; font-family:inherit;
        }
        .dark .calc-display { background:var(--dark-card); color:var(--dark-text); }
        .light .calc-display { background:var(--light-card); color:var(--light-text); }
        .calc-buttons { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; }
        .calc-btn {
            padding:0.9rem; font-size:1.1rem; font-weight:600; border:none; border-radius:var(--radius-xs);
            cursor:pointer; transition:all 0.1s; font-family:inherit;
        }
        .dark .calc-btn { background:var(--dark-card); color:var(--dark-text); }
        .light .calc-btn { background:var(--light-card); color:var(--light-text); }
        .calc-btn:active { transform:scale(0.95); }
        .calc-btn.operator { background:rgba(13,148,136,0.2); color:var(--primary-light); }
        .calc-btn.equals { background:var(--success); color:white; }
        .calc-btn.clear { background:rgba(239,68,68,0.2); color:var(--danger-light); }
        .calc-btn.zero { grid-column:span 2; }

        /* EMPTY STATE */
        .empty-state { text-align:center; padding:2.5rem 1rem; opacity:0.5; font-size:0.9rem; }

        /* UTILITIES */
        .text-center { text-align:center; }
        .text-right { text-align:right; }
        .mb-1 { margin-bottom:0.5rem; }
        .mb-2 { margin-bottom:1rem; }
        .mb-3 { margin-bottom:1.5rem; }
        .mt-1 { margin-top:0.5rem; }
        .mt-2 { margin-top:1rem; }
        .flex { display:flex; }
        .items-center { align-items:center; }
        .justify-between { justify-content:space-between; }
        .gap-1 { gap:0.5rem; }
        .gap-2 { gap:1rem; }
        .hidden { display:none; }
        .w-full { width:100%; }

        /* RESPONSIVE */
        @media(max-width:768px) {
            .month-year-filters { grid-template-columns:1fr; gap:0.75rem; }
            .main-content { padding:0.5rem; }
            .stats-grid { grid-template-columns:1fr 1fr 1fr; gap:0.5rem; }
            .stat-card { padding:0.85rem 0.5rem; }
            .stat-value { font-size:clamp(0.7rem,3vw,1.1rem); }
            .stat-icon { font-size:1.2rem; }
            .btn-group { justify-content:center; gap:0.5rem; }
            .btn { padding:0.55rem 0.9rem; font-size:0.85rem; flex:1; justify-content:center; min-width:0; }
            .backup-grid { grid-template-columns:1fr 1fr; gap:0.5rem; }
            .backup-btn { min-width:auto; padding:0.75rem 0.75rem; font-size:0.85rem; }
            .transaction-item { flex-direction:column; align-items:stretch; gap:0.5rem; padding:0.7rem; }
            .transaction-info { text-align:center; }
            .transaction-amount { text-align:center; margin-right:0; font-size:clamp(0.8rem,3vw,1.1rem); }
            .transaction-actions { justify-content:center; gap:0.5rem; }
            .action-btn { padding:0.5rem 0.75rem; flex:1; justify-content:center; }
            .goal-header { flex-direction:column; gap:0.5rem; }
            .goal-item { padding:1rem; }
            .modal { width:95%; padding:1.25rem; }
            .notifications { left:0.5rem; right:0.5rem; }
            .notification { max-width:none; }
            .card { padding:1rem; }
            .search-filters { grid-template-columns:1fr; gap:0.75rem; }
            .search-actions { justify-content:center; }
            .chart-filters { grid-template-columns:1fr; }
            .side-menu { width:280px; }
            .menu-item { padding:0.75rem 1rem; font-size:0.88rem; }
            .progress-text { flex-direction:column; gap:0.2rem; text-align:center; }
            #emptyTrashBtn { padding:0.55rem 0.75rem; font-size:0.9rem; align-self:stretch; min-width:0; }
            #transactionForm .btn-group-round .btn { width:50px; height:50px; min-width:50px; }
            #transactionForm .btn-group-round .btn svg { width:20px; height:20px; }
        }
        @media(max-width:480px) {
            .header { padding:0.5rem 0.75rem; gap:0.35rem; }
            .header-title { font-size:0.95rem; }
            .main-content { padding:0.25rem; }
            .card { padding:0.75rem; margin-bottom:0.75rem; }
            .stat-card { padding:0.65rem 0.35rem; }
            .stat-value { font-size:clamp(0.65rem,3vw,1rem); }
            .stat-icon { font-size:1rem; margin-bottom:0.15rem; }
            .stat-label { font-size:0.6rem; }
            .stats-grid { gap:0.35rem; }
            .btn { padding:0.5rem 0.65rem; font-size:0.8rem; }
            .backup-btn { padding:0.6rem; font-size:0.82rem; }
            .backup-grid { grid-template-columns:1fr; }
            .transaction-item { padding:0.5rem; }
            .action-btn { padding:0.35rem 0.5rem; font-size:0.78rem; }
            .form-input,.form-select,.form-textarea { padding:0.55rem 0.7rem; font-size:0.88rem; }
            .modal { padding:1rem; }
            .side-menu { width:260px; }
            .menu-item { padding:0.65rem 0.75rem; font-size:0.85rem; }
            .date-nav-arrow { width:28px; height:28px; min-width:28px; }
            .date-nav-arrow svg { width:14px; height:14px; }
            .floating-calc-btn { width:46px; height:46px; bottom:18px; right:18px; }
            .floating-calc-btn svg { width:18px; height:18px; }
            .calc-display { font-size:clamp(1rem,5vw,1.4rem); padding:0.75rem; }
            .calc-btn { padding:0.8rem; font-size:1rem; min-height:44px; }
            .splash-title { font-size:20px; }
            .splash-subtitle { font-size:12px; }
            .splash-logo { width:80px; height:80px; border-radius:20px; }
            #emptyTrashBtn { width:100%; justify-content:center; }
            #transactionForm .btn-group-round .btn { width:46px; height:46px; min-width:46px; }
            #transactionForm .btn-group-round .btn svg { width:18px; height:18px; }
            #transactionForm .btn-group-round { gap:0.75rem; }
        }
        @media(max-width:360px) {
            .header-title { font-size:0.85rem; }
            .lang-btn { padding:4px 6px; font-size:0.9rem; }
            .theme-toggle { padding:4px 6px; font-size:0.9rem; }
        }
    </style>
</head>
<body class="dark">
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
        </div>
        <h1 class="splash-title">Controle Financeiro</h1>
        <p class="splash-subtitle">Gerencie suas finan√ßas de forma inteligente</p>
        <div class="splash-loader"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <button class="menu-button" onclick="toggleMenu()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
        </button>
        <div class="header-title-wrapper">
            <h1 class="header-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                <span data-i18n="appTitle">Controle Financeiro</span>
            </h1>
            <div class="header-clock" id="headerClock">
                <div class="header-clock-inner">
                    <span class="header-clock-time" id="clockTime">00:00:00</span>
                    <span class="header-clock-date" id="clockDate">--/--/----</span>
                </div>
            </div>
        </div>
        <div class="header-controls">
            <div class="lang-buttons">
                <button type="button" class="lang-btn active" id="langPt" onclick="setLanguage('pt-BR')" title="Portugues">&#x1F1E7;&#x1F1F7;</button>
                <button type="button" class="lang-btn" id="langEn" onclick="setLanguage('en')" title="English">&#x1F1FA;&#x1F1F8;</button>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">&#127769;</button>
        </div>
    </header>

    <!-- Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

    <!-- Side Menu -->
    <nav class="side-menu" id="sideMenu">
        <div class="menu-header">
            <h2 data-i18n="menu">Menu</h2>
            <button class="menu-close" onclick="closeMenu()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="menu-items">
            <button class="menu-item active" onclick="showTab('new-transaction', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                <span data-i18n="menuNewTransaction">Nova Transacao</span>
            </button>
            <button class="menu-item" onclick="showTab('transactions', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                <span data-i18n="menuTransactions">Transacoes</span>
            </button>
            <button class="menu-item" onclick="showTab('search', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <span data-i18n="menuSearch">Buscar</span>
            </button>
            <button class="menu-item" onclick="showTab('charts', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                <span data-i18n="menuCharts">Grafico</span>
            </button>
            <button class="menu-item" onclick="showTab('summaries', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                <span data-i18n="menuSummaries">Resumos</span>
            </button>
            <button class="menu-item" onclick="showTab('goals', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polygon points="10,8 16,12 10,16 10,8"/></svg>
                <span data-i18n="menuGoals">Metas</span>
            </button>
            <button class="menu-item" onclick="showTab('trash', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                <span data-i18n="menuTrash">Lixeira</span>
            </button>
            <button class="menu-item" onclick="showTab('backup', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <span data-i18n="menuBackup">Backup</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <div class="card"><h2 class="mb-2" data-i18n="allTransactions">Todas as Transacoes</h2><div id="transactionsList"></div></div>
        </div>

        <!-- Search Tab -->
        <div id="search" class="tab-content">
            <div class="card">
                <h2 class="mb-2" data-i18n="searchTransactions">Buscar Transacoes</h2>
                <div class="search-section">
                    <div class="search-filters">
                        <div class="form-group"><label class="form-label" data-i18n="searchByName">Buscar por nome/descricao</label><input type="text" id="searchDescription" class="form-input" data-i18n-placeholder="placeholderDesc" placeholder="Digite a descricao..." oninput="performSearch()"></div>
                        <div class="form-group"><label class="form-label" data-i18n="category">Categoria</label>
                            <select id="searchCategory" class="form-select" onchange="performSearch()">
                                <option value="" data-i18n="allCategories">Todas as categorias</option>
                                <option value="alimentacao">&#127869; Alimentacao</option><option value="mercado">&#128722; Mercado</option><option value="combustivel">&#9981; Combustivel</option><option value="manutencao_veiculo">&#128295; Manutencao Veiculo</option><option value="transporte">&#128663; Transporte</option><option value="moradia">&#127968; Moradia</option><option value="saude">&#127973; Saude</option><option value="educacao">&#128218; Educacao</option><option value="lazer">&#127918; Lazer</option><option value="salario">&#128188; Salario</option><option value="freelance">&#128187; Freelance</option><option value="investimentos">&#128200; Investimentos</option><option value="outros">&#128230; Outros</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label" data-i18n="type">Tipo</label>
                            <select id="searchType" class="form-select" onchange="performSearch()">
                                <option value="" data-i18n="allTypes">Todos os tipos</option><option value="income" data-i18n="income">Receita</option><option value="expense" data-i18n="expense">Despesa</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label" data-i18n="monthYear">Mes/Ano</label>
                            <div class="month-year-filters">
                                <div class="form-group" style="margin-bottom:0;"><label class="form-label" data-i18n="selectMonth" style="font-size:0.8rem;margin-bottom:0.3rem;">Mes</label>
                                    <button type="button" class="form-input" id="monthPickerButton" onclick="showMonthPickerModal()" style="text-align:left;cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
                                        <span id="monthPickerButtonText" data-i18n="selectMonth">Selecionar Mes</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"></polyline></svg>
                                    </button>
                                    <input type="hidden" id="selectedMonths" value="">
                                </div>
                                <div class="form-group" style="margin-bottom:0;"><label class="form-label" data-i18n="selectYear" style="font-size:0.8rem;margin-bottom:0.3rem;">Ano</label>
                                    <select id="searchYear" class="form-select" onchange="performSearch()"><option value="">Todos os anos</option></select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group form-group-checkbox"><label class="form-label form-label-checkbox"><input type="checkbox" id="searchFavorites" onchange="performSearch()"> &#11088; <span data-i18n="favoritesOnly">Apenas favoritas</span></label></div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" onclick="performSearch()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><span data-i18n="search">Buscar</span></button>
                        <button class="btn btn-secondary" onclick="clearSearch()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/></svg><span data-i18n="clearFilters">Limpar Filtros</span></button>
                        <button class="btn btn-success" onclick="exportSearchResultsToExcel()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span data-i18n="exportResults">Exportar Resultados</span></button>
                    </div>
                </div>
                <div class="search-results">
                    <div class="search-result-header"><h3 data-i18n="searchResults">Resultados da Busca</h3><span class="search-result-count" id="searchResultCount">0 transacoes encontradas</span></div>
                    <div class="card mb-2" id="searchTotalsCard" style="display:none;">
                        <div class="stats-grid">
                            <div class="stat-card income"><div class="stat-value" id="searchTotalIncome">R$ 0,00</div><div class="stat-label" data-i18n="searchIncome">Receitas na Busca</div></div>
                            <div class="stat-card expense"><div class="stat-value" id="searchTotalExpense">R$ 0,00</div><div class="stat-label" data-i18n="searchExpense">Despesas na Busca</div></div>
                            <div class="stat-card balance"><div class="stat-value" id="searchTotalBalance">R$ 0,00</div><div class="stat-label" data-i18n="searchBalance">Saldo da Busca</div></div>
                        </div>
                    </div>
                    <div id="searchResultsList"></div>
                </div>
            </div>
        </div>

        <!-- New Transaction Tab -->
        <div id="new-transaction" class="tab-content active">
            <div class="card">
                <h2 class="mb-2" data-i18n="newTransaction">Nova Transacao</h2>
                <form id="transactionForm">
                    <div class="form-group"><label class="form-label" data-i18n="date">Data</label>
                        <div class="date-nav-container">
                            <button type="button" class="date-nav-arrow" onclick="previousDay()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                            <input type="date" id="transactionDate" class="form-input" required style="flex:1;">
                            <button type="button" class="date-nav-arrow" onclick="nextDay()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label" data-i18n="value">Valor (R$)</label><input type="number" id="transactionValue" class="form-input" step="0.01" min="0" placeholder="0,00" required></div>
                    <div class="form-group"><label class="form-label" data-i18n="category">Categoria</label>
                        <select id="transactionCategory" class="form-select" required>
                            <option value="" data-i18n="selectCategory">Selecione uma categoria</option>
                            <option value="alimentacao">&#127869; Alimentacao</option><option value="mercado">&#128722; Mercado</option><option value="combustivel">&#9981; Combustivel</option><option value="manutencao_veiculo">&#128295; Manutencao Veiculo</option><option value="transporte">&#128663; Transporte</option><option value="moradia">&#127968; Moradia</option><option value="saude">&#127973; Saude</option><option value="educacao">&#128218; Educacao</option><option value="lazer">&#127918; Lazer</option><option value="salario">&#128188; Salario</option><option value="freelance">&#128187; Freelance</option><option value="investimentos">&#128200; Investimentos</option><option value="outros">&#128230; Outros</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label" data-i18n="description">Descricao</label><textarea id="transactionDescription" class="form-textarea" data-i18n-placeholder="placeholderDesc" placeholder="Descreva a transacao..." required></textarea></div>
                    <div class="form-group form-group-checkbox"><label class="form-label form-label-checkbox"><input type="checkbox" id="transactionFavorite"> &#11088; <span data-i18n="favoriteTransaction">Favoritar esta transacao</span></label></div>
                    <div class="btn-group btn-group-round">
                        <button type="button" class="btn btn-success" onclick="addTransaction('income')" data-i18n-title="income" title="Receita"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                        <button type="button" class="btn btn-danger" onclick="addTransaction('expense')" data-i18n-title="expense" title="Despesa"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                        <button type="button" class="btn btn-secondary" onclick="clearTransactionForm()" data-i18n-title="clear" title="Limpar"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/></svg></button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3 class="mb-2" data-i18n="dailyTransactions">Transacoes do Dia Selecionado</h3>
                <div class="stats-grid mb-2">
                    <div class="stat-card income"><div class="stat-icon">&#128176;</div><div class="stat-value" id="dailyIncome">R$ 0,00</div><div class="stat-label" data-i18n="gains">Ganhos</div></div>
                    <div class="stat-card expense"><div class="stat-icon">&#128184;</div><div class="stat-value" id="dailyExpense">R$ 0,00</div><div class="stat-label" data-i18n="spending">Gastos</div></div>
                    <div class="stat-card balance"><div class="stat-icon">&#128202;</div><div class="stat-value" id="dailyBalance">R$ 0,00</div><div class="stat-label" data-i18n="balance">Saldo</div></div>
                </div>
                <div id="dailyTransactionsList"></div>
            </div>
        </div>

        <!-- Charts Tab -->
        <div id="charts" class="tab-content">
            <div class="card">
                <h2 class="mb-2" data-i18n="chartsTitle">Graficos de Receitas e Despesas</h2>
                <div class="chart-filters">
                    <div class="form-group"><label class="form-label" data-i18n="period">Periodo</label>
                        <select id="chartPeriod" class="form-select" onchange="toggleChartPeriodInputs();updateChart();">
                            <option value="month" data-i18n="monthSpecific">Mes especifico</option><option value="week" data-i18n="weekSpecific">Semana especifica</option><option value="year" data-i18n="yearSpecific">Ano especifico</option><option value="last3" data-i18n="last3Months">Ultimos 3 meses</option><option value="last6" data-i18n="last6Months">Ultimos 6 meses</option>
                        </select>
                    </div>
                    <div class="form-group chart-period-input" id="chartMonthGroup"><label class="form-label" data-i18n="month">Mes</label><input type="month" id="chartMonth" class="form-input" onchange="updateChart()"></div>
                    <div class="form-group chart-period-input" id="chartWeekGroup" style="display:none;"><label class="form-label" data-i18n="week">Semana</label><input type="week" id="chartWeek" class="form-input" onchange="updateChart()"></div>
                    <div class="form-group chart-period-input" id="chartYearGroup" style="display:none;"><label class="form-label" data-i18n="year">Ano</label><input type="number" id="chartYear" class="form-input" min="2020" max="2030" onchange="updateChart()"></div>
                    <div class="form-group"><label class="form-label" data-i18n="view">Visualizar</label>
                        <select id="chartTypeFilter" class="form-select" onchange="updateChart()"><option value="both" data-i18n="incomeExpense">Receitas e Despesas</option><option value="expense" data-i18n="expenseOnly">Apenas Despesas</option><option value="income" data-i18n="incomeOnly">Apenas Receitas</option></select>
                    </div>
                    <div class="form-group"><label class="form-label" data-i18n="chartType">Tipo de grafico</label>
                        <div class="chart-type-toggle">
                            <button type="button" class="chart-type-btn active" data-type="pie" onclick="setChartType('pie')">&#129383; <span data-i18n="pie">Pizza</span></button>
                            <button type="button" class="chart-type-btn" data-type="bar" onclick="setChartType('bar')">&#128202; <span data-i18n="bar">Barras</span></button>
                        </div>
                    </div>
                </div>
                <div class="chart-container-wrapper"><canvas id="financeChart"></canvas></div>
            </div>
        </div>

        <!-- Summaries Tab -->
        <div id="summaries" class="tab-content">
            <div class="summary-section">
                <div class="summary-header" onclick="toggleSummary('daily')"><div class="summary-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span data-i18n="dailySummary">Resumo Diario</span></div><svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"/></svg></div>
                <div class="summary-content" id="dailySummaryContent"><div class="summary-body"><div class="form-group"><label class="form-label" data-i18n="selectDay">Selecionar Dia</label><input type="date" id="dailySummaryDate" class="form-input" onchange="updateDailySummary()"></div><div class="stats-grid mb-2"><div class="stat-card income"><div class="stat-value" id="dailySummaryIncome">R$ 0,00</div><div class="stat-label" data-i18n="gains">Ganhos</div></div><div class="stat-card expense"><div class="stat-value" id="dailySummaryExpense">R$ 0,00</div><div class="stat-label" data-i18n="spending">Gastos</div></div><div class="stat-card balance"><div class="stat-value" id="dailySummaryBalance">R$ 0,00</div><div class="stat-label" data-i18n="balance">Saldo</div></div></div><div id="dailySummaryTransactions"></div></div></div>
            </div>
            <div class="summary-section">
                <div class="summary-header" onclick="toggleSummary('weekly')"><div class="summary-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span data-i18n="weeklySummary">Resumo Semanal</span></div><svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"/></svg></div>
                <div class="summary-content" id="weeklySummaryContent"><div class="summary-body"><div class="form-group"><label class="form-label" data-i18n="selectWeek">Selecionar Semana</label><input type="week" id="weeklySummaryDate" class="form-input" onchange="updateWeeklySummary()"></div><div class="stats-grid mb-2"><div class="stat-card income"><div class="stat-value" id="weeklySummaryIncome">R$ 0,00</div><div class="stat-label" data-i18n="gains">Ganhos</div></div><div class="stat-card expense"><div class="stat-value" id="weeklySummaryExpense">R$ 0,00</div><div class="stat-label" data-i18n="spending">Gastos</div></div><div class="stat-card balance"><div class="stat-value" id="weeklySummaryBalance">R$ 0,00</div><div class="stat-label" data-i18n="balance">Saldo</div></div></div><div id="weeklySummaryTransactions"></div></div></div>
            </div>
            <div class="summary-section">
                <div class="summary-header" onclick="toggleSummary('monthly')"><div class="summary-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span data-i18n="monthlySummary">Resumo Mensal</span></div><svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"/></svg></div>
                <div class="summary-content" id="monthlySummaryContent"><div class="summary-body"><div class="form-group"><label class="form-label" data-i18n="selectMonth">Selecionar Mes</label><input type="month" id="monthlySummaryDate" class="form-input" onchange="updateMonthlySummary()"></div><div class="stats-grid mb-2"><div class="stat-card income"><div class="stat-value" id="monthlySummaryIncome">R$ 0,00</div><div class="stat-label" data-i18n="gains">Ganhos</div></div><div class="stat-card expense"><div class="stat-value" id="monthlySummaryExpense">R$ 0,00</div><div class="stat-label" data-i18n="spending">Gastos</div></div><div class="stat-card balance"><div class="stat-value" id="monthlySummaryBalance">R$ 0,00</div><div class="stat-label" data-i18n="balance">Saldo</div></div></div><div id="monthlySummaryTransactions"></div></div></div>
            </div>
            <div class="summary-section">
                <div class="summary-header" onclick="toggleSummary('yearly')"><div class="summary-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span data-i18n="yearlySummary">Resumo Anual</span></div><svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"/></svg></div>
                <div class="summary-content" id="yearlySummaryContent"><div class="summary-body"><div class="form-group"><label class="form-label" data-i18n="selectYear">Selecionar Ano</label><input type="number" id="yearlySummaryDate" class="form-input" min="2020" max="2030" onchange="updateYearlySummary()"></div><div class="stats-grid mb-2"><div class="stat-card income"><div class="stat-value" id="yearlySummaryIncome">R$ 0,00</div><div class="stat-label" data-i18n="gains">Ganhos</div></div><div class="stat-card expense"><div class="stat-value" id="yearlySummaryExpense">R$ 0,00</div><div class="stat-label" data-i18n="spending">Gastos</div></div><div class="stat-card balance"><div class="stat-value" id="yearlySummaryBalance">R$ 0,00</div><div class="stat-label" data-i18n="balance">Saldo</div></div></div><div id="yearlySummaryTransactions"></div></div></div>
            </div>
        </div>

        <!-- Goals Tab -->
        <div id="goals" class="tab-content">
            <div class="card"><div class="flex justify-between items-center mb-2"><h2 data-i18n="financialGoals">Metas Financeiras</h2><button class="btn btn-primary" onclick="showAddGoalModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span data-i18n="newGoal">Nova Meta</span></button></div><div id="goalsList"></div></div>
        </div>

        <!-- Trash Tab -->
        <div id="trash" class="tab-content">
            <div class="card">
                <div class="flex justify-between items-center mb-2"><button type="button" class="btn btn-danger" onclick="emptyTrash()" id="emptyTrashBtn" style="display:none;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg><span data-i18n="emptyTrash">Esvaziar lixeira</span></button></div>
                <p class="mb-2" style="opacity:0.6;font-size:0.85rem;" data-i18n="trashInfo">Transacoes excluidas podem ser restauradas ou removidas permanentemente.</p>
                <div id="trashList"></div>
            </div>
        </div>

        <!-- Backup Tab -->
        <div id="backup" class="tab-content">
            <div class="card">
                <h2 class="mb-2" data-i18n="backupExport">Backup e Exportacao</h2>
                <div class="backup-grid">
                    <button class="backup-btn backup-btn-export" onclick="exportData()"><div class="backup-btn-icon">&#128228;</div><span data-i18n="exportJson">Exportar JSON</span></button>
                    <button class="backup-btn backup-btn-import" onclick="document.getElementById('importFile').click()"><div class="backup-btn-icon">&#128229;</div><span data-i18n="importJson">Importar JSON</span></button>
                    <button class="backup-btn backup-btn-excel" onclick="showExportExcelModal()"><div class="backup-btn-icon">&#128202;</div><span data-i18n="exportExcel">Exportar Excel</span></button>
                    <button class="backup-btn backup-btn-clear" onclick="clearAllData()"><div class="backup-btn-icon">&#128465;</div><span data-i18n="clearAll">Limpar Tudo</span></button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
            </div>
        </div>
    </main>

    <!-- Edit Transaction Modal -->
    <div class="modal-overlay" id="editTransactionModal"><div class="modal"><div class="modal-header"><h3 class="modal-title" data-i18n="editTransaction">Editar Transacao</h3><button class="modal-close" onclick="closeModal('editTransactionModal')">&times;</button></div>
        <form id="editTransactionForm">
            <div class="form-group"><label class="form-label" data-i18n="date">Data</label><input type="date" id="editTransactionDate" class="form-input" required></div>
            <div class="form-group"><label class="form-label" data-i18n="value">Valor (R$)</label><input type="number" id="editTransactionValue" class="form-input" step="0.01" min="0" required></div>
            <div class="form-group"><label class="form-label" data-i18n="category">Categoria</label>
                <select id="editTransactionCategory" class="form-select" required><option value="">Selecione uma categoria</option><option value="alimentacao">&#127869; Alimentacao</option><option value="mercado">&#128722; Mercado</option><option value="combustivel">&#9981; Combustivel</option><option value="manutencao_veiculo">&#128295; Manutencao Veiculo</option><option value="transporte">&#128663; Transporte</option><option value="moradia">&#127968; Moradia</option><option value="saude">&#127973; Saude</option><option value="educacao">&#128218; Educacao</option><option value="lazer">&#127918; Lazer</option><option value="salario">&#128188; Salario</option><option value="freelance">&#128187; Freelance</option><option value="investimentos">&#128200; Investimentos</option><option value="outros">&#128230; Outros</option></select>
            </div>
            <div class="form-group"><label class="form-label" data-i18n="description">Descricao</label><textarea id="editTransactionDescription" class="form-textarea" required></textarea></div>
            <div class="form-group form-group-checkbox"><label class="form-label form-label-checkbox"><input type="checkbox" id="editTransactionFavorite"> &#11088; <span data-i18n="favoriteTransaction">Favoritar esta transacao</span></label></div>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" onclick="saveTransactionEdit()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg><span data-i18n="save">Salvar</span></button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('editTransactionModal')"><span data-i18n="cancel">Cancelar</span></button>
            </div>
        </form>
    </div></div>

    <!-- Add Goal Modal -->
    <div class="modal-overlay" id="addGoalModal"><div class="modal"><div class="modal-header"><h3 class="modal-title" data-i18n="addGoal">Nova Meta</h3><button class="modal-close" onclick="closeModal('addGoalModal')">&times;</button></div>
        <form id="addGoalForm">
            <div class="form-group"><label class="form-label" data-i18n="goalDescription">Descricao da Meta</label><input type="text" id="goalDescription" class="form-input" data-i18n-placeholder="goalPlaceholder" placeholder="Ex: Comprar um carro" required></div>
            <div class="form-group"><label class="form-label" data-i18n="goalTarget">Valor da Meta (R$)</label><input type="number" id="goalTarget" class="form-input" step="0.01" min="0" placeholder="0,00" required></div>
            <div class="form-group"><label class="form-label" data-i18n="goalCurrent">Valor Atual (R$)</label><input type="number" id="goalCurrent" class="form-input" step="0.01" min="0" placeholder="0,00" value="0"></div>
            <div class="btn-group"><button type="button" class="btn btn-primary" onclick="addGoal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg><span data-i18n="saveGoal">Salvar Meta</span></button><button type="button" class="btn btn-secondary" onclick="closeModal('addGoalModal')"><span data-i18n="cancel">Cancelar</span></button></div>
        </form>
    </div></div>

    <!-- Edit Goal Modal -->
    <div class="modal-overlay" id="editGoalModal"><div class="modal"><div class="modal-header"><h3 class="modal-title" data-i18n="editGoal">Editar Meta</h3><button class="modal-close" onclick="closeModal('editGoalModal')">&times;</button></div>
        <form id="editGoalForm">
            <div class="form-group"><label class="form-label" data-i18n="goalDescription">Descricao da Meta</label><input type="text" id="editGoalDescription" class="form-input" required></div>
            <div class="form-group"><label class="form-label" data-i18n="goalTarget">Valor da Meta (R$)</label><input type="number" id="editGoalTarget" class="form-input" step="0.01" min="0" required></div>
            <div class="form-group"><label class="form-label" data-i18n="goalCurrent">Valor Atual (R$)</label><input type="number" id="editGoalCurrent" class="form-input" step="0.01" min="0"></div>
            <div class="btn-group"><button type="button" class="btn btn-primary" onclick="saveGoalEdit()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg><span data-i18n="save">Salvar</span></button><button type="button" class="btn btn-secondary" onclick="closeModal('editGoalModal')"><span data-i18n="cancel">Cancelar</span></button></div>
        </form>
    </div></div>

    <!-- Month Picker Modal -->
    <div class="modal-overlay" id="monthPickerModal"><div class="modal"><div class="modal-header"><h3 class="modal-title" data-i18n="selectMonth">Selecionar Mes</h3><button class="modal-close" onclick="closeMonthPickerModal()">&times;</button></div>
        <div class="month-picker-container" id="monthPickerContainer">
            <div class="month-picker-header"><span class="month-picker-year" id="monthPickerYear">2026</span><div class="month-picker-nav"><button type="button" class="month-picker-nav-btn" onclick="changeMonthPickerYear(1)">&#9650;</button><button type="button" class="month-picker-nav-btn" onclick="changeMonthPickerYear(-1)">&#9660;</button></div></div>
            <div class="month-picker-grid" id="monthPickerGrid"></div>
            <div class="month-picker-grid" id="monthPickerGridOtherYear" style="opacity:0.4;"></div>
        </div>
    </div></div>

    <!-- Export Excel Modal -->
    <div class="modal-overlay" id="exportExcelModal"><div class="modal"><div class="modal-header"><h3 class="modal-title" data-i18n="exportToExcel">Exportar para Excel</h3><button class="modal-close" onclick="closeModal('exportExcelModal')">&times;</button></div>
        <form id="exportExcelForm">
            <div class="form-group"><label class="form-label" data-i18n="period">Periodo</label><select id="exportPeriod" class="form-select" onchange="updateExportDateField()"><option value="all" data-i18n="allRecords">Todos os registros</option><option value="month" data-i18n="monthSpecific">Mes especifico</option><option value="year" data-i18n="yearSpecific">Ano especifico</option></select></div>
            <div class="form-group" id="exportDateGroup" style="display:none;"><label class="form-label" id="exportDateLabel" data-i18n="date">Data</label><input type="month" id="exportDate" class="form-input"></div>
            <div class="form-group"><label class="form-label" data-i18n="category">Categoria</label>
                <select id="exportCategory" class="form-select"><option value="all" data-i18n="allCategories">Todas as categorias</option><option value="income" data-i18n="onlyIncome">Apenas ganhos</option><option value="expense" data-i18n="onlyExpense">Apenas gastos</option><option value="alimentacao">&#127869; Alimentacao</option><option value="mercado">&#128722; Mercado</option><option value="combustivel">&#9981; Combustivel</option><option value="manutencao_veiculo">&#128295; Manutencao Veiculo</option><option value="transporte">&#128663; Transporte</option><option value="moradia">&#127968; Moradia</option><option value="saude">&#127973; Saude</option><option value="educacao">&#128218; Educacao</option><option value="lazer">&#127918; Lazer</option><option value="salario">&#128188; Salario</option><option value="freelance">&#128187; Freelance</option><option value="investimentos">&#128200; Investimentos</option><option value="outros">&#128230; Outros</option></select>
            </div>
            <div class="btn-group"><button type="button" class="btn btn-success" onclick="exportFilteredToExcel()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span data-i18n="exportExcel">Exportar Excel</span></button><button type="button" class="btn btn-secondary" onclick="closeModal('exportExcelModal')"><span data-i18n="cancel">Cancelar</span></button></div>
        </form>
    </div></div>

    <!-- Floating Calculator -->
    <button class="floating-calc-btn" onclick="toggleCalculator()" title="Calculadora">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="8" y2="10.01"/><line x1="12" y1="10" x2="12" y2="10.01"/><line x1="16" y1="10" x2="16" y2="10.01"/><line x1="8" y1="14" x2="8" y2="14.01"/><line x1="12" y1="14" x2="12" y2="14.01"/><line x1="16" y1="14" x2="16" y2="14.01"/><line x1="8" y1="18" x2="8" y2="18.01"/><line x1="12" y1="18" x2="12" y2="18.01"/><line x1="16" y1="18" x2="16" y2="18.01"/></svg>
    </button>

    <!-- Calculator Overlay -->
    <div class="calc-overlay" id="calcOverlay" onclick="if(event.target===this) toggleCalculator()">
        <div class="calc-window" onclick="event.stopPropagation()">
            <input type="text" class="calc-display" id="calcDisplay" readonly value="0">
            <div class="calc-buttons">
                <button type="button" class="calc-btn clear" onclick="calcClear()">C</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('\u00B1')">&#177;</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('%')">%</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('/')">/</button>
                <button type="button" class="calc-btn" onclick="calcInput('7')">7</button>
                <button type="button" class="calc-btn" onclick="calcInput('8')">8</button>
                <button type="button" class="calc-btn" onclick="calcInput('9')">9</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('*')">&#215;</button>
                <button type="button" class="calc-btn" onclick="calcInput('4')">4</button>
                <button type="button" class="calc-btn" onclick="calcInput('5')">5</button>
                <button type="button" class="calc-btn" onclick="calcInput('6')">6</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('-')">&#8722;</button>
                <button type="button" class="calc-btn" onclick="calcInput('1')">1</button>
                <button type="button" class="calc-btn" onclick="calcInput('2')">2</button>
                <button type="button" class="calc-btn" onclick="calcInput('3')">3</button>
                <button type="button" class="calc-btn operator" onclick="calcInput('+')">+</button>
                <button type="button" class="calc-btn zero" onclick="calcInput('0')">0</button>
                <button type="button" class="calc-btn" onclick="calcInput('.')">.</button>
                <button type="button" class="calc-btn equals" onclick="calcEquals()">=</button>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div class="notifications" id="notifications"></div>

    <script>
        let transactions=[];let goals=[];let editingTransactionId=null;let editingGoalId=null;let lastSearchResults=[];let financeChartInstance=null;let currentChartType='pie';
        var trashStorageKey='financialTrash_v2';
        function getTrashFromStorage(){try{var r=localStorage.getItem(trashStorageKey);return r?JSON.parse(r):[];}catch(e){return[];}}
        function saveTrashToStorage(a){try{localStorage.setItem(trashStorageKey,JSON.stringify(a));}catch(e){}}
        function getActiveTransactions(){return transactions.filter(function(t){return!t.deleted;});}
        function getTrashTransactions(){var fs=getTrashFromStorage();var fm=transactions.filter(function(t){return t.deleted===true||t.deleted==='true'||t.deleted===1;});var seen={};var out=[];fs.forEach(function(t){var k=String(t.id);if(!seen[k]){seen[k]=true;out.push(t);}});fm.forEach(function(t){var k=String(t.id);if(!seen[k]){seen[k]=true;out.push(t);}});return out;}

        const categories={'alimentacao':'\u{1F37D}\uFE0F Alimenta\u00E7\u00E3o','mercado':'\u{1F6D2} Mercado','combustivel':'\u26FD Combust\u00EDvel','manutencao_veiculo':'\u{1F527} Manuten\u00E7\u00E3o Ve\u00EDculo','transporte':'\u{1F697} Transporte','moradia':'\u{1F3E0} Moradia','saude':'\u{1F3E5} Sa\u00FAde','educacao':'\u{1F4DA} Educa\u00E7\u00E3o','lazer':'\u{1F3AE} Lazer','salario':'\u{1F4BC} Sal\u00E1rio','freelance':'\u{1F4BB} Freelance','investimentos':'\u{1F4C8} Investimentos','outros':'\u{1F4E6} Outros'};
        const categoryOrder=['alimentacao','mercado','combustivel','manutencao_veiculo','transporte','moradia','saude','educacao','lazer','salario','freelance','investimentos','outros'];
        function getCategoryLabel(cat){const lang=currentLang||localStorage.getItem('lang')||'pt-BR';return lang==='en'?(categoriesEn[cat]||categories[cat]):(categories[cat]||cat);}
        const categoriesEn={'alimentacao':'\u{1F37D}\uFE0F Food','mercado':'\u{1F6D2} Groceries','combustivel':'\u26FD Fuel','manutencao_veiculo':'\u{1F527} Vehicle Maintenance','transporte':'\u{1F697} Transport','moradia':'\u{1F3E0} Housing','saude':'\u{1F3E5} Health','educacao':'\u{1F4DA} Education','lazer':'\u{1F3AE} Entertainment','salario':'\u{1F4BC} Salary','freelance':'\u{1F4BB} Freelance','investimentos':'\u{1F4C8} Investments','outros':'\u{1F4E6} Other'};

        const i18n={'pt-BR':{pageTitle:'Controle Financeiro Aprimorado',appTitle:'Controle Financeiro',menuNewTransaction:'Nova Transa\u00E7\u00E3o',menuTransactions:'Transa\u00E7\u00F5es',menuSearch:'Buscar',menuCharts:'Gr\u00E1fico',menuSummaries:'Resumos',menuGoals:'Metas',menuTrash:'Lixeira',menuBackup:'Backup',menu:'Menu',allTransactions:'Todas as Transa\u00E7\u00F5es',searchTransactions:'Buscar Transa\u00E7\u00F5es',searchByName:'Buscar por nome/descri\u00E7\u00E3o',category:'Categoria',type:'Tipo',monthYear:'M\u00EAs/Ano',allCategories:'Todas as categorias',allTypes:'Todos os tipos',income:'Receita',expense:'Despesa',favoritesOnly:'Apenas favoritas',search:'Buscar',clearFilters:'Limpar Filtros',exportResults:'Exportar Resultados',searchResults:'Resultados da Busca',transactionsFound:'transa\u00E7\u00F5es encontradas',searchIncome:'Receitas na Busca',searchExpense:'Despesas na Busca',searchBalance:'Saldo da Busca',noTransactionsFound:'Nenhuma transa\u00E7\u00E3o encontrada com os filtros aplicados',newTransaction:'Nova Transa\u00E7\u00E3o',date:'Data',value:'Valor (R$)',description:'Descri\u00E7\u00E3o',selectCategory:'Selecione uma categoria',placeholderDesc:'Descreva a transa\u00E7\u00E3o...',favoriteTransaction:'Favoritar esta transa\u00E7\u00E3o',clear:'Limpar',gains:'Ganhos',spending:'Gastos',balance:'Saldo',dailyTransactions:'Transa\u00E7\u00F5es do Dia Selecionado',chartsTitle:'Gr\u00E1ficos de Receitas e Despesas',period:'Per\u00EDodo',month:'M\u00EAs',week:'Semana',year:'Ano',monthSpecific:'M\u00EAs espec\u00EDfico',weekSpecific:'Semana espec\u00EDfica',yearSpecific:'Ano espec\u00EDfico',last3Months:'\u00DAltimos 3 meses',last6Months:'\u00DAltimos 6 meses',view:'Visualizar',incomeExpense:'Receitas e Despesas',expenseOnly:'Apenas Despesas',incomeOnly:'Apenas Receitas',chartType:'Tipo de gr\u00E1fico',pie:'Pizza',bar:'Barras',dailySummary:'Resumo Di\u00E1rio',weeklySummary:'Resumo Semanal',monthlySummary:'Resumo Mensal',yearlySummary:'Resumo Anual',selectDay:'Selecionar Dia',selectWeek:'Selecionar Semana',selectMonth:'Selecionar M\u00EAs',selectYear:'Selecionar Ano',allMonths:'Todos os meses',financialGoals:'Metas Financeiras',newGoal:'Nova Meta',emptyTrash:'Esvaziar lixeira',trashInfo:'Transa\u00E7\u00F5es exclu\u00EDdas podem ser restauradas ou removidas permanentemente.',backupExport:'Backup e Exporta\u00E7\u00E3o',exportJson:'Exportar JSON',importJson:'Importar JSON',exportExcel:'Exportar Excel',clearAll:'Limpar Tudo',editTransaction:'Editar Transa\u00E7\u00E3o',save:'Salvar',cancel:'Cancelar',addGoal:'Nova Meta',goalDescription:'Descri\u00E7\u00E3o da Meta',goalTarget:'Valor da Meta (R$)',goalCurrent:'Valor Atual (R$)',saveGoal:'Salvar Meta',editGoal:'Editar Meta',exportToExcel:'Exportar para Excel',allRecords:'Todos os registros',onlyIncome:'Apenas ganhos',onlyExpense:'Apenas gastos',calculator:'Calculadora',edit:'Editar',delete:'Excluir',deletePermanent:'Excluir permanentemente',moveToTrash:'Mover esta transa\u00E7\u00E3o para a lixeira?',movedToTrash:'Transa\u00E7\u00E3o movida para a lixeira.',deletePermanentConfirm:'Excluir permanentemente? Esta a\u00E7\u00E3o n\u00E3o pode ser desfeita.',trashEmpty:'A lixeira j\u00E1 est\u00E1 vazia.',emptyTrashConfirm:'Excluir permanentemente as',trashEmptyConfirm:'transa\u00E7\u00E3o(\u00F5es) da lixeira? Esta a\u00E7\u00E3o n\u00E3o pode ser desfeita.',trashEmptied:'Lixeira esvaziada.',noTrash:'Nenhuma transa\u00E7\u00E3o na lixeira',fillGoalFields:'Por favor, preencha os campos da meta!',currentNotGreater:'O valor atual n\u00E3o pode ser maior que a meta!',goalAdded:'Meta adicionada!',goalEdited:'Meta editada!',deleteGoalConfirm:'Tem certeza que deseja excluir esta meta?',goalDeleted:'Meta exclu\u00EDda!',noGoals:'Nenhuma meta cadastrada',restore:'Restaurar',saveError:'Erro ao salvar dados!',goalPlaceholder:'Ex: Comprar um carro',noExport:'Nenhuma transa\u00E7\u00E3o para exportar!',fillAllFields:'Por favor, preencha todos os campos!',transactionAdded:'Transa\u00E7\u00E3o adicionada com sucesso!',transactionEdited:'Transa\u00E7\u00E3o editada!',transactionRestored:'Transa\u00E7\u00E3o restaurada!',transactionDeletedPerm:'Transa\u00E7\u00E3o exclu\u00EDda permanentemente.',noTransactionsPeriod:'Nenhuma transa\u00E7\u00E3o para este per\u00EDodo',noTransactionsDay:'Nenhuma transa\u00E7\u00E3o para este dia',noTransactionsFilters:'Nenhuma transa\u00E7\u00E3o encontrada com os filtros!',exportSuccess:'Exportado para Excel com sucesso!',exportError:'Erro ao exportar para Excel!',importConfirm:'Importar este arquivo ir\u00E1 substituir todos os dados atuais. Deseja continuar?',importSuccess:'Dados importados com sucesso!',clearConfirm:'\u26A0\uFE0F ATEN\u00C7\u00C3O: Esta a\u00E7\u00E3o ir\u00E1 apagar TODOS os dados. Deseja continuar?',allDataCleared:'Todos os dados foram apagados!',backupExported:'Backup JSON exportado!',backupExportError:'Erro ao exportar o backup!',loadError:'Erro ao carregar dados!',fillGoalCorrect:'Preencha os campos corretamente!',noTransactionsFoundShort:'Nenhuma transa\u00E7\u00E3o encontrada'},'en':{pageTitle:'Financial Control - Enhanced',appTitle:'Financial Control',menuNewTransaction:'New Transaction',menuTransactions:'Transactions',menuSearch:'Search',menuCharts:'Charts',menuSummaries:'Summaries',menuGoals:'Goals',menuTrash:'Trash',menuBackup:'Backup',menu:'Menu',allTransactions:'All Transactions',searchTransactions:'Search Transactions',searchByName:'Search by name/description',category:'Category',type:'Type',monthYear:'Month/Year',allCategories:'All categories',allTypes:'All types',income:'Income',expense:'Expense',favoritesOnly:'Favorites only',search:'Search',clearFilters:'Clear Filters',exportResults:'Export Results',searchResults:'Search Results',transactionsFound:'transactions found',searchIncome:'Search Income',searchExpense:'Search Expense',searchBalance:'Search Balance',noTransactionsFound:'No transactions found with the applied filters',newTransaction:'New Transaction',date:'Date',value:'Value ($)',description:'Description',selectCategory:'Select a category',placeholderDesc:'Describe the transaction...',favoriteTransaction:'Favorite this transaction',clear:'Clear',gains:'Gains',spending:'Spending',balance:'Balance',dailyTransactions:'Selected Day Transactions',chartsTitle:'Income and Expense Charts',period:'Period',month:'Month',week:'Week',year:'Year',monthSpecific:'Specific month',weekSpecific:'Specific week',yearSpecific:'Specific year',last3Months:'Last 3 months',last6Months:'Last 6 months',view:'View',incomeExpense:'Income and Expenses',expenseOnly:'Expenses only',incomeOnly:'Income only',chartType:'Chart type',pie:'Pie',bar:'Bar',dailySummary:'Daily Summary',weeklySummary:'Weekly Summary',monthlySummary:'Monthly Summary',yearlySummary:'Yearly Summary',selectDay:'Select Day',selectWeek:'Select Week',selectMonth:'Select Month',selectYear:'Select Year',allMonths:'All months',financialGoals:'Financial Goals',newGoal:'New Goal',emptyTrash:'Empty Trash',trashInfo:'Deleted transactions can be restored or permanently removed.',backupExport:'Backup and Export',exportJson:'Export JSON',importJson:'Import JSON',exportExcel:'Export Excel',clearAll:'Clear All',editTransaction:'Edit Transaction',save:'Save',cancel:'Cancel',addGoal:'New Goal',goalDescription:'Goal Description',goalTarget:'Goal Value ($)',goalCurrent:'Current Value ($)',saveGoal:'Save Goal',editGoal:'Edit Goal',exportToExcel:'Export to Excel',allRecords:'All records',onlyIncome:'Income only',onlyExpense:'Expenses only',calculator:'Calculator',edit:'Edit',delete:'Delete',deletePermanent:'Delete permanently',moveToTrash:'Move this transaction to trash?',movedToTrash:'Transaction moved to trash.',deletePermanentConfirm:'Delete permanently? This action cannot be undone.',trashEmpty:'Trash is already empty.',emptyTrashConfirm:'Permanently delete the',trashEmptyConfirm:'transaction(s) from trash? This action cannot be undone.',trashEmptied:'Trash emptied.',noTrash:'No transactions in trash',fillGoalFields:'Please fill in the goal fields!',currentNotGreater:'Current value cannot be greater than the goal!',goalAdded:'Goal added!',goalEdited:'Goal edited!',deleteGoalConfirm:'Are you sure you want to delete this goal?',goalDeleted:'Goal deleted!',noGoals:'No goals registered',restore:'Restore',saveError:'Error saving data!',goalPlaceholder:'E.g.: Buy a car',noExport:'No transactions to export!',fillAllFields:'Please fill in all fields!',transactionAdded:'Transaction added successfully!',transactionEdited:'Transaction edited!',transactionRestored:'Transaction restored!',transactionDeletedPerm:'Transaction permanently deleted.',noTransactionsPeriod:'No transactions for this period',noTransactionsDay:'No transactions for this day',noTransactionsFilters:'No transactions found with the filters!',exportSuccess:'Exported to Excel successfully!',exportError:'Error exporting to Excel!',importConfirm:'Importing this file will replace all current data. Continue?',importSuccess:'Data imported successfully!',clearConfirm:'\u26A0\uFE0F WARNING: This will delete ALL data. Continue?',allDataCleared:'All data has been cleared!',backupExported:'JSON backup exported!',backupExportError:'Error exporting backup!',loadError:'Error loading data!',fillGoalCorrect:'Fill in the fields correctly!',noTransactionsFoundShort:'No transactions found'}};

        let currentLang=localStorage.getItem('lang')||'pt-BR';
        function setLanguage(lang){currentLang=lang;localStorage.setItem('lang',lang);document.getElementById('langPt').classList.toggle('active',lang==='pt-BR');document.getElementById('langEn').classList.toggle('active',lang==='en');applyTranslations(lang);updateClock();}
        function t(key){const lang=currentLang||localStorage.getItem('lang')||'pt-BR';return(i18n[lang]&&i18n[lang][key])?i18n[lang][key]:key;}
        function applyTranslations(lang){document.querySelectorAll('[data-i18n]').forEach(el=>{const key=el.getAttribute('data-i18n');if(i18n[lang]&&i18n[lang][key])el.textContent=i18n[lang][key];});document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{const key=el.getAttribute('data-i18n-placeholder');if(i18n[lang]&&i18n[lang][key])el.placeholder=i18n[lang][key];});document.querySelectorAll('[data-i18n-title]').forEach(el=>{const key=el.getAttribute('data-i18n-title');if(i18n[lang]&&i18n[lang][key])el.title=i18n[lang][key];});document.querySelectorAll('option[data-i18n]').forEach(el=>{const key=el.getAttribute('data-i18n');if(i18n[lang]&&i18n[lang][key])el.textContent=i18n[lang][key];});document.querySelectorAll('select#searchCategory option[value],select#transactionCategory option[value],select#editTransactionCategory option[value],select#exportCategory option[value]').forEach(opt=>{if(opt.value&&categoryOrder.includes(opt.value))opt.textContent=getCategoryLabel(opt.value);});document.title=i18n[lang]&&i18n[lang].pageTitle?i18n[lang].pageTitle:'Controle Financeiro';populateYearSelect();updateMonthPickerButtonText();updateAllViews();updateTrashList();performSearch();}

        let clockIntervalId=null;
        function startClock(){updateClock();if(clockIntervalId)clearInterval(clockIntervalId);clockIntervalId=setInterval(updateClock,1000);}
        document.addEventListener('DOMContentLoaded',function(){startClock();setTimeout(function(){var s=document.getElementById('splashScreen');if(s)s.classList.add('hidden');updateClock();},1500);loadData();setCurrentDates();populateYearSelect();initializeMonthPicker();updateAllViews();updateTrashList();performSearch();var savedLang=localStorage.getItem('lang')||'pt-BR';setLanguage(savedLang);startClock();setTimeout(updateClock,200);setTimeout(updateClock,1000);});
        window.addEventListener('load',updateClock);
        document.addEventListener('visibilitychange',function(){if(document.visibilityState==='visible'){updateClock();startClock();}});

        function toggleTheme(){const b=document.body;const tt=document.querySelector('.theme-toggle');if(b.classList.contains('dark')){b.classList.remove('dark');b.classList.add('light');tt.textContent='\u2600\uFE0F';localStorage.setItem('theme','light');}else{b.classList.remove('light');b.classList.add('dark');tt.textContent='\u{1F319}';localStorage.setItem('theme','dark');}}
        function updateClock(){var te=document.getElementById('clockTime');var de=document.getElementById('clockDate');if(!te||!de)return;var n=new Date();var lang=(typeof currentLang!=='undefined'?currentLang:null)||localStorage.getItem('lang')||'pt-BR';var h=n.getHours();var m=n.getMinutes();var s=n.getSeconds();var d=n.getDate();var mo=n.getMonth()+1;var y=n.getFullYear();var mS=m<10?'0'+m:''+m;var sS=s<10?'0'+s:''+s;var dS=d<10?'0'+d:''+d;var moS=mo<10?'0'+mo:''+mo;if(lang==='en'){var ap=h>=12?'PM':'AM';var h12=h%12||12;te.textContent=h12+':'+mS+':'+sS+' '+ap;de.textContent=moS+'/'+dS+'/'+y;}else{var hS=h<10?'0'+h:''+h;te.textContent=hS+':'+mS+':'+sS;de.textContent=dS+'/'+moS+'/'+y;}}
        function applyTheme(){const st=localStorage.getItem('theme')||'dark';const b=document.body;const tt=document.querySelector('.theme-toggle');if(st==='light'){b.classList.remove('dark');b.classList.add('light');tt.textContent='\u2600\uFE0F';}else{b.classList.remove('light');b.classList.add('dark');tt.textContent='\u{1F319}';}}

        function toggleMenu(){document.getElementById('menuOverlay').classList.add('active');document.getElementById('sideMenu').classList.add('active');}
        function closeMenu(){document.getElementById('menuOverlay').classList.remove('active');document.getElementById('sideMenu').classList.remove('active');}

        function showTab(tabName,el){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));document.getElementById(tabName).classList.add('active');if(el)el.classList.add('active');closeMenu();if(tabName==='new-transaction')updateDailyTransactions();else if(tabName==='search'){populateYearSelect();updateMonthPickerButtonText();performSearch();}else if(tabName==='trash'){updateTrashList();setTimeout(updateTrashList,50);}else if(tabName==='charts')toggleChartPeriodInputs();}

        function performSearch(){const sD=document.getElementById('searchDescription').value.toLowerCase();const sC=document.getElementById('searchCategory').value;const sT=document.getElementById('searchType').value;const sY=document.getElementById('searchYear')?document.getElementById('searchYear').value:'';const sF=document.getElementById('searchFavorites').checked;const sMA=Array.from(selectedMonths).map(k=>k.split('-')[1]);let f=getActiveTransactions().filter(tx=>{if(sD&&!tx.description.toLowerCase().includes(sD))return false;if(sC&&tx.category!==sC)return false;if(sT&&tx.type!==sT)return false;if(sMA.length>0||sY){const tY=tx.date.substring(0,4);const tM=tx.date.substring(5,7);if(sY&&tY!==sY)return false;if(sMA.length>0&&!sMA.includes(tM))return false;}if(sF&&!tx.favorite)return false;return true;});f.sort((a,b)=>new Date(b.date)-new Date(a.date));lastSearchResults=f;updateSearchResults(f);}

        function updateSearchResults(f){const l=document.getElementById('searchResultsList');const c=document.getElementById('searchResultCount');const tc=document.getElementById('searchTotalsCard');c.textContent=`${f.length} ${t('transactionsFound')}`;if(f.length===0){l.innerHTML='<div class="empty-state">'+t('noTransactionsFound')+'</div>';tc.style.display='none';return;}const inc=f.filter(x=>x.type==='income').reduce((s,x)=>s+x.value,0);const exp=f.filter(x=>x.type==='expense').reduce((s,x)=>s+x.value,0);const bal=inc-exp;document.getElementById('searchTotalIncome').textContent=formatCurrency(inc);document.getElementById('searchTotalExpense').textContent=formatCurrency(exp);document.getElementById('searchTotalBalance').textContent=formatCurrency(bal);tc.style.display='block';const bd={};f.forEach(x=>{if(!bd[x.date])bd[x.date]=[];bd[x.date].push(x);});const ds=Object.keys(bd).sort((a,b)=>b.localeCompare(a));l.innerHTML='<div class="search-results-grouped">'+ds.map(d=>`<div class="search-results-date-group"><div class="search-results-date-header">${formatDateForDisplay(d)}</div><div class="search-results-date-list">${bd[d].map(x=>renderSearchResultCard(x)).join('')}</div></div>`).join('')+'</div>';}

        function renderSearchResultCard(tx){const fc=tx.favorite?' favorite-star favorited':' favorite-star';const fi=tx.favorite?'\u2B50':'\u2606';return `<div class="search-result-card"><button class="${fc}" onclick="toggleFavorite(${tx.id});performSearch();" title="${tx.favorite?'Desfavoritar':'Favoritar'}">${fi}</button><div class="transaction-info"><div class="transaction-description">${escapeHtml(tx.description)}</div><div class="transaction-meta">${getCategoryLabel(tx.category)} \u2022 ${tx.type==='income'?t('income'):t('expense')}</div></div><div class="transaction-amount ${tx.type}">${tx.type==='income'?'+':'-'}${formatCurrency(tx.value)}</div><div class="transaction-actions"><button class="action-btn edit" onclick="editTransaction(${tx.id})" title="${t('edit')}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button class="action-btn delete" onclick="deleteTransaction(${tx.id})" title="${t('delete')}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/></svg></button></div></div>`;}

        function toggleFavorite(id){const x=transactions.find(t=>t.id===id);if(x){x.favorite=!x.favorite;saveData();}}
        function clearSearch(){document.getElementById('searchDescription').value='';document.getElementById('searchCategory').value='';document.getElementById('searchType').value='';clearMonthSelection();document.getElementById('searchYear').value='';document.getElementById('searchFavorites').checked=false;performSearch();}
        function exportSearchResultsToExcel(){if(lastSearchResults.length===0){showNotification(t('noExport'),'warning');return;}exportToExcel(lastSearchResults,`busca-financeira-${getTodayInBrasiliaISO()}`);}

        function getTodayInBrasiliaISO(){const n=new Date();const b=new Date(n.getTime()-3*60*60*1000);return b.toISOString().split('T')[0];}
        function getWeekRangeFromDate(inputDate){const d=new Date(inputDate+'T00:00:00Z');const dow=d.getUTCDay();const dowISO=dow===0?7:dow;const s=new Date(d);s.setUTCDate(d.getUTCDate()-dowISO+1);const e=new Date(s);e.setUTCDate(s.getUTCDate()+6);return{start:s.toISOString().split('T')[0],end:e.toISOString().split('T')[0]};}

        let monthPickerCurrentYear=new Date().getFullYear();let selectedMonths=new Set();
        function initializeMonthPicker(){monthPickerCurrentYear=new Date().getFullYear();selectedMonths.clear();updateMonthPickerButtonText();}
        function getMonthNames(){const m={'pt-BR':['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],'en':['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']};return m[currentLang||'pt-BR']||m['pt-BR'];}
        function renderMonthPicker(){const g=document.getElementById('monthPickerGrid');const go=document.getElementById('monthPickerGridOtherYear');const ye=document.getElementById('monthPickerYear');if(!g||!go||!ye)return;ye.textContent=monthPickerCurrentYear;const mn=getMonthNames();const oy=monthPickerCurrentYear+1;g.innerHTML='';go.innerHTML='';mn.forEach((name,i)=>{const mN=String(i+1).padStart(2,'0');const mK=`${monthPickerCurrentYear}-${mN}`;const iS=selectedMonths.has(mK);const btn=document.createElement('button');btn.type='button';btn.className=`month-picker-item ${iS?'selected':''}`;btn.textContent=name;btn.onclick=()=>toggleMonthSelection(monthPickerCurrentYear,mN);g.appendChild(btn);});mn.slice(0,4).forEach((name,i)=>{const mN=String(i+1).padStart(2,'0');const mK=`${oy}-${mN}`;const iS=selectedMonths.has(mK);const btn=document.createElement('button');btn.type='button';btn.className=`month-picker-item other-year ${iS?'selected':''}`;btn.textContent=name;btn.onclick=()=>toggleMonthSelection(oy,mN);go.appendChild(btn);});updateSelectedMonthsInput();updateMonthPickerButtonText();}
        function toggleMonthSelection(y,mN){const mK=`${y}-${mN}`;if(selectedMonths.has(mK))selectedMonths.delete(mK);else selectedMonths.add(mK);renderMonthPicker();updateMonthPickerButtonText();performSearch();}
        function changeMonthPickerYear(d){monthPickerCurrentYear+=d;renderMonthPicker();}
        function updateSelectedMonthsInput(){const inp=document.getElementById('selectedMonths');if(inp){const mv=Array.from(selectedMonths).map(k=>k.split('-')[1]);inp.value=JSON.stringify(mv);}updateMonthPickerButtonText();}
        function clearMonthSelection(){selectedMonths.clear();renderMonthPicker();updateMonthPickerButtonText();}
        function updateMonthPickerButtonText(){const btn=document.getElementById('monthPickerButtonText');if(!btn)return;if(selectedMonths.size===0){btn.textContent=currentLang==='en'?'Select Month':'Selecionar M\u00EAs';}else{const mn=getMonthNames();const sv=Array.from(selectedMonths).map(k=>{const p=k.split('-');return mn[parseInt(p[1])-1];});if(sv.length<=3)btn.textContent=sv.join(', ');else btn.textContent=`${sv.length} ${currentLang==='en'?'months selected':'meses selecionados'}`;}}
        function showMonthPickerModal(){renderMonthPicker();showModal('monthPickerModal');}
        function closeMonthPickerModal(){closeModal('monthPickerModal');}

        function populateYearSelect(){const ys=document.getElementById('searchYear');if(!ys)return;const years=new Set();transactions.forEach(t=>{if(t.date&&t.date.length>=4)years.add(t.date.substring(0,4));});const cy=new Date().getFullYear();for(let y=2020;y<=cy+1;y++)years.add(String(y));const sy=Array.from(years).sort((a,b)=>parseInt(b)-parseInt(a));const cv=ys.value;ys.innerHTML='<option value="">'+(currentLang==='en'?'All years':'Todos os anos')+'</option>';sy.forEach(y=>{const o=document.createElement('option');o.value=y;o.textContent=y;ys.appendChild(o);});if(cv&&ys.querySelector(`option[value="${cv}"]`))ys.value=cv;}

        function setCurrentDates(){const ti=getTodayInBrasiliaISO();const td=new Date(ti+'T00:00:00Z');const y=td.getUTCFullYear();const m=String(td.getUTCMonth()+1).padStart(2,'0');document.getElementById('transactionDate').value=ti;document.getElementById('dailySummaryDate').value=ti;document.getElementById('monthlySummaryDate').value=`${y}-${m}`;document.getElementById('yearlySummaryDate').value=y;const wi=document.getElementById('weeklySummaryDate');const d=new Date(ti);d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));const ys=new Date(Date.UTC(d.getUTCFullYear(),0,1));const wn=Math.ceil((((d-ys)/86400000)+1)/7);wi.value=`${y}-W${String(wn).padStart(2,'0')}`;}

        function addTransaction(type){const d=document.getElementById('transactionDate').value;const v=parseFloat(document.getElementById('transactionValue').value);const c=document.getElementById('transactionCategory').value;const desc=document.getElementById('transactionDescription').value.trim();const f=document.getElementById('transactionFavorite').checked;if(!d||!v||v<=0||!c||!desc){showNotification(t('fillAllFields'),'error');return;}const tx={id:Date.now(),type:type,date:d,value:v,category:c,description:desc,favorite:!!f,createdAt:new Date().toISOString()};transactions.push(tx);saveData();clearTransactionForm();updateAllViews();performSearch();showNotification(t('transactionAdded'),'success');}
        function clearTransactionForm(){document.getElementById('transactionValue').value='';document.getElementById('transactionCategory').value='';document.getElementById('transactionDescription').value='';document.getElementById('transactionDate').value=getTodayInBrasiliaISO();}
        function editTransaction(id){const tx=transactions.find(t=>t.id===id);if(!tx)return;editingTransactionId=id;document.getElementById('editTransactionDate').value=tx.date;document.getElementById('editTransactionValue').value=tx.value;document.getElementById('editTransactionCategory').value=tx.category;document.getElementById('editTransactionDescription').value=tx.description;document.getElementById('editTransactionFavorite').checked=!!tx.favorite;showModal('editTransactionModal');}
        function saveTransactionEdit(){const d=document.getElementById('editTransactionDate').value;const v=parseFloat(document.getElementById('editTransactionValue').value);const c=document.getElementById('editTransactionCategory').value;const desc=document.getElementById('editTransactionDescription').value.trim();const f=document.getElementById('editTransactionFavorite').checked;if(!d||!v||v<=0||!c||!desc){showNotification(t('fillAllFields'),'error');return;}const i=transactions.findIndex(t=>t.id===editingTransactionId);if(i!==-1){transactions[i].date=d;transactions[i].value=v;transactions[i].category=c;transactions[i].favorite=!!f;transactions[i].description=desc;saveData();updateAllViews();performSearch();closeModal('editTransactionModal');showNotification(t('transactionEdited'),'success');}}
        function deleteTransaction(id){if(confirm(t('moveToTrash'))){var tx=transactions.find(function(t){return t.id===id;});if(tx){tx.deleted=true;tx.deletedAt=new Date().toISOString();var ta=getTrashFromStorage();var cp={id:tx.id,type:tx.type,date:tx.date,value:tx.value,category:tx.category,description:tx.description,deleted:true,deletedAt:tx.deletedAt};var ex=ta.some(function(t){return t.id==id;});if(!ex){ta.push(cp);saveTrashToStorage(ta);}saveData();updateAllViews();updateTrashList();performSearch();showNotification(t('movedToTrash'),'success');}}}
        function restoreTransaction(id){var tx=transactions.find(function(x){return x.id===id;});var ta=getTrashFromStorage();var it=ta.find(function(x){return x.id==id;});if(!it)return;if(tx){tx.deleted=false;tx.deletedAt=null;}else{it.deleted=false;it.deletedAt=null;transactions.push(it);}saveTrashToStorage(ta.filter(function(x){return x.id!=id;}));saveData();updateAllViews();updateTrashList();performSearch();showNotification(t('transactionRestored'),'success');}
        function deletePermanently(id){if(confirm(t('deletePermanentConfirm'))){transactions=transactions.filter(function(t){return t.id!==id;});var ta=getTrashFromStorage().filter(function(t){return t.id!=id;});saveTrashToStorage(ta);saveData();updateAllViews();updateTrashList();performSearch();showNotification(t('transactionDeletedPerm'),'warning');}}
        function emptyTrash(){const tc=getTrashTransactions().length;if(tc===0){showNotification(t('trashEmpty'),'info');return;}if(confirm(t('emptyTrashConfirm')+' '+tc+' '+t('trashEmptyConfirm'))){transactions=getActiveTransactions();saveTrashToStorage([]);saveData();updateAllViews();updateTrashList();performSearch();showNotification(t('trashEmptied'),'warning');}}
        function updateTrashList(){var l=document.getElementById('trashList');var eb=document.getElementById('emptyTrashBtn');if(!l)return;var tr=getTrashTransactions();var s=tr.slice().sort(function(a,b){return new Date(b.deletedAt||0)-new Date(a.deletedAt||0);});if(eb)eb.style.display=s.length>0?'':'none';if(s.length===0){l.innerHTML='<div class="empty-state">'+t('noTrash')+'</div>';return;}l.innerHTML=s.map(function(tx){var dd=tx.deletedAt?formatDateForDisplay(String(tx.deletedAt).split('T')[0]):'';return '<div class="transaction-item">'+'<div class="transaction-info">'+'<div class="transaction-description">'+escapeHtml(tx.description||'')+'</div>'+'<div class="transaction-meta">'+getCategoryLabel(tx.category)+' \u2022 '+formatDateForDisplay(tx.date)+(dd?' \u2022 '+(currentLang==='en'?'Deleted on ':'Exclu\u00EDda em ')+dd:'')+'</div>'+'</div>'+'<div class="transaction-amount '+(tx.type||'expense')+'">'+(tx.type==='income'?'+':'-')+formatCurrency(tx.value)+'</div>'+'<div class="transaction-actions">'+'<button type="button" class="action-btn edit" onclick="restoreTransaction('+tx.id+')" title="'+t('restore')+'">\u21BA</button>'+'<button type="button" class="action-btn delete" onclick="deletePermanently('+tx.id+')" title="'+t('deletePermanent')+'">&times;</button>'+'</div></div>';}).join('');}

        function showAddGoalModal(){showModal('addGoalModal');}
        function addGoal(){const d=document.getElementById('goalDescription').value.trim();const tg=parseFloat(document.getElementById('goalTarget').value);const c=parseFloat(document.getElementById('goalCurrent').value)||0;if(!d||!tg||tg<=0){showNotification(t('fillGoalFields'),'error');return;}if(c>tg){showNotification(t('currentNotGreater'),'error');return;}const g={id:Date.now(),description:d,target:tg,current:c,order:goals.length,createdAt:new Date().toISOString()};goals.push(g);saveData();updateGoalsList();closeModal('addGoalModal');document.getElementById('addGoalForm').reset();showNotification(t('goalAdded'),'success');}
        function editGoal(id){const g=goals.find(g=>g.id===id);if(!g)return;editingGoalId=id;document.getElementById('editGoalDescription').value=g.description;document.getElementById('editGoalTarget').value=g.target;document.getElementById('editGoalCurrent').value=g.current;showModal('editGoalModal');}
        function saveGoalEdit(){const d=document.getElementById('editGoalDescription').value.trim();const tg=parseFloat(document.getElementById('editGoalTarget').value);const c=parseFloat(document.getElementById('editGoalCurrent').value)||0;if(!d||!tg||tg<=0){showNotification(t('fillGoalCorrect'),'error');return;}if(c>tg){showNotification(t('currentNotGreater'),'error');return;}const i=goals.findIndex(g=>g.id===editingGoalId);if(i!==-1){goals[i].description=d;goals[i].target=tg;goals[i].current=c;saveData();updateGoalsList();closeModal('editGoalModal');showNotification(t('goalEdited'),'success');}}
        function deleteGoal(id){if(confirm(t('deleteGoalConfirm'))){goals=goals.filter(g=>g.id!==id);goals.forEach((g,i)=>{g.order=i;});saveData();updateGoalsList();showNotification(t('goalDeleted'),'success');}}
        function moveGoal(id,dir){const i=goals.findIndex(g=>g.id===id);const ni=i+dir;if(ni<0||ni>=goals.length)return;[goals[i],goals[ni]]=[goals[ni],goals[i]];goals[i].order=i;goals[ni].order=ni;saveData();updateGoalsList();}

        function updateTransactionsList(){const l=document.getElementById('transactionsList');const a=getActiveTransactions();if(a.length===0){l.innerHTML='<div class="empty-state">'+t('noTransactionsFoundShort')+'</div>';return;}const s=[...a].sort((a,b)=>new Date(b.date)-new Date(a.date));l.innerHTML=s.map(tx=>renderTransactionItem(tx)).join('');}
        function updateGoalsList(){const l=document.getElementById('goalsList');if(goals.length===0){l.innerHTML='<div class="empty-state">'+t('noGoals')+'</div>';return;}const s=[...goals].sort((a,b)=>(a.order||0)-(b.order||0));l.innerHTML=s.map((g,i)=>{const p=Math.min((g.current/g.target)*100,100);const r=Math.max(g.target-g.current,0);return `<div class="goal-item"><div class="goal-header"><div class="goal-info"><h3>${escapeHtml(g.description)}</h3><div class="goal-values">${formatCurrency(g.current)} de ${formatCurrency(g.target)}</div></div><div class="goal-actions">${i>0?`<button class="action-btn move-up" onclick="moveGoal(${g.id},-1)" title="Mover para cima">&uarr;</button>`:''} ${i<s.length-1?`<button class="action-btn move-down" onclick="moveGoal(${g.id},1)" title="Mover para baixo">&darr;</button>`:''}<button class="action-btn edit" onclick="editGoal(${g.id})" title="${t('edit')}">&#9998;</button><button class="action-btn delete" onclick="deleteGoal(${g.id})" title="${t('delete')}">&times;</button></div></div><div class="goal-progress"><div class="progress-bar"><div class="progress-fill" style="width:${p}%"></div></div><div class="progress-text"><span>${p.toFixed(1)}% conclu\u00EDdo</span><span>Faltam ${formatCurrency(r)}</span></div></div></div>`;}).join('');}
        function updateDailyTransactions(){const sd=document.getElementById('transactionDate').value;const daily=getActiveTransactions().filter(t=>t.date===sd);updateSummaryStats('daily',daily);const l=document.getElementById('dailyTransactionsList');if(daily.length===0){l.innerHTML='<div class="empty-state">'+t('noTransactionsDay')+'</div>';return;}l.innerHTML=daily.map(tx=>renderTransactionItem(tx)).join('');}

        function toggleSummary(type){const c=document.getElementById(type+'SummaryContent');const ic=c.previousElementSibling.querySelector('.expand-icon');c.classList.toggle('expanded');ic.classList.toggle('expanded');}
        function updateDailySummary(){const d=document.getElementById('dailySummaryDate').value;if(!d)return;const daily=getActiveTransactions().filter(t=>t.date===d);updateSummaryView('dailySummary',daily);}
        function updateWeeklySummary(){const wi=document.getElementById('weeklySummaryDate').value;if(!wi)return;const[yr,wn]=wi.split('-W');if(!yr||!wn||isNaN(parseInt(wn,10)))return;const fy=new Date(Date.UTC(parseInt(yr,10),0,1));const ds=(wn-1)*7;const sd=new Date(fy.getTime()+ds*86400000);const dow=sd.getUTCDay();const diff=sd.getUTCDate()-dow+(dow===0?-6:1);const mon=new Date(sd.setUTCDate(diff));const sun=new Date(mon);sun.setUTCDate(mon.getUTCDate()+6);const ss=mon.toISOString().split('T')[0];const es=sun.toISOString().split('T')[0];const weekly=getActiveTransactions().filter(t=>t.date>=ss&&t.date<=es);updateSummaryView('weeklySummary',weekly);}
        function updateMonthlySummary(){const m=document.getElementById('monthlySummaryDate').value;if(!m)return;const monthly=getActiveTransactions().filter(t=>t.date.startsWith(m));updateSummaryView('monthlySummary',monthly);}
        function updateYearlySummary(){const y=document.getElementById('yearlySummaryDate').value;if(!y)return;const yearly=getActiveTransactions().filter(t=>t.date.startsWith(y));updateSummaryView('yearlySummary',yearly);}
        function updateSummaryView(pfx,list){updateSummaryStats(pfx,list);const l=document.getElementById(pfx+'Transactions');if(list.length===0){l.innerHTML='<div class="empty-state">'+t('noTransactionsPeriod')+'</div>';return;}const s=[...list].sort((a,b)=>new Date(b.date)-new Date(a.date));l.innerHTML=s.map(tx=>renderTransactionItem(tx)).join('');}
        function updateSummaryStats(pfx,list){const inc=list.filter(t=>t.type==='income').reduce((s,t)=>s+t.value,0);const exp=list.filter(t=>t.type==='expense').reduce((s,t)=>s+t.value,0);const bal=inc-exp;document.getElementById(pfx+'Income').textContent=formatCurrency(inc);document.getElementById(pfx+'Expense').textContent=formatCurrency(exp);document.getElementById(pfx+'Balance').textContent=formatCurrency(bal);}

        function showExportExcelModal(){document.getElementById('exportExcelForm').reset();document.getElementById('exportDateGroup').style.display='none';showModal('exportExcelModal');}
        function updateExportDateField(){const p=document.getElementById('exportPeriod').value;const dg=document.getElementById('exportDateGroup');const di=document.getElementById('exportDate');const dl=document.getElementById('exportDateLabel');if(p==='all'){dg.style.display='none';}else{dg.style.display='block';di.type=p==='month'?'month':'number';dl.textContent=p==='month'?t('month'):t('year');if(p==='year'){di.min='2020';di.max='2030';di.value=new Date().getFullYear();}else{const n=new Date();di.value=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;}}}
        function exportFilteredToExcel(){const p=document.getElementById('exportPeriod').value;const cf=document.getElementById('exportCategory').value;const dv=document.getElementById('exportDate').value;let f=[...getActiveTransactions()];if(p==='month'&&dv)f=f.filter(t=>t.date.startsWith(dv));if(p==='year'&&dv)f=f.filter(t=>t.date.startsWith(dv));if(cf==='income')f=f.filter(t=>t.type==='income');else if(cf==='expense')f=f.filter(t=>t.type==='expense');else if(cf!=='all')f=f.filter(t=>t.category===cf);if(f.length===0){showNotification(t('noTransactionsFilters'),'warning');return;}exportToExcel(f,`relatorio-financeiro-${getTodayInBrasiliaISO()}`);closeModal('exportExcelModal');}
        function exportToExcel(data,filename){try{const cD=currentLang==='en'?'Date':'Data';const cT=currentLang==='en'?'Type':'Tipo';const cV=currentLang==='en'?'Value':'Valor';const cC=currentLang==='en'?'Category':'Categoria';const cDe=currentLang==='en'?'Description':'Descri\u00E7\u00E3o';const td=data.map(tx=>({[cD]:formatDateForDisplay(tx.date),[cT]:tx.type==='income'?t('income'):t('expense'),[cV]:tx.value,[cC]:getCategoryLabel(tx.category),[cDe]:tx.description}));const ti=data.filter(t=>t.type==='income').reduce((s,t)=>s+t.value,0);const te=data.filter(t=>t.type==='expense').reduce((s,t)=>s+t.value,0);const sC=currentLang==='en'?'Summary':'Resumo';const sd=[{[sC]:currentLang==='en'?'Total Income':'Total de Receitas',[cV]:ti},{[sC]:currentLang==='en'?'Total Expenses':'Total de Despesas',[cV]:te},{[sC]:currentLang==='en'?'Balance':'Saldo',[cV]:ti-te}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(td),currentLang==='en'?'Transactions':'Transa\u00E7\u00F5es');XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(sd),currentLang==='en'?'Summary':'Resumo');XLSX.writeFile(wb,`${filename}.xlsx`);showNotification(t('exportSuccess'),'success');}catch(e){console.error('Erro:',e);showNotification(t('exportError'),'error');}}

        function formatCurrency(v){const f=new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);return f.replace(/\u00A0/g,'');}
        function escapeHtml(text){if(text==null||typeof text!=='string')return '';const d=document.createElement('div');d.textContent=text;return d.innerHTML;}
        function formatDateForDisplay(ds){if(!ds||typeof ds!=='string')return '';const p=ds.split('-');if(p.length!==3)return ds;return `${p[2]}/${p[1]}/${p[0]}`;}
        function renderTransactionItem(tx){const fav=tx.favorite?'\u2B50':'\u2606';return `<div class="transaction-item"><div class="transaction-info"><div class="transaction-description">${escapeHtml(tx.description)}</div><div class="transaction-meta">${categories[tx.category]} \u2022 ${formatDateForDisplay(tx.date)}</div></div><div class="transaction-amount ${tx.type}">${tx.type==='income'?'+':'-'}${formatCurrency(tx.value)}</div><div class="transaction-actions"><button class="action-btn favorite-btn" onclick="toggleFavorite(${tx.id});updateAllViews();performSearch();" title="${tx.favorite?'Desfavoritar':'Favoritar'}">${fav}</button><button class="action-btn edit" onclick="editTransaction(${tx.id})" title="${t('edit')}">&#9998;</button><button class="action-btn delete" onclick="deleteTransaction(${tx.id})" title="${t('delete')}">&times;</button></div></div>`;}

        function updateAllViews(){updateTransactionsList();updateGoalsList();updateDailyTransactions();updateDailySummary();updateWeeklySummary();updateMonthlySummary();updateYearlySummary();updateTrashList();if(document.getElementById('search')&&document.getElementById('search').classList.contains('active'))populateYearSelect();}

        function showModal(id){document.getElementById(id).classList.add('active');}
        function closeModal(id){document.getElementById(id).classList.remove('active');}
        function showNotification(msg,type='info'){const n=document.getElementById('notifications');const el=document.createElement('div');el.className=`notification ${type}`;el.textContent=msg;n.appendChild(el);setTimeout(()=>{el.remove();},4000);}

        function saveData(){try{localStorage.setItem('financialTransactions_v2',JSON.stringify(transactions));localStorage.setItem('financialGoals_v2',JSON.stringify(goals));}catch(e){showNotification(t('saveError'),'error');}}
        function loadData(){try{const st=localStorage.getItem('financialTransactions_v2');const sg=localStorage.getItem('financialGoals_v2');if(st){transactions=JSON.parse(st);var ta=getTrashFromStorage();var ti={};ta.forEach(function(t){ti[t.id]=true;});transactions.forEach(function(t){var id=t.id;ti[id]=ti[id]||ta.some(function(x){return x.id==id;});t.deleted=(t.deleted===true||t.deleted==='true')||!!ti[id];if(t.favorite===undefined)t.favorite=false;if(t.category==='compras')t.category='mercado';if(t.deleted&&!ti[id]){ti[id]=true;ta.push({id:t.id,type:t.type,date:t.date,value:t.value,category:t.category,description:t.description,deleted:true,deletedAt:t.deletedAt||new Date().toISOString()});}});saveTrashToStorage(ta);}if(sg){goals=JSON.parse(sg);goals.forEach((g,i)=>{if(g.order===undefined)g.order=i;});}applyTheme();}catch(e){showNotification(t('loadError'),'error');}}
        function exportData(){try{const d={transactions:transactions,goals:goals};const ds=JSON.stringify(d,null,2);const b=new Blob([ds],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`backup-financeiro-${getTodayInBrasiliaISO()}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);showNotification(t('backupExported'),'success');}catch(e){showNotification(t('backupExportError'),'error');}}
        function importData(ev){const f=ev.target.files[0];if(!f)return;const r=new FileReader();r.onload=function(e){try{const d=JSON.parse(e.target.result);if(!d||!Array.isArray(d.transactions))throw new Error('Invalid format');if(confirm(t('importConfirm'))){transactions=d.transactions;goals=Array.isArray(d.goals)?d.goals:[];saveData();updateAllViews();performSearch();showNotification(t('importSuccess'),'success');}}catch(err){showNotification('Erro ao importar: '+err.message,'error');}finally{ev.target.value='';}};r.readAsText(f);}
        function clearAllData(){if(confirm(t('clearConfirm'))){transactions=[];goals=[];saveData();updateAllViews();performSearch();showNotification(t('allDataCleared'),'warning');}}

        function setChartType(type){currentChartType=type;document.querySelectorAll('.chart-type-btn').forEach(btn=>{btn.classList.toggle('active',btn.dataset.type===type);});updateChart();}
        function toggleChartPeriodInputs(){const p=document.getElementById('chartPeriod').value;document.getElementById('chartMonthGroup').style.display=p==='month'?'block':'none';document.getElementById('chartWeekGroup').style.display=p==='week'?'block':'none';document.getElementById('chartYearGroup').style.display=p==='year'?'block':'none';initChartPeriodInputs();updateChart();}
        function initChartPeriodInputs(){const n=new Date();const y=n.getFullYear();const m=String(n.getMonth()+1).padStart(2,'0');const mi=document.getElementById('chartMonth');const wi=document.getElementById('chartWeek');const yi=document.getElementById('chartYear');if(mi&&!mi.value)mi.value=`${y}-${m}`;if(yi&&!yi.value)yi.value=y;if(wi&&!wi.value){const d=new Date(n);d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));const yw=d.getUTCFullYear();const wn=Math.ceil((((d-new Date(Date.UTC(yw,0,1)))/86400000)+1)/7);wi.value=`${yw}-W${String(wn).padStart(2,'0')}`;}}
        function getChartData(){const p=document.getElementById('chartPeriod').value;const tf=document.getElementById('chartTypeFilter').value;const n=new Date();let ss,es;if(p==='month'){const v=document.getElementById('chartMonth').value;if(!v)return[];ss=v+'-01';const[y,m]=v.split('-');const ld=new Date(parseInt(y),parseInt(m),0).getDate();es=`${v}-${String(ld).padStart(2,'0')}`;}else if(p==='week'){const wv=document.getElementById('chartWeek').value;if(!wv)return[];const[yr,wn]=wv.split('-W');if(!yr||!wn)return[];const fy=new Date(Date.UTC(parseInt(yr,10),0,1));const ds=(parseInt(wn,10)-1)*7;const sd=new Date(fy.getTime()+ds*86400000);const dow=sd.getUTCDay();const diff=sd.getUTCDate()-dow+(dow===0?-6:1);const mon=new Date(sd);mon.setUTCDate(diff);const sun=new Date(mon);sun.setUTCDate(mon.getUTCDate()+6);ss=mon.toISOString().split('T')[0];es=sun.toISOString().split('T')[0];}else if(p==='year'){const y=document.getElementById('chartYear').value;if(!y)return[];ss=`${y}-01-01`;es=`${y}-12-31`;}else if(p==='last3'){const d=new Date(n);d.setMonth(d.getMonth()-3);ss=d.toISOString().split('T')[0];es=n.toISOString().split('T')[0];}else if(p==='last6'){const d=new Date(n);d.setMonth(d.getMonth()-6);ss=d.toISOString().split('T')[0];es=n.toISOString().split('T')[0];}else{ss=`${n.getFullYear()}-01-01`;es=n.toISOString().split('T')[0];}let list=getActiveTransactions().filter(tx=>tx.date>=ss&&tx.date<=es);if(tf==='income')list=list.filter(tx=>tx.type==='income');else if(tf==='expense')list=list.filter(tx=>tx.type==='expense');const bc={};list.forEach(tx=>{if(!bc[tx.category])bc[tx.category]=0;bc[tx.category]+=tx.value;});if(tf==='both'){const ti=list.filter(tx=>tx.type==='income').reduce((s,tx)=>s+tx.value,0);const te=list.filter(tx=>tx.type==='expense').reduce((s,tx)=>s+tx.value,0);const r=[];if(ti>0)r.push({label:'\u{1F4B0} '+t('income'),value:ti});if(te>0)r.push({label:'\u{1F4B8} '+t('expense'),value:te});return r;}return Object.entries(bc).map(([cat,val])=>({label:categories[cat]||cat,value:val})).sort((a,b)=>b.value-a.value);}
        function updateChart(){const cv=document.getElementById('financeChart');if(!cv)return;const data=getChartData();if(data.length===0){if(financeChartInstance){financeChartInstance.destroy();financeChartInstance=null;}return;}const isDark=document.body.classList.contains('dark');const tc=isDark?'#f1f5f9':'#1e293b';const gc=isDark?'rgba(255,255,255,0.06)':'rgba(0,0,0,0.06)';if(financeChartInstance)financeChartInstance.destroy();const cd={labels:data.map(d=>d.label),datasets:[{data:data.map(d=>d.value),backgroundColor:['#0D9488','#14B8A6','#059669','#F59E0B','#DC2626','#8B5CF6','#EC4899','#06B6D4','#F97316','#6366F1'],borderColor:isDark?'rgba(255,255,255,0.1)':'rgba(255,255,255,0.8)',borderWidth:2}]};const cfg={type:currentChartType,data:cd,options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom',labels:{color:tc,font:{size:11,family:'Inter'}}}},scales:currentChartType==='bar'?{y:{beginAtZero:true,grid:{color:gc},ticks:{color:tc}},x:{grid:{color:gc},ticks:{color:tc,maxRotation:45}}}:{}}};financeChartInstance=new Chart(cv,cfg);}

        function toggleCalculator(){const o=document.getElementById('calcOverlay');o.classList.toggle('active');if(o.classList.contains('active'))calcClear();}
        let calcDisplayStr='0';let calcPrev=null;let calcOp=null;const CALC_MAX_DIGITS=10;
        function countDigits(s){return(s.match(/\d/g)||[]).length;}
        function calcUpdateDisplay(){document.getElementById('calcDisplay').value=calcDisplayStr;}
        function calcInput(key){const symMap={'+':'+','-':'\u2212','*':'\u00D7','/':'/'};const opRegex=/([+\-\u2212\u00D7/])/;if(key==='\u00B1'){if(calcOp){const p=calcDisplayStr.split(opRegex).filter(Boolean);if(p[2]){p[2]=String(-parseFloat(p[2]));calcDisplayStr=p.join('');}}else{calcDisplayStr=String(-parseFloat(calcDisplayStr));}}else if(key==='%'){if(calcOp){const p=calcDisplayStr.split(opRegex);const l=p[p.length-1];if(l&&l!=='-'&&l!=='+'){p[p.length-1]=String(parseFloat(l)/100);calcDisplayStr=p.join('');}}else{calcDisplayStr=String(parseFloat(calcDisplayStr)/100);}}else if(key==='.'){const p=calcDisplayStr.split(opRegex);const ln=p[p.length-1]||'';if(!ln.includes('.')&&countDigits(calcDisplayStr)<CALC_MAX_DIGITS){if(ln===''||ln==='0')p[p.length-1]='0.';else p[p.length-1]=ln+'.';calcDisplayStr=p.join('');}}else if('0123456789'.includes(key)){const p=calcDisplayStr.split(opRegex);const lp=p[p.length-1]||'0';const dl=(lp.match(/\d/g)||[]).length;if(dl>=CALC_MAX_DIGITS&&!lp.includes('.'))return;if(lp==='0'&&key!=='0'&&!lp.includes('.'))p[p.length-1]=key;else p[p.length-1]=lp+key;calcDisplayStr=p.join('');}else if('+-*/'.includes(key)){const sym=symMap[key];if(calcOp&&calcPrev!==null){const p=calcDisplayStr.split(opRegex);const l=p[p.length-1];if(l&&l!=='-'&&l!=='+'&&!isNaN(parseFloat(l))){calcEquals();calcDisplayStr=calcDisplayStr+sym;calcPrev=parseFloat(calcDisplayStr);calcOp=key;}else{calcPrev=parseFloat(calcDisplayStr.replace(/([+\-\u2212\u00D7/])$/,'').trim()||0);calcOp=key;calcDisplayStr=(calcDisplayStr.replace(/([+\-\u2212\u00D7/])$/,'').trim()||'0')+sym;}}else{calcPrev=parseFloat(calcDisplayStr.replace(/([+\-\u2212\u00D7/])$/,'').trim()||0);calcOp=key;calcDisplayStr=(calcDisplayStr.replace(/([+\-\u2212\u00D7/])$/,'').trim()||'0')+sym;}}calcUpdateDisplay();}
        function calcClear(){calcDisplayStr='0';calcPrev=null;calcOp=null;calcUpdateDisplay();}
        function calcEquals(){var de=document.getElementById('calcDisplay');var s=(de&&de.value)?de.value:calcDisplayStr;if(!s||s==='')return;var nm=String(s).replace(/\u00D7/g,'*').replace(/\u2212/g,'-').trim();var p=nm.split(/([+\-*/])/);if(p.length<3)return;var a=parseFloat(p[0]);var op=p[1];var b=parseFloat(p[2]);if(isNaN(a))return;if(isNaN(b))b=0;var r;if(op==='+')r=a+b;else if(op==='-')r=a-b;else if(op==='*')r=a*b;else if(op==='/')r=b===0?0:a/b;else return;r=Math.round(r*1e10)/1e10;calcDisplayStr=String(r).length>CALC_MAX_DIGITS?String(Number(r).toExponential(6)):String(r);calcPrev=null;calcOp=null;calcUpdateDisplay();}

        document.getElementById('transactionDate').addEventListener('change',updateDailyTransactions);
        document.addEventListener('click',e=>{if(e.target.classList.contains('modal-overlay')){const mid=e.target.id;if(mid==='monthPickerModal')closeMonthPickerModal();else closeModal(mid);}});
        function previousDay(){const di=document.getElementById('transactionDate');const cd=new Date(di.value+'T00:00:00Z');cd.setUTCDate(cd.getUTCDate()-1);di.value=cd.toISOString().split('T')[0];updateDailyTransactions();}
        function nextDay(){const di=document.getElementById('transactionDate');const cd=new Date(di.value+'T00:00:00Z');cd.setUTCDate(cd.getUTCDate()+1);di.value=cd.toISOString().split('T')[0];updateDailyTransactions();}
    </script>
</body>
</html>
